<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - Medical Claims - Packaging Glamour HR</title>
    <link rel="shortcut icon" href="assets/images/favicon.ico" />

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Tailwind CSS -->
    <!-- Tailwind CSS (Local) -->
    <link rel="stylesheet" href="assets/css/tailwind.css" />

    <!-- Button Styles -->
    <link rel="stylesheet" href="assets/css/button-styles.css?v=4" />

    <!-- Configuration Script -->
    <script src="config-worker.js?v=2"></script>
    <!-- Authentication Script -->
    <script src="auth.js"></script>

    <style>
      * {
        font-family: "Inter", sans-serif;
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- Pending Claims -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-gray-600 text-sm font-medium">Pending Claims</h3>
              <p
                id="pendingCount"
                class="text-3xl font-bold text-yellow-600 mt-1"
              >
                0
              </p>
            </div>
            <div class="bg-yellow-100 p-4 rounded-full">
              <i class="fas fa-clock text-yellow-600 text-2xl"></i>
            </div>
          </div>
        </div>

        <!-- Approved Claims -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-gray-600 text-sm font-medium">Approved Claims</h3>
              <p
                id="approvedCount"
                class="text-3xl font-bold text-green-600 mt-1"
              >
                0
              </p>
            </div>
            <div class="bg-green-100 p-4 rounded-full">
              <i class="fas fa-check-circle text-green-600 text-2xl"></i>
            </div>
          </div>
        </div>

        <!-- Total Amount -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-gray-600 text-sm font-medium">Total Approved</h3>
              <p id="totalAmount" class="text-3xl font-bold text-blue-600 mt-1">
                GH₵0.00
              </p>
            </div>
            <div class="bg-blue-100 p-4 rounded-full">
              <i class="fas fa-money-bill-wave text-blue-600 text-2xl"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Filter Tabs -->
      <div class="bg-white rounded-lg shadow-md mb-8">
        <div class="flex border-b">
          <button
            onclick="filterClaims('all')"
            id="tabAll"
            class="px-6 py-3 font-semibold text-red-600 border-b-2 border-red-600"
          >
            All Claims
          </button>
          <button
            onclick="filterClaims('pending')"
            id="tabPending"
            class="px-6 py-3 font-semibold text-gray-600 hover:text-red-600"
          >
            Pending
          </button>
          <button
            onclick="filterClaims('approved')"
            id="tabApproved"
            class="px-6 py-3 font-semibold text-gray-600 hover:text-red-600"
          >
            Approved
          </button>
          <button
            onclick="filterClaims('rejected')"
            id="tabRejected"
            class="px-6 py-3 font-semibold text-gray-600 hover:text-red-600"
          >
            Rejected
          </button>
        </div>
      </div>

      <!-- Claims Table -->
      <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Employee
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Hospital
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Date
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Amount
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Status
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Actions
                </th>
              </tr>
            </thead>
            <tbody
              id="claimsTableBody"
              class="bg-white divide-y divide-gray-200"
            >
              <!-- Claims will be loaded here -->
              <tr>
                <td colspan="6" class="px-6 py-8 text-center text-gray-400">
                  <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                  <p>Loading claims...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Claim Detail Modal -->
    <div
      id="claimModal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"
      style="backdrop-filter: blur(2px); -webkit-backdrop-filter: blur(2px);"
    >
      <div
        class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-2xl"
      >
        <div class="p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-2xl font-bold text-gray-800">Claim Details</h2>
            <button
              onclick="closeModal()"
              class="text-gray-400 hover:text-gray-600"
            >
              <i class="fas fa-times text-2xl"></i>
            </button>
          </div>

          <div id="modalContent" class="space-y-4">
            <!-- Content will be loaded here -->
          </div>

          <div id="modalActions" class="flex space-x-4 mt-6">
            <!-- Actions will be loaded here -->
          </div>
        </div>
      </div>
    </div>

    <script>
      let allClaims = [];
      let currentFilter = "all";
      let currentEmployee = null;

      // Initialize page
      document.addEventListener("DOMContentLoaded", async function () {
        // Check authentication
        if (!requireAuth()) {
          window.location.href = "packaging-glamour-signin.html";
          return;
        }

        currentEmployee = getCurrentUser();
        if (!currentEmployee) {
          window.location.href = "packaging-glamour-signin.html";
          return;
        }

        // Check if user is admin
        if (currentEmployee.role !== "Admin") {
          showMessage("Access denied. Admin privileges required.", "error");
          setTimeout(() => (window.location.href = "dashboard.html"), 2000);
          return;
        }

        // Load all claims
        await loadAllClaims();
      });

      // Load all claims
      async function loadAllClaims() {
        try {
          const data = await getMedicalClaims();
          allClaims = data.records || [];

          // Update stats
          updateStats();

          // Display claims
          filterClaims(currentFilter);
        } catch (error) {

          showMessage("Failed to load claims", "error");
        }
      }

      // Update statistics
      function updateStats() {
        const pending = allClaims.filter(
          (c) => c.fields.Status === "Pending"
        ).length;
        const approved = allClaims.filter(
          (c) => c.fields.Status === "Approved"
        ).length;
        const totalAmount = allClaims
          .filter((c) => c.fields.Status === "Approved")
          .reduce((sum, c) => sum + (c.fields["Amount Spent (GH₵)"] || 0), 0);

        document.getElementById("pendingCount").textContent = pending;
        document.getElementById("approvedCount").textContent = approved;
        document.getElementById("totalAmount").textContent =
          `GH₵${totalAmount.toFixed(2)}`;
      }

      // Filter claims
      function filterClaims(status) {
        currentFilter = status;

        // Update tab styles
        document.querySelectorAll('[id^="tab"]').forEach((tab) => {
          tab.classList.remove("text-red-600", "border-b-2", "border-red-600");
          tab.classList.add("text-gray-600");
        });
        const activeTab = document.getElementById(
          `tab${status.charAt(0).toUpperCase() + status.slice(1)}`
        );
        activeTab.classList.remove("text-gray-600");
        activeTab.classList.add("text-red-600", "border-b-2", "border-red-600");

        // Filter and display claims
        let filteredClaims = allClaims;
        if (status !== "all") {
          filteredClaims = allClaims.filter(
            (c) => c.fields.Status?.toLowerCase() === status.toLowerCase()
          );
        }

        displayClaims(filteredClaims);
      }

      // Display claims in table
      function displayClaims(claims) {
        const tbody = document.getElementById("claimsTableBody");

        if (claims.length === 0) {
          tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-gray-400">
                            <i class="fas fa-inbox text-3xl mb-2"></i>
                            <p>No claims found</p>
                        </td>
                    </tr>
                `;
          return;
        }

        tbody.innerHTML = claims
          .map((claim) => {
            const fields = claim.fields;
            const statusColors = {
              Pending: "bg-yellow-100 text-yellow-800",
              Approved: "bg-green-100 text-green-800",
              Rejected: "bg-red-100 text-red-800",
            };

            return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="font-medium text-gray-900">${fields["Full Name (from Employee)"] || "N/A"}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">${fields["Hospital/Clinic Name"] || "N/A"}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${fields["Date of visit"] ? new Date(fields["Date of visit"]).toLocaleDateString() : "N/A"}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-sm font-semibold text-gray-900">GH₵${(fields["Amount Spent (GH₵)"] || 0).toFixed(2)}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColors[fields.Status] || "bg-gray-100 text-gray-800"}">
                                ${fields.Status || "Unknown"}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick='viewClaim(${JSON.stringify(claim).replace(/'/g, "&apos;")})' class="text-blue-600 hover:text-blue-900 mr-3">
                                <i class="fas fa-eye mr-1"></i>View
                            </button>
                        </td>
                    </tr>
                `;
          })
          .join("");
      }

      // View claim details
      function viewClaim(claim) {
        const fields = claim.fields;

        // Handle multiple receipts
        const receipts = fields["Upload Receipt/Proof"] || [];

        const receiptsHTML =
          receipts.length > 0
            ? `<div class="col-span-2">
                    <p class="text-sm font-medium text-gray-500 mb-2">Receipts (${receipts.length})</p>
                    <div class="flex flex-wrap gap-2">
                        ${receipts
                          .map(
                            (receipt, idx) => `
                            <a href="${receipt.url}" target="_blank" class="inline-flex items-center px-4 py-2 bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                                <i class="fas fa-file-alt mr-2"></i>Receipt ${idx + 1}
                            </a>
                        `
                          )
                          .join("")}
                    </div>
                </div>`
            : "";

        const modalContent = document.getElementById("modalContent");
        modalContent.innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm font-medium text-gray-500">Employee Name</p>
                        <p class="text-base font-semibold text-gray-900">${fields["Full Name (from Employee)"] || "N/A"}</p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">Hospital/Clinic</p>
                        <p class="text-base text-gray-900">${fields["Hospital/Clinic Name"] || "N/A"}</p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">Visit Date</p>
                        <p class="text-base text-gray-900">${fields["Date of visit"] ? new Date(fields["Date of visit"]).toLocaleDateString() : "N/A"}</p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">Amount</p>
                        <p class="text-base font-semibold text-gray-900">GH₵${(fields["Amount Spent (GH₵)"] || 0).toFixed(2)}</p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">Status</p>
                        <p class="text-base font-semibold ${fields.Status === "Pending" ? "text-yellow-600" : fields.Status === "Approved" ? "text-green-600" : "text-red-600"}">${fields.Status || "Unknown"}</p>
                    </div>
                </div>
                <div class="col-span-2">
                    <p class="text-sm font-medium text-gray-500 mb-2">Description of Treatment</p>
                    <p class="text-base text-gray-900 bg-gray-50 p-3 rounded">${fields["Description of Treatment"] || "No description provided"}</p>
                </div>
                ${receiptsHTML}
            `;

        const modalActions = document.getElementById("modalActions");
        if (fields.Status === "Pending") {
          modalActions.innerHTML = `
                    <button onclick="updateClaimStatus('${claim.id}', 'Approved')" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg transition-colors">
                        <i class="fas fa-check mr-2"></i>Approve
                    </button>
                    <button onclick="updateClaimStatus('${claim.id}', 'Rejected')" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-3 rounded-lg transition-colors">
                        <i class="fas fa-times mr-2"></i>Reject
                    </button>
                `;
        } else {
          modalActions.innerHTML = `
                    <button onclick="closeModal()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 rounded-lg transition-colors">
                        Close
                    </button>
                `;
        }

        document.getElementById("claimModal").classList.remove("hidden");
      }

      // Update claim status
      async function updateClaimStatus(recordId, status) {
        try {
          const updateBtn = event.target;
          updateBtn.disabled = true;
          updateBtn.innerHTML =
            '<i class="fas fa-spinner fa-spin mr-2"></i>Updating...';

          await updateMedicalClaim(recordId, { Status: status });

          showMessage(`Claim ${status.toLowerCase()} successfully!`, "success");

          // Signal dashboard to refresh medical claims count
          localStorage.setItem("medicalClaimsUpdated", Date.now().toString());

          // Reload claims
          await loadAllClaims();

          // Close modal
          closeModal();
        } catch (error) {

          showMessage("Failed to update claim status", "error");
        }
      }

      // Close modal
      function closeModal() {
        document.getElementById("claimModal").classList.add("hidden");
      }

      // Show message
      function showMessage(message, type) {
        const bgColor = type === "success" ? "bg-green-500" : "bg-red-500";
        const div = document.createElement("div");
        div.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
        div.innerHTML = `<i class="fas fa-${type === "success" ? "check" : "exclamation"}-circle mr-2"></i>${message}`;
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 5000);
      }
    </script>
  </body>
</html>
