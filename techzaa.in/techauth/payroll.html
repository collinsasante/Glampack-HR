<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Packaging Glamour HR</title>

    <!-- Tailwind CSS (Local) -->
    <link rel="stylesheet" href="assets/css/tailwind.css" />

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Worker API Configuration -->
    <script src="config-worker.js?v=2"></script>

    <!-- Authentication Script -->
    <script src="auth.js"></script>

    <style>
      body {
        font-family: "Montserrat", sans-serif;
      }
      .salary-card {
        transition: all 0.3s ease;
      }
      .salary-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <!-- Navigation Header -->
    <header class="bg-white shadow-md sticky top-0 z-50">
      <div class="container mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
          <!-- Logo -->
          <div class="flex items-center space-x-3">
            <img src="assets/images/logo_red.png" alt="Logo" class="h-10" />
          </div>

          <!-- Desktop Navigation Menu (hidden on mobile) -->
          <div class="hidden lg:flex items-center space-x-4">
            <a href="dashboard.html" class="text-gray-600 hover:text-red-600">
              <i class="fas fa-chart-line mr-1"></i> Dashboard
            </a>
            <a
              href="attendance-tracker.html"
              class="text-gray-600 hover:text-red-600"
            >
              <i class="fas fa-clock mr-1"></i> Attendance
            </a>
            <a
              href="leave-request.html"
              class="text-gray-600 hover:text-red-600"
            >
              <i class="fas fa-calendar-alt mr-1"></i> Leave
            </a>
            <a
              href="medical-claims.html"
              class="text-gray-600 hover:text-red-600"
            >
              <i class="fas fa-notes-medical mr-1"></i> Medical Claims
            </a>
            <a href="profile.html" class="text-gray-600 hover:text-red-600">
              <i class="fas fa-user mr-1"></i> Profile
            </a>
            <a
              href="announcements.html"
              class="text-gray-600 hover:text-red-600"
            >
              <i class="fas fa-bullhorn mr-1"></i> Announcements
            </a>
            <a href="payroll.html" class="text-red-600 font-semibold">
              <i class="fas fa-money-bill-wave mr-1"></i> Payroll
            </a>
            <a
              href="admin-dashboard.html"
              id="adminLink"
              class="text-gray-600 hover:text-red-600"
              style="display: none"
            >
              <i class="fas fa-user-shield mr-1"></i> Admin
            </a>
            <button onclick="logout()" class="text-gray-600 hover:text-red-600">
              <i class="fas fa-sign-out-alt mr-1"></i> Logout
            </button>
          </div>

          <!-- Mobile Menu Button -->
          <button
            onclick="toggleMobileMenu()"
            class="lg:hidden text-gray-600 hover:text-red-600 focus:outline-none"
          >
            <i class="fas fa-bars text-2xl"></i>
          </button>
        </div>

        <!-- Mobile Navigation Menu (hidden by default) -->
        <div id="mobileMenu" class="hidden lg:hidden mt-4 pb-2 space-y-2">
          <a
            href="dashboard.html"
            class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg"
          >
            <i class="fas fa-chart-line mr-2"></i> Dashboard
          </a>
          <a
            href="attendance-tracker.html"
            class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg"
          >
            <i class="fas fa-clock mr-2"></i> Attendance
          </a>
          <a
            href="leave-request.html"
            class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg"
          >
            <i class="fas fa-calendar-alt mr-2"></i> Leave
          </a>
          <a
            href="medical-claims.html"
            class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg"
          >
            <i class="fas fa-notes-medical mr-2"></i> Medical Claims
          </a>
          <a
            href="profile.html"
            class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg"
          >
            <i class="fas fa-user mr-2"></i> Profile
          </a>
          <a
            href="announcements.html"
            class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg"
          >
            <i class="fas fa-bullhorn mr-2"></i> Announcements
          </a>
          <a
            href="payroll.html"
            class="block px-4 py-3 bg-red-100 text-red-600 font-semibold rounded-lg"
          >
            <i class="fas fa-money-bill-wave mr-2"></i> Payroll
          </a>
          <a
            href="admin-dashboard.html"
            id="adminLinkMobile"
            class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg"
            style="display: none"
          >
            <i class="fas fa-user-shield mr-2"></i> Admin
          </a>
          <button
            onclick="logout()"
            class="w-full text-left px-4 py-3 text-red-600 hover:bg-red-50 rounded-lg"
          >
            <i class="fas fa-sign-out-alt mr-2"></i> Logout
          </button>
        </div>
      </div>
    </header>

    <div class="container mx-auto px-4 py-8">
      <!-- Header Section -->
      <div class="mb-6">
        <h2 class="text-3xl font-bold text-gray-800">Payroll Information</h2>
        <p class="text-gray-600 mt-1">
          View your salary details and payment history
        </p>
      </div>

      <!-- Current Salary Overview -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <!-- Gross Salary Card -->
        <div
          class="salary-card bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow-lg p-6 text-white"
        >
          <div class="flex items-center justify-between mb-4">
            <div>
              <p class="text-green-100 text-sm font-medium">Gross Salary</p>
              <h3 class="text-3xl font-bold" id="grossSalary">GH₵0</h3>
            </div>
            <div class="bg-white bg-opacity-20 rounded-full p-4">
              <i class="fas fa-dollar-sign text-2xl"></i>
            </div>
          </div>
          <div class="text-sm text-green-100">
            <i class="fas fa-info-circle mr-1"></i> Base + Allowances
          </div>
        </div>

        <!-- Deductions Card -->
        <div
          class="salary-card bg-gradient-to-br from-red-500 to-red-600 rounded-lg shadow-lg p-6 text-white"
        >
          <div class="flex items-center justify-between mb-4">
            <div>
              <p class="text-red-100 text-sm font-medium">Total Deductions</p>
              <h3 class="text-3xl font-bold" id="totalDeductions">GH₵0</h3>
            </div>
            <div class="bg-white bg-opacity-20 rounded-full p-4">
              <i class="fas fa-minus-circle text-2xl"></i>
            </div>
          </div>
          <div class="text-sm text-red-100">
            <i class="fas fa-info-circle mr-1"></i> Tax + Benefits
          </div>
        </div>

        <!-- Net Salary Card -->
        <div
          class="salary-card bg-gradient-to-br from-red-500 to-red-600 rounded-lg shadow-lg p-6 text-white"
        >
          <div class="flex items-center justify-between mb-4">
            <div>
              <p class="text-red-100 text-sm font-medium">Net Salary</p>
              <h3 class="text-3xl font-bold" id="netSalary">GH₵0</h3>
            </div>
            <div class="bg-white bg-opacity-20 rounded-full p-4">
              <i class="fas fa-wallet text-2xl"></i>
            </div>
          </div>
          <div class="text-sm text-red-100">
            <i class="fas fa-info-circle mr-1"></i> Take-home amount
          </div>
        </div>
      </div>

      <!-- Salary Breakdown -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Earnings Breakdown -->
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4">
            <i class="fas fa-plus-circle text-green-600 mr-2"></i> Earnings
            Breakdown
          </h3>
          <div class="space-y-3">
            <div
              class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"
            >
              <span class="text-gray-700">Basic Salary</span>
              <span class="font-semibold" id="basicSalary">GH₵0</span>
            </div>
            <div
              class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"
            >
              <span class="text-gray-700">Housing Allowance</span>
              <span class="font-semibold" id="housingAllowance">GH₵0</span>
            </div>
            <div
              class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"
            >
              <span class="text-gray-700">Transport Allowance</span>
              <span class="font-semibold" id="transportAllowance">GH₵0</span>
            </div>
            <div
              class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"
            >
              <span class="text-gray-700">Other Allowances</span>
              <span class="font-semibold" id="otherAllowances">GH₵0</span>
            </div>
          </div>
        </div>

        <!-- Deductions Breakdown -->
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4">
            <i class="fas fa-minus-circle text-red-600 mr-2"></i> Deductions
            Breakdown
          </h3>
          <div class="space-y-3">
            <div
              class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"
            >
              <span class="text-gray-700">Income Tax</span>
              <span class="font-semibold" id="incomeTax">GH₵0</span>
            </div>
            <div
              class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"
            >
              <span class="text-gray-700">Social Security</span>
              <span class="font-semibold" id="socialSecurity">GH₵0</span>
            </div>
            <div
              class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"
            >
              <span class="text-gray-700">Health Insurance</span>
              <span class="font-semibold" id="healthInsurance">GH₵0</span>
            </div>
            <div
              class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"
            >
              <span class="text-gray-700">Other Deductions</span>
              <span class="font-semibold" id="otherDeductions">GH₵0</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Payment History -->
      <div class="bg-white rounded-lg shadow-lg p-6">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-bold text-gray-800">
            <i class="fas fa-history text-red-600 mr-2"></i> Payment History
          </h3>
          <div class="flex space-x-2">
            <select
              id="yearFilter"
              onchange="loadPaymentHistory()"
              class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
            >
              <option value="2025">2025</option>
              <option value="2024">2024</option>
              <option value="2023">2023</option>
            </select>
          </div>
        </div>

        <!-- Payment History Table -->
        <div class="overflow-x-auto">
          <table class="min-w-full">
            <thead class="bg-gray-50">
              <tr>
                <th
                  class="px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Month
                </th>
                <th
                  class="hidden sm:table-cell px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Gross Salary
                </th>
                <th
                  class="hidden lg:table-cell px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Deductions
                </th>
                <th
                  class="px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Net Salary
                </th>
                <th
                  class="hidden md:table-cell px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Status
                </th>
                <th
                  class="px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Actions
                </th>
              </tr>
            </thead>
            <tbody
              id="paymentHistoryBody"
              class="bg-white divide-y divide-gray-200"
            >
              <!-- Loading state -->
              <tr>
                <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                  <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                  <p>Loading payment history...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      // ========================================
      // AUTHENTICATION CHECK
      // ========================================
      if (!requireAuth()) {
        // Will redirect automatically
      }

      const currentUser = getCurrentUser();

      // Show admin link if user is admin
      const adminLink = document.getElementById("adminLink");
      if (currentUser.role === "Admin" && adminLink) {
        adminLink.style.display = "inline-block";
      }

      // ========================================
      // LOAD CURRENT SALARY INFO
      // ========================================
      async function loadSalaryInfo() {
        try {
          // Fetch all payroll records using Worker API
          const data = await getPayroll();

          // Filter for this employee's payroll records (client-side)
          const employeePayrolls = data.records.filter((record) => {
            const employeeField = record.fields["Employee"];
            return (
              employeeField &&
              Array.isArray(employeeField) &&
              employeeField.includes(currentUser.id)
            );
          });

          if (employeePayrolls.length > 0) {
            // Sort by month (descending) to get the latest payroll
            employeePayrolls.sort((a, b) => {
              const monthA = a.fields["Month"] || "";
              const monthB = b.fields["Month"] || "";
              return monthB.localeCompare(monthA);
            });

            const salary = employeePayrolls[0].fields;

            // Update earnings
            const basicSalary = parseFloat(salary["Basic Salary"] || 0);
            const housingAllowance = parseFloat(
              salary["Housing Allowance"] || 0
            );
            const transportAllowance = parseFloat(
              salary["Transport Allowance"] || 0
            );
            const benefits = parseFloat(salary["Benefits"] || 0);
            const otherAllowances = parseFloat(salary["Other Allowances"] || 0);

            // Get calculated totals from Airtable
            const totalAllowances = parseFloat(salary["Total Allowances"] || 0);
            const grossSalary = parseFloat(salary["Gross Salary"] || 0);

            // Update deductions
            const incomeTax = parseFloat(salary["Income Tax"] || 0);
            const welfare = parseFloat(salary["Welfare"] || 0);
            const socialSecurity = parseFloat(salary["Social Security"] || 0);
            const healthInsurance = parseFloat(salary["Health Insurance"] || 0);
            const otherDeductions = parseFloat(salary["Other Deductions"] || 0);

            // Get calculated totals from Airtable (check both 'Net Salary' and 'Net Pay')
            const totalDeductions = parseFloat(salary["Total Deductions"] || 0);
            const netSalary = parseFloat(
              salary["Net Pay"] || salary["Net Salary"] || 0
            );

            // Update UI
            document.getElementById("grossSalary").textContent =
              formatCurrency(grossSalary);
            document.getElementById("totalDeductions").textContent =
              formatCurrency(totalDeductions);
            document.getElementById("netSalary").textContent =
              formatCurrency(netSalary);

            document.getElementById("basicSalary").textContent =
              formatCurrency(basicSalary);
            document.getElementById("housingAllowance").textContent =
              formatCurrency(housingAllowance);
            document.getElementById("transportAllowance").textContent =
              formatCurrency(transportAllowance);
            document.getElementById("otherAllowances").textContent =
              formatCurrency(benefits + otherAllowances);

            document.getElementById("incomeTax").textContent =
              formatCurrency(incomeTax);
            document.getElementById("socialSecurity").textContent =
              formatCurrency(socialSecurity);
            document.getElementById("healthInsurance").textContent =
              formatCurrency(healthInsurance);
            document.getElementById("otherDeductions").textContent =
              formatCurrency(welfare + otherDeductions);
          }
        } catch (error) {

        }
      }

      // ========================================
      // LOAD PAYMENT HISTORY
      // ========================================
      async function loadPaymentHistory() {
        const year = document.getElementById("yearFilter").value;
        const tbody = document.getElementById("paymentHistoryBody");

        tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>Loading payment history...</p>
                    </td>
                </tr>
            `;

        try {
          // Fetch all payroll records using Worker API
          const data = await getPayroll();

          // Filter for this employee's payroll records (client-side)
          let employeePayrolls = data.records.filter((record) => {
            const employeeField = record.fields["Employee"];
            return (
              employeeField &&
              Array.isArray(employeeField) &&
              employeeField.includes(currentUser.id)
            );
          });

          // Filter by year
          employeePayrolls = employeePayrolls.filter((record) => {
            const month = record.fields["Month"] || "";
            return month.startsWith(year);
          });

          // Sort by month (descending)
          employeePayrolls.sort((a, b) => {
            const monthA = a.fields["Month"] || "";
            const monthB = b.fields["Month"] || "";
            return monthB.localeCompare(monthA);
          });

          if (employeePayrolls.length === 0) {
            tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                                <i class="fas fa-inbox text-4xl mb-2"></i>
                                <p>No payment history found for ${year}</p>
                            </td>
                        </tr>
                    `;
            return;
          }

          tbody.innerHTML = employeePayrolls
            .map((record) => {
              const fields = record.fields;
              const monthValue = fields["Month"] || "";

              // Format month display (from "2025-01" to "January 2025")
              let monthDisplay = monthValue;
              if (monthValue.match(/^\d{4}-\d{2}$/)) {
                const [y, m] = monthValue.split("-");
                const date = new Date(parseInt(y), parseInt(m) - 1, 1);
                monthDisplay = date.toLocaleDateString("en-US", {
                  month: "long",
                  year: "numeric",
                });
              }

              const grossSalary = parseFloat(fields["Gross Salary"] || 0);
              const deductions = parseFloat(fields["Total Deductions"] || 0);
              const netSalary = parseFloat(
                fields["Net Pay"] || fields["Net Salary"] || 0
              );

              // Status is always "Paid" since these are completed payroll records
              const status = "Paid";
              const statusColor = "bg-green-100 text-green-800";

              return `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 md:px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">${monthDisplay}</div>
                            </td>
                            <td class="hidden sm:table-cell px-4 md:px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">${formatCurrency(grossSalary)}</div>
                            </td>
                            <td class="hidden lg:table-cell px-4 md:px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">${formatCurrency(deductions)}</div>
                            </td>
                            <td class="px-4 md:px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-semibold text-gray-900">${formatCurrency(netSalary)}</div>
                            </td>
                            <td class="hidden md:table-cell px-4 md:px-6 py-4 whitespace-nowrap">
                                <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                                    ${status}
                                </span>
                            </td>
                            <td class="px-4 md:px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button onclick='downloadPayslipFromRecord(${JSON.stringify(fields).replace(/'/g, "&#39;")})' class="text-red-600 hover:text-red-900 flex items-center gap-1">
                                    <i class="fas fa-download"></i>
                                    <span class="hidden sm:inline">Download</span>
                                </button>
                            </td>
                        </tr>
                    `;
            })
            .join("");
        } catch (error) {

          tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-red-600">
                            <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                            <p>Error loading payment history. Please try again.</p>
                            <p class="text-sm text-gray-500 mt-2">${error.message}</p>
                        </td>
                    </tr>
                `;
        }
      }

      // ========================================
      // DOWNLOAD PAYSLIP FROM RECORD (Wrapper)
      // ========================================
      async function downloadPayslipFromRecord(fields) {
        // Structure payment data
        const basicSalary = parseFloat(fields["Basic Salary"] || 0);
        const housingAllowance = parseFloat(fields["Housing Allowance"] || 0);
        const transportAllowance = parseFloat(
          fields["Transport Allowance"] || 0
        );
        const benefits = parseFloat(fields["Benefits"] || 0);
        const otherAllowances = parseFloat(fields["Other Allowances"] || 0);

        const incomeTax = parseFloat(fields["Income Tax"] || 0);
        const welfare = parseFloat(fields["Welfare"] || 0);
        const socialSecurity = parseFloat(fields["Social Security"] || 0);
        const healthInsurance = parseFloat(fields["Health Insurance"] || 0);
        const otherDeductions = parseFloat(fields["Other Deductions"] || 0);

        const totalAllowances = parseFloat(fields["Total Allowances"] || 0);
        const totalDeductions = parseFloat(fields["Total Deductions"] || 0);
        const grossSalary = parseFloat(fields["Gross Salary"] || 0);
        const netSalary = parseFloat(
          fields["Net Pay"] || fields["Net Salary"] || 0
        );

        // Format period for display
        const monthValue = fields["Month"] || "";
        let periodString = monthValue;
        if (monthValue.match(/^\d{4}-\d{2}$/)) {
          const [y, m] = monthValue.split("-");
          const date = new Date(parseInt(y), parseInt(m) - 1, 1);
          periodString = date.toLocaleDateString("en-US", {
            month: "short",
            year: "numeric",
          });
        }

        const paymentData = {
          period: periodString,
          basicSalary: basicSalary,
          earnings: [
            { label: "Housing Allowance", amount: housingAllowance },
            { label: "Transport Allowance", amount: transportAllowance },
            { label: "Benefits", amount: benefits },
            { label: "Other Allowances", amount: otherAllowances },
          ].filter((item) => item.amount > 0),
          totalEarnings: totalAllowances,
          deductions: [
            { label: "Income Tax", amount: incomeTax },
            { label: "Welfare", amount: welfare },
            { label: "Social Security", amount: socialSecurity },
            { label: "Health Insurance", amount: healthInsurance },
            { label: "Other Deductions", amount: otherDeductions },
          ].filter((item) => item.amount > 0),
          totalDeductions: totalDeductions,
          netSalary: netSalary,
        };

        // Fetch employee bank account details
        let bankAccountNumber = "N/A";
        let bankName = "N/A";
        try {
          const employee = await getEmployee(currentUser.id);
          if (employee && employee.fields) {
            bankAccountNumber = employee.fields["Bank Account Number"] || "N/A";
            bankName = employee.fields["Bank Name"] || "N/A";
          }
        } catch (error) {

        }

        const employeeData = {
          name: currentUser.name || "N/A",
          nationalID: "N/A", // Not stored in session
          position: currentUser.jobTitle || "N/A",
          department: currentUser.department || "N/A",
          bankAccountNumber: bankAccountNumber,
          bankName: bankName,
        };

        await downloadPayslip(paymentData, employeeData);
      }

      // ========================================
      // DOWNLOAD PAYSLIP AS PDF (Exact Screenshot Format)
      // ========================================
      async function downloadPayslip(paymentData, employeeData) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF("p", "mm", "a4");

        // ============ HEADER – COMPANY INFO ============

        // Logo - Load from assets/images/logo_red.png (RGBA format works better with jsPDF)
        try {
          const logoResponse = await fetch("assets/images/logo_red.png");
          const logoBlob = await logoResponse.blob();
          const logoBase64 = await new Promise((resolve) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.readAsDataURL(logoBlob);
          });

          // Add image to PDF - calculate aspect ratio for proper sizing
          // logo_red.png is 1930x457, aspect ratio ~4.22:1
          // Height of 18mm, width should be ~76mm, but we'll use 30mm to fit header
          doc.addImage(logoBase64, "PNG", 20, 12, 30, 7);
        } catch (error) {

          // No logo placeholder - just skip it
        }

        // Company text (right aligned)
        doc.setFontSize(10);
        doc.setTextColor(0, 0, 0);
        doc.setFont("helvetica", "bold");
        doc.text("Packaging Glamour (BN491412019)", 190, 15, {
          align: "right",
        });

        doc.setFont("helvetica", "normal");
        doc.setFontSize(8);
        doc.text("Off Oyarifa Road", 190, 20, { align: "right" });
        doc.text("Accra", 190, 24, { align: "right" });
        doc.text("https://packglamour.com", 190, 29, { align: "right" });
        doc.text("help@packglamour.com", 190, 33, { align: "right" });
        doc.text("Tel: 0308251169", 190, 37, { align: "right" });

        // ============ TITLE SECTION ============

        const periodString = paymentData.period || "Oct 2025";
        doc.setFontSize(14);
        doc.setFont("helvetica", "bold");
        doc.text(`Payslip for Period Ending ${periodString} (GHS)`, 105, 52, {
          align: "center",
        });

        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        doc.text("Monthly", 105, 58, { align: "center" });

        // ============ EMPLOYEE INFO BOX ============

        doc.setFillColor(245, 245, 245);
        doc.rect(20, 65, 170, 50, "F");

        let y = 70;

        // LEFT COLUMN
        doc.setFont("helvetica", "normal");
        doc.setFontSize(8);
        doc.setTextColor(120, 120, 120);
        doc.text("Employee", 25, y);
        doc.setFontSize(9);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(0, 0, 0);
        doc.text(employeeData.name, 25, y + 4);

        y += 12;

        doc.setFont("helvetica", "normal");
        doc.setFontSize(8);
        doc.setTextColor(120, 120, 120);
        doc.text("National ID", 25, y);
        doc.setFontSize(9);
        doc.setTextColor(0, 0, 0);
        doc.text(employeeData.nationalID, 25, y + 4);

        y += 12;

        doc.setFontSize(8);
        doc.setTextColor(120, 120, 120);
        doc.text("Bank Name", 25, y);
        doc.setFont("helvetica", "normal");
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(9);
        doc.text(employeeData.bankName, 25, y + 4);

        y += 12;

        doc.setFontSize(8);
        doc.setTextColor(120, 120, 120);
        doc.text("Account Number", 25, y);
        doc.setFont("helvetica", "normal");
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(9);
        doc.text(employeeData.bankAccountNumber, 25, y + 4);

        // RIGHT COLUMN
        y = 70;
        doc.setFontSize(8);
        doc.setTextColor(120, 120, 120);
        doc.text("Job Position", 110, y);
        doc.setFontSize(9);
        doc.setTextColor(0, 0, 0);
        doc.text(employeeData.position, 110, y + 4);

        y += 12;

        doc.setFontSize(8);
        doc.setTextColor(120, 120, 120);
        doc.text("Department", 110, y);
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(9);
        doc.text(employeeData.department || "-", 110, y + 4);

        y += 12;

        doc.setFontSize(8);
        doc.setTextColor(120, 120, 120);
        doc.text("Payment Method", 110, y);
        doc.setFont("helvetica", "normal");
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(9);
        doc.text("Bank Transfer", 110, y + 4);

        // ============ SALARY BREAKDOWN ============

        y = 127;

        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        doc.setTextColor(0, 0, 0);
        doc.text("Basic Salary", 25, y);
        doc.text(formatAmount(paymentData.basicSalary), 185, y, {
          align: "right",
        });

        // Earnings Header
        y += 8;
        doc.setFontSize(10);
        doc.setTextColor(77, 124, 255);
        doc.text("+", 25, y);
        doc.setTextColor(0, 0, 0);
        doc.text(`Earning (${paymentData.earnings.length})`, 32, y);
        doc.text(formatAmount(paymentData.totalEarnings), 185, y, {
          align: "right",
        });

        // Earnings Box
        y += 4;
        doc.setFillColor(250, 250, 250);
        doc.rect(30, y, 160, paymentData.earnings.length * 7, "F");

        y += 6;
        doc.setFontSize(9);
        doc.setTextColor(80, 80, 80);

        paymentData.earnings.forEach((item) => {
          doc.text(item.label, 35, y);
          doc.text(formatAmount(item.amount), 180, y, { align: "right" });
          y += 7;
        });

        // Deduction Header
        y += 3;
        doc.setFontSize(10);
        doc.setTextColor(77, 124, 255);
        doc.text("-", 25, y);
        doc.setTextColor(0, 0, 0);
        doc.text(`Deduction (${paymentData.deductions.length})`, 32, y);

        doc.setTextColor(220, 38, 38);
        doc.text(
          "(" + formatAmount(paymentData.totalDeductions) + ")",
          185,
          y,
          { align: "right" }
        );

        // Deductions Box
        y += 4;
        doc.setFillColor(250, 250, 250);
        doc.rect(30, y, 160, paymentData.deductions.length * 7, "F");

        y += 6;
        doc.setFontSize(9);
        doc.setTextColor(80, 80, 80);

        paymentData.deductions.forEach((item) => {
          doc.text(item.label, 35, y);
          doc.text(formatAmount(item.amount), 180, y, { align: "right" });
          y += 7;
        });

        // ============ NET SALARY ============

        y += 8;
        doc.setDrawColor(200, 200, 200);
        doc.line(20, y, 190, y);

        y += 7;
        doc.setFontSize(12);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(0, 0, 0);
        doc.text("Net Salary", 25, y);
        doc.text(formatAmount(paymentData.netSalary), 185, y, {
          align: "right",
        });

        // ============ FOOTER ============

        doc.setFont("helvetica", "normal");
        doc.setFontSize(8);
        doc.setTextColor(120, 120, 120);
        doc.text(
          "This is a computer-generated payslip and does not require a signature.",
          105,
          285,
          { align: "center" }
        );

        // DOWNLOAD FILE
        const fileName = `Payslip_${periodString}_${employeeData.name.replace(/\s+/g, "_")}.pdf`;
        doc.save(fileName);
      }

      // Utility Format
      function formatAmount(amount) {
        return Number(amount).toLocaleString("en-GH", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });
      }

      // Format Currency (GH₵)
      function formatCurrency(amount) {
        return (
          "GH₵" +
          Number(amount).toLocaleString("en-GH", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          })
        );
      }

      // ========================================
      // MOBILE MENU TOGGLE
      // ========================================
      function toggleMobileMenu() {
        const mobileMenu = document.getElementById("mobileMenu");
        if (mobileMenu) {
          mobileMenu.classList.toggle("hidden");
        }
      }

      // ========================================
      // CHECK IF USER IS ADMIN AND SHOW LINK
      // ========================================
      async function checkAndShowAdminLink() {
        try {
          const currentUser = getCurrentUser();
          if (!currentUser || !currentUser.id) return;

          const employee = await getEmployee(currentUser.id);
          if (employee && employee.fields) {
            const role = employee.fields["Role"] || "";
            if (role === "Admin" || role === "HR") {
              // Show desktop admin link
              const adminLink = document.getElementById("adminLink");
              if (adminLink) adminLink.style.display = "";

              // Show mobile admin link
              const adminLinkMobile =
                document.getElementById("adminLinkMobile");
              if (adminLinkMobile) adminLinkMobile.style.display = "";
            }
          }
        } catch (error) {

        }
      }

      // ========================================
      // INITIALIZE PAGE
      // ========================================
      window.addEventListener("DOMContentLoaded", function () {
        loadSalaryInfo();
        loadPaymentHistory();
        checkAndShowAdminLink();
      });
    </script>
  </body>
</html>
