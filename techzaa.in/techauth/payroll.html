<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Packaging Glamour HR</title>

    <!-- Tailwind CSS (Local) -->
    <link rel="stylesheet" href="assets/css/tailwind.css" />

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Worker API Configuration -->
    <script src="config-worker.js?v=2"></script>

    <!-- Authentication Script -->
    <script src="auth.js"></script>

    <style>
      body {
        font-family: "Montserrat", sans-serif;
      }
      .salary-card {
        transition: all 0.3s ease;
      }
      .salary-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <!-- Navigation Header -->
    <header class="bg-white shadow-md sticky top-0 z-50">
      <div class="container mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
          <!-- Logo -->
          <div class="flex items-center space-x-3">
            <img src="assets/images/logo_red.png" alt="Logo" class="h-10" />
          </div>

          <!-- Navigation Menu -->
          <div class="flex items-center space-x-4">
            <a href="dashboard.html" class="text-gray-600 hover:text-red-600">
              <i class="fas fa-chart-line mr-1"></i> Dashboard
            </a>
            <a
              href="attendance-tracker.html"
              class="text-gray-600 hover:text-red-600"
            >
              <i class="fas fa-clock mr-1"></i> Attendance
            </a>
            <a
              href="leave-request.html"
              class="text-gray-600 hover:text-red-600"
            >
              <i class="fas fa-calendar-alt mr-1"></i> Leave
            </a>
            <a
              href="medical-claims.html"
              class="text-gray-600 hover:text-red-600"
            >
              <i class="fas fa-notes-medical mr-1"></i> Medical Claims
            </a>
            <a href="profile.html" class="text-gray-600 hover:text-red-600">
              <i class="fas fa-user mr-1"></i> Profile
            </a>
            <a
              href="announcements.html"
              class="text-gray-600 hover:text-red-600"
            >
              <i class="fas fa-bullhorn mr-1"></i> Announcements
            </a>
            <a href="payroll.html" class="text-red-600 font-semibold">
              <i class="fas fa-money-bill-wave mr-1"></i> Payroll
            </a>
            <a
              href="admin-dashboard.html"
              id="adminLink"
              class="text-gray-600 hover:text-red-600"
              style="display: none"
            >
              <i class="fas fa-user-shield mr-1"></i> Admin
            </a>
            <button onclick="logout()" class="text-gray-600 hover:text-red-600">
              <i class="fas fa-sign-out-alt mr-1"></i> Logout
            </button>
          </div>
        </div>
      </div>
    </header>

    <div class="container mx-auto px-4 py-8">
      <!-- Header Section -->
      <div class="mb-6">
        <h2 class="text-3xl font-bold text-gray-800">Payroll Information</h2>
        <p class="text-gray-600 mt-1">
          View your salary details and payment history
        </p>
      </div>

      <!-- Current Salary Overview -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <!-- Gross Salary Card -->
        <div
          class="salary-card bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow-lg p-6 text-white"
        >
          <div class="flex items-center justify-between mb-4">
            <div>
              <p class="text-green-100 text-sm font-medium">Gross Salary</p>
              <h3 class="text-3xl font-bold" id="grossSalary">GH₵0</h3>
            </div>
            <div class="bg-white bg-opacity-20 rounded-full p-4">
              <i class="fas fa-dollar-sign text-2xl"></i>
            </div>
          </div>
          <div class="text-sm text-green-100">
            <i class="fas fa-info-circle mr-1"></i> Base + Allowances
          </div>
        </div>

        <!-- Deductions Card -->
        <div
          class="salary-card bg-gradient-to-br from-red-500 to-red-600 rounded-lg shadow-lg p-6 text-white"
        >
          <div class="flex items-center justify-between mb-4">
            <div>
              <p class="text-red-100 text-sm font-medium">Total Deductions</p>
              <h3 class="text-3xl font-bold" id="totalDeductions">GH₵0</h3>
            </div>
            <div class="bg-white bg-opacity-20 rounded-full p-4">
              <i class="fas fa-minus-circle text-2xl"></i>
            </div>
          </div>
          <div class="text-sm text-red-100">
            <i class="fas fa-info-circle mr-1"></i> Tax + Benefits
          </div>
        </div>

        <!-- Net Salary Card -->
        <div
          class="salary-card bg-gradient-to-br from-red-500 to-red-600 rounded-lg shadow-lg p-6 text-white"
        >
          <div class="flex items-center justify-between mb-4">
            <div>
              <p class="text-red-100 text-sm font-medium">Net Salary</p>
              <h3 class="text-3xl font-bold" id="netSalary">GH₵0</h3>
            </div>
            <div class="bg-white bg-opacity-20 rounded-full p-4">
              <i class="fas fa-wallet text-2xl"></i>
            </div>
          </div>
          <div class="text-sm text-red-100">
            <i class="fas fa-info-circle mr-1"></i> Take-home amount
          </div>
        </div>
      </div>

      <!-- Salary Breakdown -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Earnings Breakdown -->
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4">
            <i class="fas fa-plus-circle text-green-600 mr-2"></i> Earnings
            Breakdown
          </h3>
          <div class="space-y-3">
            <div
              class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"
            >
              <span class="text-gray-700">Basic Salary</span>
              <span class="font-semibold" id="basicSalary">GH₵0</span>
            </div>
            <div
              class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"
            >
              <span class="text-gray-700">Housing Allowance</span>
              <span class="font-semibold" id="housingAllowance">GH₵0</span>
            </div>
            <div
              class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"
            >
              <span class="text-gray-700">Transport Allowance</span>
              <span class="font-semibold" id="transportAllowance">GH₵0</span>
            </div>
            <div
              class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"
            >
              <span class="text-gray-700">Other Allowances</span>
              <span class="font-semibold" id="otherAllowances">GH₵0</span>
            </div>
          </div>
        </div>

        <!-- Deductions Breakdown -->
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4">
            <i class="fas fa-minus-circle text-red-600 mr-2"></i> Deductions
            Breakdown
          </h3>
          <div class="space-y-3">
            <div
              class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"
            >
              <span class="text-gray-700">Income Tax</span>
              <span class="font-semibold" id="incomeTax">GH₵0</span>
            </div>
            <div
              class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"
            >
              <span class="text-gray-700">Social Security</span>
              <span class="font-semibold" id="socialSecurity">GH₵0</span>
            </div>
            <div
              class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"
            >
              <span class="text-gray-700">Health Insurance</span>
              <span class="font-semibold" id="healthInsurance">GH₵0</span>
            </div>
            <div
              class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"
            >
              <span class="text-gray-700">Other Deductions</span>
              <span class="font-semibold" id="otherDeductions">GH₵0</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Payment History -->
      <div class="bg-white rounded-lg shadow-lg p-6">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-bold text-gray-800">
            <i class="fas fa-history text-red-600 mr-2"></i> Payment History
          </h3>
          <div class="flex space-x-2">
            <select
              id="yearFilter"
              onchange="loadPaymentHistory()"
              class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
            >
              <option value="2025">2025</option>
              <option value="2024">2024</option>
              <option value="2023">2023</option>
            </select>
          </div>
        </div>

        <!-- Payment History Table -->
        <div class="overflow-x-auto">
          <table class="min-w-full">
            <thead class="bg-gray-50">
              <tr>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Month
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Gross Salary
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Deductions
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Net Salary
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Status
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Actions
                </th>
              </tr>
            </thead>
            <tbody
              id="paymentHistoryBody"
              class="bg-white divide-y divide-gray-200"
            >
              <!-- Loading state -->
              <tr>
                <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                  <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                  <p>Loading payment history...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      // ========================================
      // AUTHENTICATION CHECK
      // ========================================
      if (!requireAuth()) {
        // Will redirect automatically
      }

      const currentUser = getCurrentUser();

      // Show admin link if user is admin
      const adminLink = document.getElementById("adminLink");
      if (currentUser.role === "Admin" && adminLink) {
        adminLink.style.display = "inline-block";
      }

      // ========================================
      // LOAD CURRENT SALARY INFO
      // ========================================
      async function loadSalaryInfo() {
        try {
          // Fetch all payroll records using Worker API
          const data = await getPayroll();

          // Filter for this employee's payroll records (client-side)
          const employeePayrolls = data.records.filter((record) => {
            const employeeField = record.fields["Employee"];
            return (
              employeeField &&
              Array.isArray(employeeField) &&
              employeeField.includes(currentUser.id)
            );
          });

          if (employeePayrolls.length > 0) {
            // Sort by month (descending) to get the latest payroll
            employeePayrolls.sort((a, b) => {
              const monthA = a.fields["Month"] || "";
              const monthB = b.fields["Month"] || "";
              return monthB.localeCompare(monthA);
            });

            const salary = employeePayrolls[0].fields;

            // Update earnings
            const basicSalary = parseFloat(salary["Basic Salary"] || 0);
            const housingAllowance = parseFloat(
              salary["Housing Allowance"] || 0
            );
            const transportAllowance = parseFloat(
              salary["Transport Allowance"] || 0
            );
            const benefits = parseFloat(salary["Benefits"] || 0);
            const otherAllowances = parseFloat(salary["Other Allowances"] || 0);

            // Get calculated totals from Airtable
            const totalAllowances = parseFloat(salary["Total Allowances"] || 0);
            const grossSalary = parseFloat(salary["Gross Salary"] || 0);

            // Update deductions
            const incomeTax = parseFloat(salary["Income Tax"] || 0);
            const welfare = parseFloat(salary["Welfare"] || 0);
            const socialSecurity = parseFloat(salary["Social Security"] || 0);
            const healthInsurance = parseFloat(salary["Health Insurance"] || 0);
            const otherDeductions = parseFloat(salary["Other Deductions"] || 0);

            // Get calculated totals from Airtable (check both 'Net Salary' and 'Net Pay')
            const totalDeductions = parseFloat(salary["Total Deductions"] || 0);
            const netSalary = parseFloat(
              salary["Net Pay"] || salary["Net Salary"] || 0
            );

            // Update UI
            document.getElementById("grossSalary").textContent =
              formatCurrency(grossSalary);
            document.getElementById("totalDeductions").textContent =
              formatCurrency(totalDeductions);
            document.getElementById("netSalary").textContent =
              formatCurrency(netSalary);

            document.getElementById("basicSalary").textContent =
              formatCurrency(basicSalary);
            document.getElementById("housingAllowance").textContent =
              formatCurrency(housingAllowance);
            document.getElementById("transportAllowance").textContent =
              formatCurrency(transportAllowance);
            document.getElementById("otherAllowances").textContent =
              formatCurrency(benefits + otherAllowances);

            document.getElementById("incomeTax").textContent =
              formatCurrency(incomeTax);
            document.getElementById("socialSecurity").textContent =
              formatCurrency(socialSecurity);
            document.getElementById("healthInsurance").textContent =
              formatCurrency(healthInsurance);
            document.getElementById("otherDeductions").textContent =
              formatCurrency(welfare + otherDeductions);
          }
        } catch (error) {
          console.error("Error loading salary info:", error);
        }
      }

      // ========================================
      // LOAD PAYMENT HISTORY
      // ========================================
      async function loadPaymentHistory() {
        const year = document.getElementById("yearFilter").value;
        const tbody = document.getElementById("paymentHistoryBody");

        tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>Loading payment history...</p>
                    </td>
                </tr>
            `;

        try {
          // Fetch all payroll records using Worker API
          const data = await getPayroll();

          // Filter for this employee's payroll records (client-side)
          let employeePayrolls = data.records.filter((record) => {
            const employeeField = record.fields["Employee"];
            return (
              employeeField &&
              Array.isArray(employeeField) &&
              employeeField.includes(currentUser.id)
            );
          });

          // Filter by year
          employeePayrolls = employeePayrolls.filter((record) => {
            const month = record.fields["Month"] || "";
            return month.startsWith(year);
          });

          // Sort by month (descending)
          employeePayrolls.sort((a, b) => {
            const monthA = a.fields["Month"] || "";
            const monthB = b.fields["Month"] || "";
            return monthB.localeCompare(monthA);
          });

          if (employeePayrolls.length === 0) {
            tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                                <i class="fas fa-inbox text-4xl mb-2"></i>
                                <p>No payment history found for ${year}</p>
                            </td>
                        </tr>
                    `;
            return;
          }

          tbody.innerHTML = employeePayrolls
            .map((record) => {
              const fields = record.fields;
              const monthValue = fields["Month"] || "";

              // Format month display (from "2025-01" to "January 2025")
              let monthDisplay = monthValue;
              if (monthValue.match(/^\d{4}-\d{2}$/)) {
                const [y, m] = monthValue.split("-");
                const date = new Date(parseInt(y), parseInt(m) - 1, 1);
                monthDisplay = date.toLocaleDateString("en-US", {
                  month: "long",
                  year: "numeric",
                });
              }

              const grossSalary = parseFloat(fields["Gross Salary"] || 0);
              const deductions = parseFloat(fields["Total Deductions"] || 0);
              const netSalary = parseFloat(
                fields["Net Pay"] || fields["Net Salary"] || 0
              );

              // Status is always "Paid" since these are completed payroll records
              const status = "Paid";
              const statusColor = "bg-green-100 text-green-800";

              return `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">${monthDisplay}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">${formatCurrency(grossSalary)}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">${formatCurrency(deductions)}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-semibold text-gray-900">${formatCurrency(netSalary)}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                                    ${status}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button onclick='downloadPayslip(${JSON.stringify(fields).replace(/'/g, "&#39;")}, "${record.id}")' class="text-red-600 hover:text-red-900">
                                    <i class="fas fa-download mr-1"></i> Download
                                </button>
                            </td>
                        </tr>
                    `;
            })
            .join("");
        } catch (error) {
          console.error("Error loading payment history:", error);
          tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-red-600">
                            <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                            <p>Error loading payment history. Please try again.</p>
                            <p class="text-sm text-gray-500 mt-2">${error.message}</p>
                        </td>
                    </tr>
                `;
        }
      }

      // ========================================
      // DOWNLOAD PAYSLIP AS PDF
      // ========================================
      async function downloadPayslip(paymentData, recordId) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Fetch employee data for additional details
        let employeeData = null;
        try {
          const empResponse = await getEmployee(currentUser.id);
          employeeData = empResponse.fields;
        } catch (error) {
          console.error('Error fetching employee data:', error);
        }

        // ===== HEADER SECTION =====
        // Company info on the right side
        doc.setFontSize(10);
        doc.setTextColor(0, 0, 0);
        doc.setFont(undefined, "bold");
        doc.text("Packaging Glamour (BN491412019)", 190, 15, { align: "right" });

        doc.setFont(undefined, "normal");
        doc.setFontSize(8);
        doc.text("off Oyarifa Road", 190, 20, { align: "right" });
        doc.text("Accra", 190, 24, { align: "right" });
        doc.text("https://packglamour.com", 190, 29, { align: "right" });
        doc.text("help@packglamour.com", 190, 33, { align: "right" });
        doc.text("Tel: 0308251169", 190, 37, { align: "right" });

        // Logo placeholder (red box with 'P' - you can add actual logo later)
        doc.setDrawColor(220, 38, 38);
        doc.setFillColor(220, 38, 38);
        doc.rect(20, 15, 15, 15, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(16);
        doc.setFont(undefined, "bold");
        doc.text("P", 27.5, 26, { align: "center" });

        // ===== TITLE SECTION =====
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(14);
        doc.setFont(undefined, "bold");

        // Format period ending date
        const periodEndDate = paymentData["Period End Date"];
        const monthValue = paymentData["Month"] || "";
        let periodEndingText = "";

        if (periodEndDate) {
          const endDate = new Date(periodEndDate);
          periodEndingText = endDate.toLocaleDateString("en-US", { month: "short", year: "numeric" });
        } else if (monthValue.match(/^\d{4}-\d{2}$/)) {
          const [y, m] = monthValue.split("-");
          const date = new Date(parseInt(y), parseInt(m) - 1, 1);
          periodEndingText = date.toLocaleDateString("en-US", { month: "short", year: "numeric" });
        }

        const payslipTitle = paymentData["Payslip Title"] || `Payslip for Period Ending ${periodEndingText} (GHS)`;
        doc.text(payslipTitle, 105, 50, { align: "center" });

        // Pay cycle subtitle
        const payCycle = paymentData["Pay Cycle"] || "monthly";
        const cycleLabel = payCycle.charAt(0).toUpperCase() + payCycle.slice(1);
        doc.setFontSize(10);
        doc.setFont(undefined, "normal");
        doc.text(cycleLabel, 105, 56, { align: "center" });

        // ===== EMPLOYEE INFO BOX =====
        let y = 65;

        // Draw light gray box
        doc.setFillColor(245, 245, 245);
        doc.rect(20, y, 170, 40, 'F');

        // Employee details
        doc.setFontSize(8);
        doc.setTextColor(100, 100, 100);
        doc.setFont(undefined, "normal");

        y += 5;
        doc.text("Employee", 25, y);
        doc.setFont(undefined, "bold");
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(9);
        doc.text(currentUser.name || "N/A", 25, y + 4);

        y += 10;
        doc.setFont(undefined, "normal");
        doc.setFontSize(8);
        doc.setTextColor(100, 100, 100);
        doc.text("National ID", 25, y);
        doc.setFont(undefined, "normal");
        doc.setTextColor(0, 0, 0);
        doc.text(employeeData?.['Employee ID'] || employeeData?.['National ID'] || "N/A", 25, y + 4);

        y += 10;
        doc.setTextColor(100, 100, 100);
        doc.text("Payment Method", 25, y);
        doc.setTextColor(0, 0, 0);
        doc.text("Cash", 25, y + 4);

        // Right column
        y = 70;
        doc.setTextColor(100, 100, 100);
        doc.text("Job Position", 110, y);
        doc.setTextColor(0, 0, 0);
        doc.text(employeeData?.['Job Title'] || employeeData?.['Position'] || "N/A", 110, y + 4);

        y += 10;
        doc.setTextColor(100, 100, 100);
        doc.text("Department", 110, y);
        doc.setTextColor(0, 0, 0);
        doc.text(employeeData?.['Department'] || "-", 110, y + 4);

        // ===== SALARY BREAKDOWN =====
        y = 115;

        // Get all salary values
        const basicSalary = parseFloat(paymentData["Basic Salary"] || 0);
        const housingAllowance = parseFloat(paymentData["Housing Allowance"] || 0);
        const transportAllowance = parseFloat(paymentData["Transport Allowance"] || 0);
        const benefits = parseFloat(paymentData["Benefits"] || 0);
        const otherAllowances = parseFloat(paymentData["Other Allowances"] || 0);
        const incomeTax = parseFloat(paymentData["Income Tax"] || 0);
        const welfare = parseFloat(paymentData["Welfare"] || 0);
        const socialSecurity = parseFloat(paymentData["Social Security"] || 0);
        const healthInsurance = parseFloat(paymentData["Health Insurance"] || 0);
        const otherDeductions = parseFloat(paymentData["Other Deductions"] || 0);
        const grossSalary = parseFloat(paymentData["Gross Salary"] || 0);
        const totalDeductions = parseFloat(paymentData["Total Deductions"] || 0);
        const netSalary = parseFloat(paymentData["Net Pay"] || paymentData["Net Salary"] || 0);

        // Parse custom allowances and deductions
        let customAllowances = [];
        let customDeductions = [];
        try {
          customAllowances = JSON.parse(paymentData["Custom Allowances"] || "[]");
          customDeductions = JSON.parse(paymentData["Custom Deductions"] || "[]");
        } catch (e) {}

        // Calculate total earnings count
        const earningsCount = customAllowances.length;
        const deductionsCount = customDeductions.length;

        // Basic Salary
        doc.setFont(undefined, "normal");
        doc.setFontSize(10);
        doc.setTextColor(0, 0, 0);
        doc.text("Basic Salary", 25, y);
        doc.text(formatCurrency(basicSalary).replace('GHS', '').trim(), 185, y, { align: "right" });

        // Earning section with collapsible indicator
        y += 7;
        doc.setTextColor(70, 130, 180);
        doc.text("▲", 25, y);
        doc.setTextColor(0, 0, 0);
        doc.text(`Earning (${earningsCount + 4})`, 32, y);
        const totalEarnings = housingAllowance + transportAllowance + benefits + otherAllowances + customAllowances.reduce((sum, item) => sum + parseFloat(item.amount || 0), 0);
        doc.text(formatCurrency(totalEarnings).replace('GHS', '').trim(), 185, y, { align: "right" });

        // Show earnings breakdown in lighter box
        y += 5;
        doc.setFillColor(250, 250, 250);
        const earningsBoxHeight = (earningsCount + 4) * 7;
        doc.rect(30, y, 160, earningsBoxHeight, 'F');

        y += 5;
        doc.setFontSize(9);
        doc.setTextColor(80, 80, 80);

        if (transportAllowance > 0) {
          doc.text("Transportation Allowance (TRPT A)", 35, y);
          doc.text(formatCurrency(transportAllowance).replace('GHS', '').trim(), 180, y, { align: "right" });
          y += 7;
        }

        if (housingAllowance > 0) {
          doc.text("Housing Allowance", 35, y);
          doc.text(formatCurrency(housingAllowance).replace('GHS', '').trim(), 180, y, { align: "right" });
          y += 7;
        }

        if (benefits > 0) {
          doc.text("Benefits", 35, y);
          doc.text(formatCurrency(benefits).replace('GHS', '').trim(), 180, y, { align: "right" });
          y += 7;
        }

        if (otherAllowances > 0) {
          doc.text("Other Allowances", 35, y);
          doc.text(formatCurrency(otherAllowances).replace('GHS', '').trim(), 180, y, { align: "right" });
          y += 7;
        }

        // Add custom allowances
        customAllowances.forEach(allowance => {
          doc.text(allowance.name || "Custom Allowance", 35, y);
          doc.text(formatCurrency(parseFloat(allowance.amount || 0)).replace('GHS', '').trim(), 180, y, { align: "right" });
          y += 7;
        });

        // Deduction section
        y += 3;
        doc.setFontSize(10);
        doc.setTextColor(70, 130, 180);
        doc.text("▲", 25, y);
        doc.setTextColor(0, 0, 0);
        doc.text(`Deduction (${deductionsCount + 5})`, 32, y);
        doc.setTextColor(220, 38, 38);
        doc.text(`(${formatCurrency(totalDeductions).replace('GHS', '').trim()})`, 185, y, { align: "right" });

        // Show deductions breakdown
        y += 5;
        doc.setFillColor(250, 250, 250);
        const deductionsBoxHeight = (deductionsCount + 5) * 7;
        doc.rect(30, y, 160, deductionsBoxHeight, 'F');

        y += 5;
        doc.setFontSize(9);
        doc.setTextColor(80, 80, 80);

        if (incomeTax > 0) {
          doc.text("Pay As You Earn (PAYE)", 35, y);
          doc.text(formatCurrency(incomeTax).replace('GHS', '').trim(), 180, y, { align: "right" });
          y += 7;
        }

        if (otherDeductions > 0) {
          doc.text("Salary Advance (SADV)", 35, y);
          doc.text(formatCurrency(otherDeductions).replace('GHS', '').trim(), 180, y, { align: "right" });
          y += 7;
        }

        if (socialSecurity > 0) {
          doc.text("Social Security Contribution Employee (SSNIT C)", 35, y);
          doc.text(formatCurrency(socialSecurity).replace('GHS', '').trim(), 180, y, { align: "right" });
          y += 7;
        }

        if (welfare > 0) {
          doc.text("Staff Welfare Fund (SWF)", 35, y);
          doc.text(formatCurrency(welfare).replace('GHS', '').trim(), 180, y, { align: "right" });
          y += 7;
        }

        if (healthInsurance > 0) {
          doc.text("Health Insurance", 35, y);
          doc.text(formatCurrency(healthInsurance).replace('GHS', '').trim(), 180, y, { align: "right" });
          y += 7;
        }

        // Add custom deductions
        customDeductions.forEach(deduction => {
          doc.text(deduction.name || "Custom Deduction", 35, y);
          doc.text(formatCurrency(parseFloat(deduction.amount || 0)).replace('GHS', '').trim(), 180, y, { align: "right" });
          y += 7;
        });

        // Net Salary (prominent)
        y += 10;
        doc.setDrawColor(220, 220, 220);
        doc.line(20, y - 5, 190, y - 5);

        doc.setFont(undefined, "bold");
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        doc.text("Net Salary", 25, y);
        doc.text(formatCurrency(netSalary).replace('GHS', '').trim(), 185, y, { align: "right" });

        // Footer
        doc.setFontSize(8);
        doc.setFont(undefined, "normal");
        doc.setTextColor(128, 128, 128);
        doc.text(
          "This is a computer-generated payslip and does not require a signature.",
          105,
          280,
          { align: "center" }
        );

        // Save PDF
        const pdfFilename = `Payslip_${periodEndingText.replace(/\s+/g, "_")}_${currentUser.name.replace(/\s+/g, "_")}.pdf`;
        doc.save(pdfFilename);
      }

      // ========================================
      // UTILITY FUNCTIONS
      // ========================================
      function formatCurrency(amount) {
        return new Intl.NumberFormat("en-GH", {
          style: "currency",
          currency: "GHS",
        }).format(amount);
      }

      // ========================================
      // INITIALIZE
      // ========================================
      loadSalaryInfo();
      loadPaymentHistory();
    </script>
  </body>
</html>
