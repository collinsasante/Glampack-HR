<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Packaging Glamour HR</title>

    <!-- Tailwind CSS (Local) -->
    <link rel="stylesheet" href="assets/css/tailwind.css" />

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Chart.js for charts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>

    <!-- Authentication Script -->
    <script src="auth.js"></script>

    <!-- Worker API Configuration -->
    <script src="config-worker.js"></script>

    <style>
        body {
            font-family: 'Montserrat', sans-serif;
        }
        .stat-card {
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        .pulse-dot {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Navigation Header -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <!-- Logo -->
                <div class="flex items-center space-x-3">
                    <img src="assets/images/logo_red.png" alt="Logo" class="h-10">
                    <span class="text-xl font-bold text-gray-800">Dashboard</span>
                </div>

                <!-- Navigation Menu -->
                <div class="flex items-center space-x-4">
                    <a href="dashboard.html" class="text-red-600 font-semibold">
                        <i class="fas fa-chart-line mr-1"></i> Dashboard
                    </a>
                    <a href="attendance-tracker.html" class="text-gray-600 hover:text-red-600">
                        <i class="fas fa-clock mr-1"></i> Attendance
                    </a>
                    <a href="leave-request.html" class="text-gray-600 hover:text-red-600">
                        <i class="fas fa-calendar-alt mr-1"></i> Leave
                    </a>
                    <a href="medical-claims.html" class="text-gray-600 hover:text-red-600">
                        <i class="fas fa-notes-medical mr-1"></i> Medical Claims
                    </a>
                    <a href="profile.html" class="text-gray-600 hover:text-red-600">
                        <i class="fas fa-user mr-1"></i> Profile
                    </a>
                    <a href="announcements.html" class="text-gray-600 hover:text-red-600">
                        <i class="fas fa-bullhorn mr-1"></i> Announcements
                    </a>
                    <a href="payroll.html" class="text-gray-600 hover:text-red-600">
                        <i class="fas fa-money-bill-wave mr-1"></i> Payroll
                    </a>
                    <a href="admin-dashboard.html" id="adminLink" class="text-gray-600 hover:text-red-600" style="display: none;">
                        <i class="fas fa-user-shield mr-1"></i> Admin
                    </a>
                    <button onclick="logout()" class="text-gray-600 hover:text-red-600">
                        <i class="fas fa-sign-out-alt mr-1"></i> Logout
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">

        <!-- Welcome Header -->
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-800">Welcome back, <span id="userName">User</span>!</h2>
            <p class="text-gray-600 mt-1">Here's what's happening with your work today.</p>
        </div>

        <!-- Quick Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6 mb-8">
            <!-- Today's Status -->
            <div class="bg-white rounded-lg shadow-md p-6 stat-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Today's Status</p>
                        <h3 class="text-2xl font-bold text-green-600 mt-2" id="todayStatus">--</h3>
                        <p class="text-xs text-gray-500 mt-1" id="checkInTime">--</p>
                    </div>
                    <div class="bg-green-100 rounded-full p-4">
                        <i class="fas fa-check-circle text-green-600 text-2xl"></i>
                    </div>
                </div>
            </div>

            <!-- Hours This Month -->
            <div class="bg-white rounded-lg shadow-md p-6 stat-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Hours This Month</p>
                        <h3 class="text-2xl font-bold text-blue-600 mt-2" id="monthlyHours">0</h3>
                        <p class="text-xs text-gray-500 mt-1">of 216 hours</p>
                    </div>
                    <div class="bg-blue-100 rounded-full p-4">
                        <i class="fas fa-clock text-blue-600 text-2xl"></i>
                    </div>
                </div>
            </div>

            <!-- Leave Balance -->
            <div class="bg-white rounded-lg shadow-md p-6 stat-card cursor-pointer" onclick="window.location.href='leave-request.html'">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Leave Balance</p>
                        <h3 class="text-2xl font-bold text-purple-600 mt-2" id="leaveBalance">--</h3>
                        <p class="text-xs text-gray-500 mt-1">days remaining</p>
                    </div>
                    <div class="bg-purple-100 rounded-full p-4">
                        <i class="fas fa-umbrella-beach text-purple-600 text-2xl"></i>
                    </div>
                </div>
            </div>

            <!-- Pending Requests -->
            <div class="bg-white rounded-lg shadow-md p-6 stat-card cursor-pointer" onclick="window.location.href='leave-request.html'">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Pending Requests</p>
                        <h3 class="text-2xl font-bold text-yellow-600 mt-2" id="pendingRequests">0</h3>
                        <p class="text-xs text-gray-500 mt-1">awaiting approval</p>
                    </div>
                    <div class="bg-yellow-100 rounded-full p-4">
                        <i class="fas fa-hourglass-half text-yellow-600 text-2xl"></i>
                    </div>
                </div>
            </div>

            <!-- Medical Entitlement -->
            <div class="bg-white rounded-lg shadow-md p-6 stat-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Medical Entitlement</p>
                        <h3 class="text-2xl font-bold text-teal-600 mt-2" id="medicalBalance">--</h3>
                        <p class="text-xs text-gray-500 mt-1">GH₵ available</p>
                    </div>
                    <div class="bg-teal-100 rounded-full p-4">
                        <i class="fas fa-briefcase-medical text-teal-600 text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Policy Documents Section -->
        <div class="bg-gradient-to-r from-red-50 to-orange-50 rounded-lg shadow-md p-6 mb-8 border border-red-100">
            <div class="flex items-center mb-4">
                <div class="bg-red-600 p-3 rounded-lg mr-4">
                    <i class="fas fa-book text-white text-2xl"></i>
                </div>
                <div>
                    <h2 class="text-xl font-bold text-gray-800">Important Documents</h2>
                    <p class="text-sm text-gray-600">Review company policies and guidelines</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                <!-- Staff Medical Policy -->
                <a href="#" onclick="openPolicyDocument('medical-policy'); return false;"
                   class="bg-white rounded-lg p-4 hover:shadow-lg transition-shadow cursor-pointer border border-red-200 hover:border-red-400">
                    <div class="flex items-start">
                        <div class="bg-red-100 p-3 rounded-lg mr-3">
                            <i class="fas fa-file-medical text-red-600 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800 mb-1">Staff Medical Policy</h3>
                            <p class="text-xs text-gray-600">Coverage details and guidelines</p>
                        </div>
                    </div>
                </a>

                <!-- Employee Handbook -->
                <a href="#" onclick="openPolicyDocument('employee-handbook'); return false;"
                   class="bg-white rounded-lg p-4 hover:shadow-lg transition-shadow cursor-pointer border border-orange-200 hover:border-orange-400">
                    <div class="flex items-start">
                        <div class="bg-orange-100 p-3 rounded-lg mr-3">
                            <i class="fas fa-book-open text-orange-600 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800 mb-1">Employee Handbook</h3>
                            <p class="text-xs text-gray-600">Company policies and procedures</p>
                        </div>
                    </div>
                </a>

                <!-- Staff Welfare Guide -->
                <a href="#" onclick="openPolicyDocument('welfare-guide'); return false;"
                   class="bg-white rounded-lg p-4 hover:shadow-lg transition-shadow cursor-pointer border border-green-200 hover:border-green-400">
                    <div class="flex items-start">
                        <div class="bg-green-100 p-3 rounded-lg mr-3">
                            <i class="fas fa-hands-helping text-green-600 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800 mb-1">Staff Welfare Guide</h3>
                            <p class="text-xs text-gray-600">Benefits and support programs</p>
                        </div>
                    </div>
                </a>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Attendance Overview -->
            <div class="lg:col-span-2 bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Attendance Overview</h3>
                    <select id="attendanceMonthFilter" onchange="filterAttendanceChart()" class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-red-500">
                        <option value="current">This Month</option>
                        <option value="last">Last Month</option>
                        <option value="all">All Time</option>
                    </select>
                </div>
                <div class="relative" style="height: 300px;">
                    <canvas id="attendanceChart"></canvas>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-6">Quick Actions</h3>
                <div class="space-y-3">
                    <button onclick="window.location.href='attendance-tracker.html'" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg transition flex items-center justify-center">
                        <i class="fas fa-clock mr-2"></i> Attendance
                    </button>
                    <button onclick="window.location.href='leave-request.html'" class="w-full bg-red-600 hover:bg-red-700 text-white font-medium py-3 px-4 rounded-lg transition flex items-center justify-center">
                        <i class="fas fa-calendar-plus mr-2"></i> Request Leave
                    </button>
                    <button onclick="window.location.href='profile.html'" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-medium py-3 px-4 rounded-lg transition flex items-center justify-center">
                        <i class="fas fa-user-edit mr-2"></i> Update Profile
                    </button>
                    <button onclick="window.location.href='payroll.html'" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg transition flex items-center justify-center">
                        <i class="fas fa-receipt mr-2"></i> View Payslip
                    </button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Recent Announcements -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Recent Announcements</h3>
                    <a href="announcements.html" class="text-red-600 hover:text-red-700 text-sm font-medium">View All <i class="fas fa-arrow-right ml-1"></i></a>
                </div>
                <div id="announcementsList" class="space-y-4">
                    <!-- Loading State -->
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>Loading announcements...</p>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-6">Recent Activity</h3>
                <div id="activityFeed" class="space-y-4">
                    <!-- Loading State -->
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>Loading activity...</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Policy Document Modal -->
    <div id="policyModal" class="fixed inset-0 bg-gray-100 bg-opacity-30 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-start sticky top-0 bg-white">
                <div>
                    <h3 id="policyTitle" class="text-2xl font-bold text-gray-800"></h3>
                    <p id="policySubtitle" class="text-sm text-gray-600 mt-1"></p>
                </div>
                <button onclick="closePolicyModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <div id="policyContent" class="prose max-w-none"></div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // AUTHENTICATION CHECK
        // ========================================
        if (!requireAuth()) {
            // Will redirect automatically
        }

        const currentUser = getCurrentUser();

        let attendanceChart = null;
        let allAttendanceRecords = [];

        // ========================================
        // INITIALIZE DASHBOARD
        // ========================================
        async function initializeDashboard() {
            // Display user name
            document.getElementById('userName').textContent = currentUser.name.split(' ')[0];
            const userInfoText = `Welcome, ${currentUser.name}`;
            document.getElementById('userInfo').textContent = userInfoText;

            // Show admin link if user is admin
            if (currentUser.role === 'Admin') {
                document.getElementById('adminLink').style.display = 'inline-block';
            }

            // Load all data
            await Promise.all([
                loadTodayStatus(),
                loadMonthlyHours(),
                loadLeaveBalance(),
                loadMedicalEntitlement(),
                loadPendingRequests(),
                loadAttendanceData(),
                loadAnnouncements(),
                loadRecentActivity()
            ]);
        }

        // ========================================
        // LOAD TODAY'S STATUS
        // ========================================
        async function loadTodayStatus() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const filterFormula = `AND(FIND('${currentUser.id}', ARRAYJOIN({Employee})), {Date} = '${today}')`;

                // Use Worker API
                const data = await getAttendance(filterFormula);

                if (data.records.length > 0) {
                    const record = data.records[0];
                    const checkIn = record.fields['Check-in Time'];
                    const checkOut = record.fields['Check-out Time'];

                    if (checkOut) {
                        document.getElementById('todayStatus').textContent = 'Checked Out';
                        document.getElementById('checkInTime').textContent = `${checkIn} - ${checkOut}`;
                        document.getElementById('quickCheckInBtn').classList.add('hidden');
                    } else if (checkIn) {
                        document.getElementById('todayStatus').textContent = 'Checked In';
                        document.getElementById('checkInTime').textContent = `Since ${checkIn}`;
                        document.getElementById('quickCheckInBtn').classList.add('hidden');
                        document.getElementById('quickCheckOutBtn').classList.remove('hidden');
                    }
                } else {
                    document.getElementById('todayStatus').textContent = 'Not Checked In';
                    document.getElementById('checkInTime').textContent = 'No record today';
                }
            } catch (error) {
                console.error('Error loading today status:', error);
                document.getElementById('todayStatus').textContent = '--';
            }
        }

        // ========================================
        // LOAD MONTHLY HOURS
        // ========================================
        async function loadMonthlyHours() {
            try {
                const now = new Date();
                const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
                const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];

                const filterFormula = `AND(FIND('${currentUser.id}', ARRAYJOIN({Employee})), IS_AFTER({Date}, '${firstDay}'), IS_BEFORE({Date}, '${lastDay}'))`;

                // Use Worker API
                const data = await getAttendance(filterFormula);

                let totalHours = 0;
                data.records.forEach(record => {
                    const hours = parseFloat(record.fields['Hours Worked']) || 0;
                    totalHours += hours;
                });

                document.getElementById('monthlyHours').textContent = totalHours.toFixed(1);
            } catch (error) {
                console.error('Error loading monthly hours:', error);
                document.getElementById('monthlyHours').textContent = '0';
            }
        }

        // ========================================
        // LOAD LEAVE BALANCE
        // ========================================
        async function loadLeaveBalance() {
            try {
                // Use Worker API
                const data = await getEmployee(currentUser.id);
                const balance = data.fields['Annual Leave Balance'] !== undefined ? data.fields['Annual Leave Balance'] : 20;
                document.getElementById('leaveBalance').textContent = balance;
            } catch (error) {
                console.error('Error loading leave balance:', error);
                document.getElementById('leaveBalance').textContent = '--';
            }
        }

        // ========================================
        // LOAD MEDICAL ENTITLEMENT
        // ========================================
        async function loadMedicalEntitlement() {
            try {
                // Use Worker API
                const data = await getEmployee(currentUser.id);
                const medicalBalance = data.fields['Medical Entitlement'] !== undefined ? data.fields['Medical Entitlement'] : 0;
                document.getElementById('medicalBalance').textContent = medicalBalance.toFixed(2);
            } catch (error) {
                console.error('Error loading medical entitlement:', error);
                document.getElementById('medicalBalance').textContent = '--';
            }
        }

        // ========================================
        // LOAD PENDING REQUESTS
        // ========================================
        async function loadPendingRequests() {
            try {
                const filterFormula = `AND(FIND('${currentUser.id}', ARRAYJOIN({Employee})), {Status} = 'Pending')`;

                // Use Worker API
                const data = await getLeaveRequests(filterFormula);
                document.getElementById('pendingRequests').textContent = data.records.length;
            } catch (error) {
                console.error('Error loading pending requests:', error);
                document.getElementById('pendingRequests').textContent = '0';
            }
        }

        // ========================================
        // LOAD ATTENDANCE DATA
        // ========================================
        async function loadAttendanceData() {
            try {
                const filterFormula = `FIND('${currentUser.id}', ARRAYJOIN({Employee}))`;

                // Use Worker API (Note: sort and maxRecords not supported in filter, will filter client-side)
                const data = await getAttendance(filterFormula);
                allAttendanceRecords = data.records;

                renderAttendanceChart(allAttendanceRecords);
            } catch (error) {
                console.error('Error loading attendance data:', error);
            }
        }

        // ========================================
        // RENDER ATTENDANCE CHART
        // ========================================
        function renderAttendanceChart(records) {
            const ctx = document.getElementById('attendanceChart');
            if (!ctx) return;

            // Process data - group by week
            const weeklyData = {};
            records.forEach(record => {
                const date = new Date(record.fields['Date']);
                const weekStart = getWeekStart(date);
                const weekLabel = weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                if (!weeklyData[weekLabel]) {
                    weeklyData[weekLabel] = 0;
                }

                // Calculate hours from Check In and Check Out times
                const checkIn = record.fields['Check In'];
                const checkOut = record.fields['Check Out'];

                if (checkIn && checkOut) {
                    const hours = calculateHoursFromTimes(checkIn, checkOut);
                    weeklyData[weekLabel] += hours;
                }
            });

            // Get last 8 weeks
            const labels = Object.keys(weeklyData).reverse().slice(0, 8).reverse();
            const data = labels.map(label => weeklyData[label].toFixed(1));

            if (attendanceChart) {
                attendanceChart.destroy();
            }

            attendanceChart = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Hours Worked',
                        data: data,
                        backgroundColor: 'rgba(220, 38, 38, 0.7)',
                        borderColor: 'rgba(220, 38, 38, 1)',
                        borderWidth: 1,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y} hours`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + 'h';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Calculate hours from datetime strings
        function calculateHoursFromTimes(checkIn, checkOut) {
            try {
                const start = new Date(checkIn);
                const end = new Date(checkOut);
                const diff = end - start;
                const hours = diff / (1000 * 60 * 60);
                return hours > 0 ? hours : 0;
            } catch (error) {
                return 0;
            }
        }

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day;
            return new Date(d.setDate(diff));
        }

        // ========================================
        // LOAD ANNOUNCEMENTS
        // ========================================
        async function loadAnnouncements() {
            try {
                // Use Worker API (will sort and limit client-side)
                const data = await getAnnouncements();
                const container = document.getElementById('announcementsList');

                if (data.records.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-inbox text-3xl mb-2"></i>
                            <p>No announcements</p>
                        </div>
                    `;
                    return;
                }

                // Sort by date descending and take first 3
                const sortedRecords = data.records
                    .sort((a, b) => new Date(b.fields['Date'] || 0) - new Date(a.fields['Date'] || 0))
                    .slice(0, 3);

                container.innerHTML = sortedRecords.map(record => {
                    const title = record.fields['Title'] || 'Untitled';
                    const message = record.fields['Message'] || '';
                    const date = record.fields['Date'] ? new Date(record.fields['Date']).toLocaleDateString() : '';
                    const priority = record.fields['Priority'] || 'Medium';

                    const priorityColors = {
                        'High': 'bg-red-100 text-red-800',
                        'Medium': 'bg-yellow-100 text-yellow-800',
                        'Low': 'bg-blue-100 text-blue-800'
                    };

                    const borderColors = {
                        'High': 'border-red-500',
                        'Medium': 'border-yellow-500',
                        'Low': 'border-blue-500'
                    };

                    return `
                        <div class="border-l-4 ${borderColors[priority]} bg-gray-50 p-4 rounded-r-lg">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-semibold text-gray-800">${title}</h4>
                                <span class="px-2 py-1 text-xs font-medium rounded-full ${priorityColors[priority]}">${priority} Priority</span>
                            </div>
                            <p class="text-sm text-gray-600 mb-2">${message.substring(0, 100)}${message.length > 100 ? '...' : ''}</p>
                            <p class="text-xs text-gray-500"><i class="fas fa-calendar mr-1"></i>${date}</p>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading announcements:', error);
                document.getElementById('announcementsList').innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <p>Failed to load announcements</p>
                    </div>
                `;
            }
        }

        // ========================================
        // LOAD RECENT ACTIVITY
        // ========================================
        async function loadRecentActivity() {
            try {
                const container = document.getElementById('activityFeed');
                const activities = [];

                // Get recent attendance using Worker API
                const filterFormula = `FIND('${currentUser.id}', ARRAYJOIN({Employee}))`;
                const attendanceData = await getAttendance(filterFormula);

                // Sort by date descending and take first 5
                const recentAttendance = attendanceData.records
                    .sort((a, b) => new Date(b.fields['Date']) - new Date(a.fields['Date']))
                    .slice(0, 5);

                recentAttendance.forEach(record => {
                    const date = record.fields['Date'];
                    const checkIn = record.fields['Check In'];
                    const checkOut = record.fields['Check Out'];

                    if (checkIn) {
                        // Extract time from datetime
                        const checkInTime = new Date(checkIn).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                        const checkOutTime = checkOut ? new Date(checkOut).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) : null;

                        activities.push({
                            type: 'attendance',
                            date: date,
                            icon: 'fa-clock',
                            color: 'text-green-600',
                            text: checkOutTime ? `Checked in at ${checkInTime}, out at ${checkOutTime}` : `Checked in at ${checkInTime}`
                        });
                    }
                });

                // Get recent leave requests using Worker API
                const leaveFilterFormula = `FIND('${currentUser.id}', ARRAYJOIN({Employee}))`;
                const leaveData = await getLeaveRequests(leaveFilterFormula);

                // Sort by createdTime descending and take first 3
                const recentLeave = leaveData.records
                    .sort((a, b) => new Date(b.createdTime) - new Date(a.createdTime))
                    .slice(0, 3);

                recentLeave.forEach(record => {
                    const leaveType = record.fields['Leave Type'];
                    const status = record.fields['Status'];
                    const startDate = record.fields['Start Date'];
                    activities.push({
                        type: 'leave',
                        date: startDate,
                        icon: 'fa-calendar-alt',
                        color: status === 'Approved' ? 'text-green-600' : status === 'Rejected' ? 'text-red-600' : 'text-yellow-600',
                        text: `${leaveType} leave request - ${status}`
                    });
                });

                // Sort by date
                activities.sort((a, b) => new Date(b.date) - new Date(a.date));

                if (activities.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-inbox text-3xl mb-2"></i>
                            <p>No recent activity</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = activities.slice(0, 5).map(activity => {
                    const date = new Date(activity.date);
                    const timeAgo = getTimeAgo(date);

                    return `
                        <div class="flex items-start space-x-3 pb-4 border-b border-gray-200 last:border-0 last:pb-0">
                            <div class="bg-gray-100 rounded-full p-2">
                                <i class="fas ${activity.icon} ${activity.color}"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm text-gray-800">${activity.text}</p>
                                <p class="text-xs text-gray-500 mt-1">${timeAgo}</p>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading recent activity:', error);
                document.getElementById('activityFeed').innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <p>Failed to load activity</p>
                    </div>
                `;
            }
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));

            if (days === 0) return 'Today';
            if (days === 1) return 'Yesterday';
            if (days < 7) return `${days} days ago`;
            if (days < 30) return `${Math.floor(days / 7)} weeks ago`;
            return date.toLocaleDateString();
        }

        // ========================================
        // QUICK CHECK IN
        // ========================================
        async function quickCheckIn() {
            if (!confirm('Are you sure you want to check in now?')) return;

            try {
                const today = new Date().toISOString().split('T')[0];
                const datetime = new Date().toISOString();

                // Try to get location
                let locationString = 'Location unavailable';
                try {
                    if (navigator.geolocation) {
                        const position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject, {
                                enableHighAccuracy: true,
                                timeout: 5000,
                                maximumAge: 0
                            });
                        });
                        locationString = `Lat: ${position.coords.latitude.toFixed(6)}, Lng: ${position.coords.longitude.toFixed(6)} (±${position.coords.accuracy.toFixed(0)}m)`;
                    }
                } catch (locationError) {
                    // Continue without location
                }

                // Use Worker API to create attendance record
                await createAttendance({
                    'Employee': [currentUser.id],
                    'Date': today,
                    'Check In': datetime,
                    'Check In Location': locationString
                });

                alert('Checked in successfully!');
                window.location.reload();
            } catch (error) {
                console.error('Error checking in:', error);
                alert('Failed to check in. Please try again.');
            }
        }

        // ========================================
        // QUICK CHECK OUT
        // ========================================
        async function quickCheckOut() {
            window.location.href = 'attendance-tracker.html';
        }

        // ========================================
        // FILTER ATTENDANCE CHART
        // ========================================
        function filterAttendanceChart() {
            const filter = document.getElementById('attendanceMonthFilter').value;
            let filteredRecords = allAttendanceRecords;

            if (filter === 'current') {
                const now = new Date();
                const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                filteredRecords = allAttendanceRecords.filter(record => {
                    const date = new Date(record.fields['Date']);
                    return date >= firstDay;
                });
            } else if (filter === 'last') {
                const now = new Date();
                const firstDay = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                const lastDay = new Date(now.getFullYear(), now.getMonth(), 0);
                filteredRecords = allAttendanceRecords.filter(record => {
                    const date = new Date(record.fields['Date']);
                    return date >= firstDay && date <= lastDay;
                });
            }

            renderAttendanceChart(filteredRecords);
        }

        // Listen for check-in/check-out events from other tabs/pages
        window.addEventListener('storage', function(e) {
            if (e.key && e.key.startsWith('attendance_session_')) {
                // Attendance record updated, refresh dashboard
                loadTodayStatus();
                loadAttendanceData();
            }
        });

        // Also listen for focus event (when user navigates back to dashboard)
        let lastFocusTime = Date.now();
        window.addEventListener('focus', function() {
            const now = Date.now();
            // Only reload if it's been more than 2 seconds since last focus
            if (now - lastFocusTime > 2000) {
                loadTodayStatus();
                loadAttendanceData();
            }
            lastFocusTime = now;
        });

        // Initialize dashboard on load
        initializeDashboard();

        // ========================================
        // POLICY DOCUMENTS
        // ========================================
        const policyDocuments = {
            'medical-policy': {
                title: 'Staff Medical Policy',
                subtitle: 'Effective Date: January 2025',
                content: `
                    <h2>Medical Coverage Overview</h2>
                    <p>All permanent and contract staff members are entitled to an annual medical allowance of <strong>GH₵1,000</strong> to cover medical expenses incurred during the year.</p>

                    <h3>Eligible Expenses</h3>
                    <ul>
                        <li>Consultation fees at registered hospitals and clinics</li>
                        <li>Prescribed medications and pharmaceutical products</li>
                        <li>Laboratory tests and diagnostic procedures</li>
                        <li>Emergency medical treatment</li>
                        <li>Specialist consultations (with referral)</li>
                    </ul>

                    <h3>Claim Submission Guidelines</h3>
                    <ol>
                        <li>Submit claims within <strong>30 days</strong> of receiving treatment</li>
                        <li>Provide original receipts and invoices</li>
                        <li>Include doctor's prescription (for medication claims)</li>
                        <li>Complete the medical claim form accurately</li>
                        <li>Upload clear copies of all supporting documents</li>
                    </ol>

                    <h3>Exclusions</h3>
                    <p>The following are NOT covered under this policy:</p>
                    <ul>
                        <li>Cosmetic procedures and elective surgery</li>
                        <li>Alternative medicine (unless pre-approved)</li>
                        <li>Treatment outside of Ghana (unless pre-approved)</li>
                        <li>Expenses not supported by valid receipts</li>
                    </ul>

                    <p class="text-sm text-gray-600 mt-4"><em>For questions about medical coverage, please contact the HR department.</em></p>
                `
            },
            'employee-handbook': {
                title: 'Employee Handbook',
                subtitle: 'Last Updated: January 2025',
                content: `
                    <h2>Welcome to Glampack HR</h2>
                    <p>This handbook outlines company policies, procedures, and expectations for all employees.</p>

                    <h3>Working Hours</h3>
                    <ul>
                        <li>Monday to Friday: 8:00 AM - 5:00 PM</li>
                        <li>Lunch Break: 12:00 PM - 1:00 PM</li>
                        <li>Late arrival (after 8:30 AM) must be justified</li>
                    </ul>

                    <h3>Leave Entitlements</h3>
                    <ul>
                        <li><strong>Annual Leave:</strong> 20 working days per year</li>
                        <li><strong>Sick Leave:</strong> 10 days per year (with medical certificate)</li>
                        <li><strong>Emergency Leave:</strong> 3 days per year (subject to approval)</li>
                    </ul>

                    <h3>Code of Conduct</h3>
                    <ol>
                        <li>Maintain professionalism at all times</li>
                        <li>Respect colleagues and company property</li>
                        <li>Adhere to confidentiality agreements</li>
                        <li>Follow health and safety guidelines</li>
                        <li>Report any workplace issues to management</li>
                    </ol>

                    <h3>Performance Reviews</h3>
                    <p>Annual performance reviews are conducted every December. These reviews assess:</p>
                    <ul>
                        <li>Job performance and achievements</li>
                        <li>Attendance and punctuality</li>
                        <li>Team collaboration</li>
                        <li>Professional development goals</li>
                    </ul>

                    <h3>Disciplinary Procedures</h3>
                    <p>Any misconduct will be addressed through our progressive disciplinary system:</p>
                    <ol>
                        <li>Verbal warning</li>
                        <li>Written warning</li>
                        <li>Final written warning</li>
                        <li>Termination (in serious cases)</li>
                    </ol>

                    <p class="text-sm text-gray-600 mt-4"><em>For any concerns or clarifications, please contact HR.</em></p>
                `
            },
            'welfare-guide': {
                title: 'Staff Welfare Guide',
                subtitle: 'Benefits & Support Programs',
                content: `
                    <h2>Employee Welfare Programs</h2>
                    <p>We are committed to the well-being and professional development of all our staff members.</p>

                    <h3>Health & Wellness</h3>
                    <ul>
                        <li><strong>Medical Allowance:</strong> GH₵1,000 annually for approved medical expenses</li>
                        <li><strong>Health Insurance:</strong> Comprehensive health coverage through NHIS</li>
                        <li><strong>Wellness Programs:</strong> Free health screenings and fitness initiatives</li>
                    </ul>

                    <h3>Financial Benefits</h3>
                    <ul>
                        <li><strong>Salary:</strong> Competitive monthly compensation</li>
                        <li><strong>Housing Allowance:</strong> Support for accommodation costs</li>
                        <li><strong>Transport Allowance:</strong> Monthly transportation support</li>
                        <li><strong>13th Month Bonus:</strong> Additional salary payment in December</li>
                    </ul>

                    <h3>Professional Development</h3>
                    <ul>
                        <li><strong>Training Programs:</strong> Skills development workshops</li>
                        <li><strong>Career Advancement:</strong> Internal promotion opportunities</li>
                        <li><strong>Mentorship:</strong> Guidance from senior staff members</li>
                        <li><strong>Conference Attendance:</strong> Industry events and networking</li>
                    </ul>

                    <h3>Work-Life Balance</h3>
                    <ul>
                        <li><strong>Flexible Working:</strong> Remote work options (subject to approval)</li>
                        <li><strong>Parental Leave:</strong> Maternity/Paternity leave provisions</li>
                        <li><strong>Bereavement Leave:</strong> Compassionate leave for family emergencies</li>
                    </ul>

                    <h3>Employee Assistance</h3>
                    <ul>
                        <li><strong>Counseling Services:</strong> Confidential support for personal issues</li>
                        <li><strong>Loan Facilities:</strong> Emergency financial assistance</li>
                        <li><strong>Social Events:</strong> Team building and company celebrations</li>
                    </ul>

                    <h3>Contact HR for Support</h3>
                    <p>If you need assistance with any welfare matter:</p>
                    <ul>
                        <li>Email: hr@packglamour.com</li>
                        <li>Internal Extension: 100</li>
                        <li>Office Hours: Monday - Friday, 9:00 AM - 4:00 PM</li>
                    </ul>

                    <p class="text-sm text-gray-600 mt-4"><em>Your well-being is our priority. Don't hesitate to reach out for support.</em></p>
                `
            }
        };

        function openPolicyDocument(documentId) {
            const doc = policyDocuments[documentId];
            if (!doc) return;

            document.getElementById('policyTitle').textContent = doc.title;
            document.getElementById('policySubtitle').textContent = doc.subtitle;
            document.getElementById('policyContent').innerHTML = doc.content;

            const modal = document.getElementById('policyModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closePolicyModal() {
            const modal = document.getElementById('policyModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // Close modal on outside click
        document.getElementById('policyModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closePolicyModal();
            }
        });
    </script>
</body>
</html>
