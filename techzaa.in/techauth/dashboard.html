<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Glampack HR</title>

    <!-- Tailwind CSS (Local) -->
    <link rel="stylesheet" href="assets/css/tailwind.css" />

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body class="bg-gray-50">
    <!-- Navigation Header -->
    <header class="bg-white shadow-md sticky top-0 z-50">
      <div class="container mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
          <!-- Logo -->
          <div class="flex items-center space-x-3">
            <img src="assets/images/logo_red.png" alt="Logo" class="h-10" />
          </div>

          <!-- Navigation Menu -->
          <div class="flex items-center space-x-4">
            <a
              href="dashboard.html"
              class="text-red-600 hover:text-red-600 font-semibold"
            >
              <i class="fas fa-chart-line mr-1"></i> Dashboard
            </a>
            <a
              href="attendance-tracker.html"
              class="text-gray-600 hover:text-red-600"
            >
              <i class="fas fa-clock mr-1"></i> Attendance
            </a>
            <a
              href="leave-request.html"
              class="text-gray-600 hover:text-red-600"
            >
              <i class="fas fa-calendar-alt mr-1"></i> Leave
            </a>
            <a
              href="medical-claims.html"
              class="text-gray-600 hover:text-red-600"
            >
              <i class="fas fa-notes-medical mr-1"></i> Medical Claims
            </a>
            <a href="profile.html" class="text-gray-600 hover:text-red-600">
              <i class="fas fa-user mr-1"></i> Profile
            </a>
            <a
              href="announcements.html"
              class="text-gray-600 hover:text-red-600"
            >
              <i class="fas fa-bullhorn mr-1"></i> Announcements
            </a>
            <a href="payroll.html" class="text-gray-600 hover:text-red-600">
              <i class="fas fa-money-bill-wave mr-1"></i> Payroll
            </a>
            <a
              href="admin-dashboard.html"
              id="adminLink"
              class="text-gray-600 hover:text-red-600"
              style="display: none"
            >
              <i class="fas fa-user-shield mr-1"></i> Admin
            </a>
            <button onclick="logout()" class="text-gray-600 hover:text-red-600">
              <i class="fas fa-sign-out-alt mr-1"></i> Logout
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
      <!-- Welcome Section -->
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800">
          Welcome back, <span id="userName">Employee</span>!
        </h1>
        <p class="text-gray-600 mt-2">Here's what's happening today</p>
      </div>

      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
        <!-- Today's Status -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-500 text-sm">Today's Status</p>
              <h3
                class="text-2xl font-bold text-gray-800 mt-1"
                id="todayStatus"
              >
                --
              </h3>
              <p class="text-gray-600 text-sm mt-1" id="checkInTime">--</p>
            </div>
            <div class="bg-green-100 p-3 rounded-full">
              <i class="fas fa-clock text-green-600 text-2xl"></i>
            </div>
          </div>
        </div>

        <!-- Monthly Hours -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-500 text-sm">Monthly Hours</p>
              <h3
                class="text-2xl font-bold text-gray-800 mt-1"
                id="monthlyHours"
              >
                0
              </h3>
              <p class="text-gray-600 text-sm mt-1">This month</p>
            </div>
            <div class="bg-blue-100 p-3 rounded-full">
              <i class="fas fa-business-time text-blue-600 text-2xl"></i>
            </div>
          </div>
        </div>

        <!-- Leave Balance -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-500 text-sm">Leave Balance</p>
              <h3
                class="text-2xl font-bold text-gray-800 mt-1"
                id="leaveBalance"
              >
                --
              </h3>
              <p class="text-gray-600 text-sm mt-1">Days remaining</p>
            </div>
            <div class="bg-yellow-100 p-3 rounded-full">
              <i class="fas fa-calendar-alt text-yellow-600 text-2xl"></i>
            </div>
          </div>
        </div>

        <!-- Medical Claims -->
        <div class="bg-white rounded-lg shadow-md p-6 cursor-pointer hover:shadow-lg transition-shadow" onclick="window.location.href='medical-claims.html'">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-500 text-sm">Medical Claims</p>
              <h3
                class="text-2xl font-bold text-gray-800 mt-1"
                id="medicalClaimsCount"
              >
                0
              </h3>
              <p class="text-gray-600 text-sm mt-1">Pending claims</p>
            </div>
            <div class="bg-teal-100 p-3 rounded-full">
              <i class="fas fa-file-medical text-teal-600 text-2xl"></i>
            </div>
          </div>
        </div>

        <!-- Pending Requests -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-500 text-sm">Pending Requests</p>
              <h3
                class="text-2xl font-bold text-gray-800 mt-1"
                id="pendingRequests"
              >
                0
              </h3>
              <p class="text-gray-600 text-sm mt-1">Awaiting approval</p>
            </div>
            <div class="bg-purple-100 p-3 rounded-full">
              <i class="fas fa-hourglass-half text-purple-600 text-2xl"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts and Activity Section -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <!-- Attendance Chart -->
        <div class="lg:col-span-2 bg-white rounded-lg shadow-md p-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">
            <i class="fas fa-chart-bar mr-2"></i>Attendance Overview
          </h3>
          <canvas id="attendanceChart" height="100"></canvas>
        </div>

        <!-- Recent Activity -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">
            <i class="fas fa-history mr-2"></i>Recent Activity
          </h3>
          <div id="activityFeed" class="space-y-4 max-h-80 overflow-y-auto">
            <div class="text-center text-gray-500 py-8">
              <i class="fas fa-spinner fa-spin text-2xl"></i>
              <p class="mt-2">Loading activities...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
          <i class="fas fa-bolt mr-2"></i>Quick Actions
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <a
            href="attendance-tracker.html"
            class="flex flex-col items-center justify-center bg-green-500 hover:bg-green-600 text-white rounded-lg p-6 text-center transition-colors shadow-md"
          >
            <i class="fas fa-sign-in-alt text-3xl mb-3 block"></i>
            <p class="font-semibold text-base">Check In/Out</p>
          </a>
          <a
            href="leave-request.html"
            class="flex flex-col items-center justify-center bg-blue-500 hover:bg-blue-600 text-white rounded-lg p-6 text-center transition-colors shadow-md"
          >
            <i class="fas fa-calendar-plus text-3xl mb-3 block"></i>
            <p class="font-semibold text-base">Request Leave</p>
          </a>
          <a
            href="medical-claims.html"
            class="flex flex-col items-center justify-center bg-purple-500 hover:bg-purple-600 text-white rounded-lg p-6 text-center transition-colors shadow-md"
          >
            <i class="fas fa-file-medical text-3xl mb-3 block"></i>
            <p class="font-semibold text-base">Medical Claim</p>
          </a>
          <a
            href="profile.html"
            class="flex flex-col items-center justify-center bg-orange-500 hover:bg-orange-600 text-white rounded-lg p-6 text-center transition-colors shadow-md"
          >
            <i class="fas fa-user-edit text-3xl mb-3 block"></i>
            <p class="font-semibold text-base">Update Profile</p>
          </a>
        </div>
      </div>

      <!-- Announcements -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-gray-800">
            <i class="fas fa-bullhorn mr-2"></i>Latest Announcements
          </h3>
          <a
            href="announcements.html"
            class="text-red-600 hover:text-red-700 text-sm"
          >
            View All <i class="fas fa-arrow-right ml-1"></i>
          </a>
        </div>
        <div id="announcementsList" class="space-y-3">
          <div class="text-center text-gray-500 py-8">
            <i class="fas fa-spinner fa-spin text-2xl"></i>
            <p class="mt-2">Loading announcements...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="config-worker.js?v=2"></script>
    <script>
      // Authentication check
      const currentUser = JSON.parse(sessionStorage.getItem("currentUser"));
      if (!currentUser) {
        window.location.href = "index.html";
      }

      // Logout function
      function logout() {
        sessionStorage.removeItem("currentUser");
        window.location.href = "index.html";
      }

      // Chart instance
      let attendanceChart = null;
      let allAttendanceRecords = [];

      // ========================================
      // INITIALIZE DASHBOARD
      // ========================================
      async function initializeDashboard() {
        // Display user name with null check
        const userNameElement = document.getElementById("userName");
        if (userNameElement) {
          userNameElement.textContent = currentUser.name.split(" ")[0];
        }

        // Show admin link if user is admin
        const adminLink = document.getElementById("adminLink");
        if (currentUser.role === "Admin" && adminLink) {
          adminLink.style.display = "inline-block";
        }

        // Load all dashboard data
        await Promise.all([
          loadTodayStatus(),
          loadMonthlyHours(),
          loadLeaveBalance(),
          loadPendingRequests(),
          loadMedicalClaimsCount(),
          loadAttendanceData(),
          loadAnnouncements(),
          loadRecentActivity(),
        ]);
      }

      // ========================================
      // LOAD TODAY'S STATUS
      // ========================================
      async function loadTodayStatus() {
        try {
          const today = new Date().toISOString().split("T")[0];

          console.log('=== LOAD TODAY STATUS ===');
          console.log('Looking for date:', today);
          console.log('Employee ID:', currentUser.id);
          console.log('Employee Name:', currentUser.name);

          // First, get ALL attendance records for this employee to see what dates exist
          const allRecordsFormula = `SEARCH('${currentUser.id}', ARRAYJOIN({Employee})) > 0`;
          const allData = await getAttendance(allRecordsFormula);

          console.log('Total attendance records for this employee:', allData.records?.length || 0);
          if (allData.records && allData.records.length > 0) {
            const dates = allData.records.map(r => r.fields.Date).filter(d => d);
            console.log('All attendance dates found:', dates);
            console.log('Most recent 5 dates:', dates.slice(-5));
          }

          // Now look for today's specific record
          const filterFormula = `AND(SEARCH('${currentUser.id}', ARRAYJOIN({Employee})) > 0, {Date} = '${today}')`;
          const data = await getAttendance(filterFormula);

          console.log('Records for today:', data.records?.length || 0);

          if (data.records && data.records.length > 0) {
            const record = data.records[0];
            const checkIn = record.fields["Check In"];
            const checkOut = record.fields["Check Out"];

            console.log('Today record - Check In:', checkIn, 'Check Out:', checkOut);

            if (checkOut) {
              document.getElementById("todayStatus").textContent =
                "Checked Out";
              document.getElementById("checkInTime").textContent =
                `${checkIn} - ${checkOut}`;
            } else if (checkIn) {
              document.getElementById("todayStatus").textContent = "Checked In";
              document.getElementById("checkInTime").textContent =
                `Since ${checkIn}`;
            } else {
              document.getElementById("todayStatus").textContent =
                "Not Checked In";
              document.getElementById("checkInTime").textContent =
                "No record today";
            }
          } else {
            console.log('No attendance record found for today. Please check in at attendance-tracker.html');
            document.getElementById("todayStatus").textContent =
              "Not Checked In";
            document.getElementById("checkInTime").textContent =
              "No record today";
          }
        } catch (error) {
          console.error("Error loading today status:", error);
          console.error("Error details:", error.message, error.stack);
          document.getElementById("todayStatus").textContent = "--";
          document.getElementById("checkInTime").textContent = "Error loading status";
        }
      }

      // ========================================
      // LOAD MONTHLY HOURS
      // ========================================
      async function loadMonthlyHours() {
        try {
          // Get first and last day of current month
          const now = new Date();
          const year = now.getFullYear();
          const month = now.getMonth() + 1; // JavaScript months are 0-indexed
          const yearMonth = `${year}-${month.toString().padStart(2, '0')}`;

          console.log('Loading monthly hours for:', yearMonth);

          // Get all attendance records for this employee
          const filterFormula = `SEARCH('${currentUser.id}', ARRAYJOIN({Employee})) > 0`;
          const data = await getAttendance(filterFormula);

          console.log('Total attendance records found:', data.records?.length || 0);

          let totalHours = 0;
          let recordsThisMonth = 0;

          if (data.records) {
            data.records.forEach((record) => {
              const recordDate = record.fields["Date"];

              // Check if record is from current month
              if (recordDate && recordDate.startsWith(yearMonth)) {
                const checkIn = record.fields["Check In"];
                const checkOut = record.fields["Check Out"];

                if (checkIn && checkOut) {
                  const hours = calculateHoursFromTimes(checkIn, checkOut);
                  totalHours += hours;
                  recordsThisMonth++;
                  console.log(`Record ${recordDate}: ${checkIn} - ${checkOut} = ${hours.toFixed(2)} hours`);
                }
              }
            });
          }

          console.log(`Total: ${recordsThisMonth} records, ${totalHours.toFixed(1)} hours`);
          document.getElementById("monthlyHours").textContent = totalHours.toFixed(1);
        } catch (error) {
          console.error("Error loading monthly hours:", error);
          document.getElementById("monthlyHours").textContent = "0";
        }
      }

      // ========================================
      // CALCULATE HOURS FROM TIMES
      // ========================================
      function calculateHoursFromTimes(checkIn, checkOut) {
        try {
          const checkInTime = new Date(`2000-01-01T${checkIn}`);
          const checkOutTime = new Date(`2000-01-01T${checkOut}`);
          const diffMs = checkOutTime - checkInTime;
          return diffMs / (1000 * 60 * 60); // Convert to hours
        } catch (error) {
          return 0;
        }
      }

      // ========================================
      // LOAD LEAVE BALANCE
      // ========================================
      async function loadLeaveBalance() {
        try {
          const data = await getEmployee(currentUser.id);
          const balance =
            data.fields["Annual Leave Balance"] !== undefined
              ? data.fields["Annual Leave Balance"]
              : 20;
          document.getElementById("leaveBalance").textContent = balance;
        } catch (error) {
          console.error("Error loading leave balance:", error);
          document.getElementById("leaveBalance").textContent = "--";
        }
      }

      // ========================================
      // LOAD PENDING REQUESTS
      // ========================================
      async function loadPendingRequests() {
        try {
          // Fetch all leave requests and filter client-side
          const data = await getLeaveRequests(null);

          // Filter for this employee's pending requests
          const pendingRequests = (data.records || []).filter((record) => {
            const employees = record.fields.Employee || [];
            const isPending = record.fields.Status === "Pending";
            return employees.includes(currentUser.id) && isPending;
          });

          document.getElementById("pendingRequests").textContent =
            pendingRequests.length;
        } catch (error) {
          console.error("Error loading pending requests:", error);
          document.getElementById("pendingRequests").textContent = "0";
        }
      }

      // ========================================
      // LOAD MEDICAL CLAIMS COUNT
      // ========================================
      async function loadMedicalClaimsCount() {
        try {
          // Fetch medical claims for this employee
          const filterFormula = `SEARCH('${currentUser.id}', ARRAYJOIN({Employee})) > 0`;
          const data = await getMedicalClaims(filterFormula);

          // Count pending claims
          const pendingClaims = (data.records || []).filter((record) => {
            const status = record.fields.Status || 'Pending';
            return status === 'Pending';
          });

          document.getElementById("medicalClaimsCount").textContent =
            pendingClaims.length;
        } catch (error) {
          console.error("Error loading medical claims count:", error);
          document.getElementById("medicalClaimsCount").textContent = "0";
        }
      }

      // ========================================
      // LOAD ATTENDANCE DATA
      // ========================================
      async function loadAttendanceData() {
        try {
          const filterFormula = `SEARCH('${currentUser.id}', ARRAYJOIN({Employee})) > 0`;

          const data = await getAttendance(filterFormula);
          allAttendanceRecords = data.records;

          renderAttendanceChart(allAttendanceRecords);
        } catch (error) {
          console.error("Error loading attendance data:", error);
        }
      }

      // ========================================
      // RENDER ATTENDANCE CHART
      // ========================================
      function renderAttendanceChart(records) {
        const ctx = document.getElementById("attendanceChart");
        if (!ctx) return;

        // Process data - last 7 days
        const last7Days = [];
        const hoursWorked = [];
        const today = new Date();

        for (let i = 6; i >= 0; i--) {
          const date = new Date(today);
          date.setDate(date.getDate() - i);
          const dateStr = date.toISOString().split("T")[0];
          const dayLabel = date.toLocaleDateString("en-US", {
            weekday: "short",
          });

          last7Days.push(dayLabel);

          // Find record for this date
          const record = records.find((r) => r.fields["Date"] === dateStr);

          if (record) {
            const checkIn = record.fields["Check In"];
            const checkOut = record.fields["Check Out"];

            if (checkIn && checkOut) {
              const hours = calculateHoursFromTimes(checkIn, checkOut);
              hoursWorked.push(hours);
            } else {
              hoursWorked.push(0);
            }
          } else {
            hoursWorked.push(0);
          }
        }

        // Destroy existing chart
        if (attendanceChart) {
          attendanceChart.destroy();
        }

        // Create new chart
        attendanceChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: last7Days,
            datasets: [
              {
                label: "Hours Worked",
                data: hoursWorked,
                backgroundColor: "rgba(239, 68, 68, 0.5)",
                borderColor: "rgba(239, 68, 68, 1)",
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "Hours",
                },
              },
            },
            plugins: {
              legend: {
                display: true,
                position: "top",
              },
            },
          },
        });
      }

      // ========================================
      // LOAD ANNOUNCEMENTS
      // ========================================
      async function loadAnnouncements() {
        try {
          const data = await getAnnouncements(null);

          // Sort by date descending and take first 3
          const recentAnnouncements = (data.records || [])
            .sort((a, b) => new Date(b.fields.Date) - new Date(a.fields.Date))
            .slice(0, 3);

          const container = document.getElementById("announcementsList");

          if (recentAnnouncements.length === 0) {
            container.innerHTML = `
              <div class="text-center text-gray-500 py-4">
                <i class="fas fa-inbox text-3xl mb-2"></i>
                <p>No announcements yet</p>
              </div>
            `;
            return;
          }

          container.innerHTML = recentAnnouncements
            .map(
              (announcement) => `
            <div class="border-l-4 ${getAnnouncementColor(
              announcement.fields.Type
            )} bg-gray-50 p-4 rounded">
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <h4 class="font-semibold text-gray-800">${
                    announcement.fields.Title
                  }</h4>
                  <p class="text-gray-600 text-sm mt-1">${announcement.fields.Message.substring(
                    0,
                    100
                  )}${announcement.fields.Message.length > 100 ? "..." : ""}</p>
                  <div class="flex items-center gap-3 mt-2 text-xs text-gray-500">
                    <span><i class="fas fa-tag mr-1"></i>${
                      announcement.fields.Type
                    }</span>
                    <span><i class="fas fa-calendar mr-1"></i>${new Date(
                      announcement.fields.Date
                    ).toLocaleDateString()}</span>
                  </div>
                </div>
              </div>
            </div>
          `
            )
            .join("");
        } catch (error) {
          console.error("Error loading announcements:", error);
          document.getElementById("announcementsList").innerHTML = `
            <div class="text-center text-red-500 py-4">
              <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
              <p>Failed to load announcements</p>
            </div>
          `;
        }
      }

      // ========================================
      // GET ANNOUNCEMENT COLOR
      // ========================================
      function getAnnouncementColor(type) {
        const colors = {
          Urgent: "border-red-500",
          HR: "border-blue-500",
          General: "border-gray-500",
          Event: "border-green-500",
          Policy: "border-purple-500",
        };
        return colors[type] || "border-gray-500";
      }

      // ========================================
      // LOAD RECENT ACTIVITY
      // ========================================
      async function loadRecentActivity() {
        try {
          const container = document.getElementById("activityFeed");
          const activities = [];

          // Get recent attendance
          const filterFormula = `SEARCH('${currentUser.id}', ARRAYJOIN({Employee})) > 0`;
          const attendanceData = await getAttendance(filterFormula);

          // Sort by date descending and take first 3
          const recentAttendance = attendanceData.records
            .sort(
              (a, b) => new Date(b.fields["Date"]) - new Date(a.fields["Date"])
            )
            .slice(0, 3);

          recentAttendance.forEach((record) => {
            const date = record.fields["Date"];
            const checkIn = record.fields["Check In"];
            const checkOut = record.fields["Check Out"];

            if (checkIn) {
              activities.push({
                type: "attendance",
                date: date,
                icon: "fa-clock",
                color: "text-green-600",
                text: checkOut
                  ? `Checked in at ${checkIn}, out at ${checkOut}`
                  : `Checked in at ${checkIn}`,
              });
            }
          });

          // Get recent leave requests
          const leaveData = await getLeaveRequests(null);

          // Filter for this employee's leave requests, sort and take first 2
          const recentLeave = (leaveData.records || [])
            .filter((record) => {
              const employees = record.fields.Employee || [];
              return employees.includes(currentUser.id);
            })
            .sort((a, b) => new Date(b.createdTime) - new Date(a.createdTime))
            .slice(0, 2);

          recentLeave.forEach((record) => {
            const leaveType = record.fields["Leave Type"];
            const status = record.fields["Status"];
            const startDate = record.fields["Start Date"];
            activities.push({
              type: "leave",
              date: startDate,
              icon: "fa-calendar-alt",
              color:
                status === "Approved"
                  ? "text-green-600"
                  : status === "Rejected"
                    ? "text-red-600"
                    : "text-yellow-600",
              text: `${leaveType} - ${status}`,
            });
          });

          // Sort all activities by date
          activities.sort((a, b) => new Date(b.date) - new Date(a.date));

          // Render activities
          if (activities.length === 0) {
            container.innerHTML = `
              <div class="text-center text-gray-500 py-4">
                <i class="fas fa-inbox text-2xl mb-2"></i>
                <p>No recent activity</p>
              </div>
            `;
            return;
          }

          container.innerHTML = activities
            .slice(0, 5)
            .map(
              (activity) => `
            <div class="flex items-start gap-3 pb-3 border-b border-gray-100 last:border-0">
              <div class="bg-gray-100 p-2 rounded-full">
                <i class="fas ${activity.icon} ${activity.color}"></i>
              </div>
              <div class="flex-1">
                <p class="text-sm text-gray-800">${activity.text}</p>
                <p class="text-xs text-gray-500 mt-1">
                  ${new Date(activity.date).toLocaleDateString()}
                </p>
              </div>
            </div>
          `
            )
            .join("");
        } catch (error) {
          console.error("Error loading recent activity:", error);
          document.getElementById("activityFeed").innerHTML = `
            <div class="text-center text-red-500 py-4">
              <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
              <p>Failed to load activities</p>
            </div>
          `;
        }
      }

      // ========================================
      // AUTO-REFRESH ON ATTENDANCE UPDATE
      // ========================================
      let lastAttendanceCheck = localStorage.getItem('attendanceUpdated') || '0';

      // Listen for storage changes (works across tabs)
      window.addEventListener('storage', function(e) {
        if (e.key === 'attendanceUpdated' && e.newValue !== lastAttendanceCheck) {
          lastAttendanceCheck = e.newValue;
          refreshAttendanceData();
        }
      });

      // Poll for changes every 3 seconds (works within same tab)
      setInterval(function() {
        const currentValue = localStorage.getItem('attendanceUpdated') || '0';
        if (currentValue !== lastAttendanceCheck) {
          lastAttendanceCheck = currentValue;
          refreshAttendanceData();
        }
      }, 3000);

      // Refresh only attendance-related data
      async function refreshAttendanceData() {
        await Promise.all([
          loadTodayStatus(),
          loadMonthlyHours(),
          loadAttendanceData(),
          loadRecentActivity(),
        ]);
      }

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", initializeDashboard);
    </script>
  </body>
</html>
