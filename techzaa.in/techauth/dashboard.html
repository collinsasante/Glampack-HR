<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Packaging Glamour HR</title>

    <!-- Tailwind CSS (Local) -->
    <link rel="stylesheet" href="assets/css/tailwind.css" />

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Chart.js for charts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>

    <!-- Authentication Script -->
    <script src="auth.js"></script>

    <!-- Worker API Configuration -->
    <script src="config-worker.js"></script>

    <style>
        body {
            font-family: 'Montserrat', sans-serif;
        }
        .stat-card {
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        .pulse-dot {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        /* Mobile Menu Styles */
        #mobileMenu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }

        #mobileMenu.open {
            max-height: 500px;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            #desktopMenu {
                display: none;
            }

            #mobileMenuButton {
                display: block;
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Navigation Bar -->
    <nav class="bg-white shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold text-red-600">HR System</h1>
                    <span class="text-gray-600 hidden md:inline" id="userInfo"></span>
                </div>

                <!-- Desktop Menu -->
                <div id="desktopMenu" class="hidden md:flex items-center space-x-4">
                    <a href="dashboard.html" class="text-red-600 font-semibold">
                        <i class="fas fa-chart-line mr-1"></i> Dashboard
                    </a>
                    <a href="attendance-tracker.html" class="text-gray-600 hover:text-red-600">
                        <i class="fas fa-clock mr-1"></i> Attendance
                    </a>
                    <a href="leave-request.html" class="text-gray-600 hover:text-red-600">
                        <i class="fas fa-calendar-alt mr-1"></i> Leave
                    </a>
                    <a href="profile.html" class="text-gray-600 hover:text-red-600">
                        <i class="fas fa-user mr-1"></i> Profile
                    </a>
                    <a href="announcements.html" class="text-gray-600 hover:text-red-600">
                        <i class="fas fa-bullhorn mr-1"></i> Announcements
                    </a>
                    <a href="payroll.html" class="text-gray-600 hover:text-red-600">
                        <i class="fas fa-money-bill-wave mr-1"></i> Payroll
                    </a>
                    <a href="admin-dashboard.html" id="adminLink" class="text-gray-600 hover:text-red-600" style="display: none;">
                        <i class="fas fa-user-shield mr-1"></i> Admin
                    </a>
                    <button onclick="logout()" class="text-gray-600 hover:text-red-600">
                        <i class="fas fa-sign-out-alt mr-1"></i> Logout
                    </button>
                </div>

                <!-- Mobile Menu Button -->
                <button id="mobileMenuButton" class="md:hidden text-gray-600 hover:text-red-600 text-2xl" onclick="toggleMobileMenu()">
                    <i class="fas fa-bars"></i>
                </button>
            </div>

            <!-- Mobile Menu -->
            <div id="mobileMenu" class="md:hidden">
                <div class="flex flex-col space-y-2 pb-4">
                    <span class="text-gray-600 text-sm border-b pb-2" id="userInfoMobile"></span>
                    <a href="dashboard.html" class="text-red-600 font-semibold py-2">
                        <i class="fas fa-chart-line mr-2"></i> Dashboard
                    </a>
                    <a href="attendance-tracker.html" class="text-gray-600 hover:text-red-600 py-2">
                        <i class="fas fa-clock mr-2"></i> Attendance
                    </a>
                    <a href="leave-request.html" class="text-gray-600 hover:text-red-600 py-2">
                        <i class="fas fa-calendar-alt mr-2"></i> Leave
                    </a>
                    <a href="profile.html" class="text-gray-600 hover:text-red-600 py-2">
                        <i class="fas fa-user mr-2"></i> Profile
                    </a>
                    <a href="announcements.html" class="text-gray-600 hover:text-red-600 py-2">
                        <i class="fas fa-bullhorn mr-2"></i> Announcements
                    </a>
                    <a href="payroll.html" class="text-gray-600 hover:text-red-600 py-2">
                        <i class="fas fa-money-bill-wave mr-2"></i> Payroll
                    </a>
                    <button onclick="logout()" class="text-gray-600 hover:text-red-600 py-2 text-left">
                        <i class="fas fa-sign-out-alt mr-2"></i> Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">

        <!-- Welcome Header -->
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-800">Welcome back, <span id="userName">User</span>!</h2>
            <p class="text-gray-600 mt-1">Here's what's happening with your work today.</p>
        </div>

        <!-- Quick Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Today's Status -->
            <div class="bg-white rounded-lg shadow-md p-6 stat-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Today's Status</p>
                        <h3 class="text-2xl font-bold text-green-600 mt-2" id="todayStatus">--</h3>
                        <p class="text-xs text-gray-500 mt-1" id="checkInTime">--</p>
                    </div>
                    <div class="bg-green-100 rounded-full p-4">
                        <i class="fas fa-check-circle text-green-600 text-2xl"></i>
                    </div>
                </div>
            </div>

            <!-- Hours This Month -->
            <div class="bg-white rounded-lg shadow-md p-6 stat-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Hours This Month</p>
                        <h3 class="text-2xl font-bold text-blue-600 mt-2" id="monthlyHours">0</h3>
                        <p class="text-xs text-gray-500 mt-1">of 160 hours</p>
                    </div>
                    <div class="bg-blue-100 rounded-full p-4">
                        <i class="fas fa-clock text-blue-600 text-2xl"></i>
                    </div>
                </div>
            </div>

            <!-- Leave Balance -->
            <div class="bg-white rounded-lg shadow-md p-6 stat-card cursor-pointer" onclick="window.location.href='leave-request.html'">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Leave Balance</p>
                        <h3 class="text-2xl font-bold text-purple-600 mt-2" id="leaveBalance">--</h3>
                        <p class="text-xs text-gray-500 mt-1">days remaining</p>
                    </div>
                    <div class="bg-purple-100 rounded-full p-4">
                        <i class="fas fa-umbrella-beach text-purple-600 text-2xl"></i>
                    </div>
                </div>
            </div>

            <!-- Pending Requests -->
            <div class="bg-white rounded-lg shadow-md p-6 stat-card cursor-pointer" onclick="window.location.href='leave-request.html'">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Pending Requests</p>
                        <h3 class="text-2xl font-bold text-yellow-600 mt-2" id="pendingRequests">0</h3>
                        <p class="text-xs text-gray-500 mt-1">awaiting approval</p>
                    </div>
                    <div class="bg-yellow-100 rounded-full p-4">
                        <i class="fas fa-hourglass-half text-yellow-600 text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Attendance Overview -->
            <div class="lg:col-span-2 bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Attendance Overview</h3>
                    <select id="attendanceMonthFilter" onchange="filterAttendanceChart()" class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-red-500">
                        <option value="current">This Month</option>
                        <option value="last">Last Month</option>
                        <option value="all">All Time</option>
                    </select>
                </div>
                <div class="relative" style="height: 300px;">
                    <canvas id="attendanceChart"></canvas>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-6">Quick Actions</h3>
                <div class="space-y-3">
                    <button onclick="window.location.href='attendance-tracker.html'" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg transition flex items-center justify-center">
                        <i class="fas fa-clock mr-2"></i> Attendance
                    </button>
                    <button onclick="window.location.href='leave-request.html'" class="w-full bg-red-600 hover:bg-red-700 text-white font-medium py-3 px-4 rounded-lg transition flex items-center justify-center">
                        <i class="fas fa-calendar-plus mr-2"></i> Request Leave
                    </button>
                    <button onclick="window.location.href='profile.html'" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-medium py-3 px-4 rounded-lg transition flex items-center justify-center">
                        <i class="fas fa-user-edit mr-2"></i> Update Profile
                    </button>
                    <button onclick="window.location.href='payroll.html'" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg transition flex items-center justify-center">
                        <i class="fas fa-receipt mr-2"></i> View Payslip
                    </button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Recent Announcements -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Recent Announcements</h3>
                    <a href="announcements.html" class="text-red-600 hover:text-red-700 text-sm font-medium">View All <i class="fas fa-arrow-right ml-1"></i></a>
                </div>
                <div id="announcementsList" class="space-y-4">
                    <!-- Loading State -->
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>Loading announcements...</p>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-6">Recent Activity</h3>
                <div id="activityFeed" class="space-y-4">
                    <!-- Loading State -->
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>Loading activity...</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Birthday Announcement Modal -->
    <div id="birthdayModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="bg-gradient-to-r from-pink-500 to-purple-600 p-6 text-white relative">
                <button onclick="closeBirthdayModal()" class="absolute top-4 right-4 text-white hover:text-gray-200">
                    <i class="fas fa-times text-2xl"></i>
                </button>
                <div class="text-center">
                    <i class="fas fa-birthday-cake text-6xl mb-4"></i>
                    <h2 class="text-3xl font-bold">ðŸŽ‰ Birthday Celebration! ðŸŽ‰</h2>
                    <p class="mt-2">Someone special is celebrating today!</p>
                </div>
            </div>

            <div class="p-6">
                <div id="birthdayList" class="space-y-4">
                    <!-- Birthday cards will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // MOBILE MENU TOGGLE
        // ========================================
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            const menuButton = document.getElementById('mobileMenuButton');
            const icon = menuButton.querySelector('i');

            mobileMenu.classList.toggle('open');

            // Toggle icon between bars and times
            if (mobileMenu.classList.contains('open')) {
                icon.classList.remove('fa-bars');
                icon.classList.add('fa-times');
            } else {
                icon.classList.remove('fa-times');
                icon.classList.add('fa-bars');
            }
        }

        // ========================================
        // AUTHENTICATION CHECK
        // ========================================
        if (!requireAuth()) {
            // Will redirect automatically
        }

        const currentUser = getCurrentUser();

        let attendanceChart = null;
        let allAttendanceRecords = [];

        // ========================================
        // INITIALIZE DASHBOARD
        // ========================================
        async function initializeDashboard() {
            // Display user name for both desktop and mobile
            document.getElementById('userName').textContent = currentUser.name.split(' ')[0];
            const userInfoText = `Welcome, ${currentUser.name}`;
            document.getElementById('userInfo').textContent = userInfoText;
            document.getElementById('userInfoMobile').textContent = userInfoText;

            // Show admin link if user is admin
            if (currentUser.role === 'Admin') {
                document.getElementById('adminLink').style.display = 'inline-block';
            }

            // Load all data
            await Promise.all([
                loadTodayStatus(),
                loadMonthlyHours(),
                loadLeaveBalance(),
                loadPendingRequests(),
                loadAttendanceData(),
                loadAnnouncements(),
                loadRecentActivity()
            ]);

            // Check for birthdays after loading data
            await checkBirthdays();
        }

        // ========================================
        // BIRTHDAY MODAL FUNCTIONS
        // ========================================
        function closeBirthdayModal() {
            document.getElementById('birthdayModal').classList.add('hidden');
        }

        async function checkBirthdays() {
            try {
                // Get all employees
                const data = await getEmployees();
                const today = new Date();
                const todayMonth = String(today.getMonth() + 1).padStart(2, '0');
                const todayDay = String(today.getDate()).padStart(2, '0');

                // Find employees with birthdays today
                const birthdayPeople = [];
                if (data.records) {
                    for (const record of data.records) {
                        const dateOfBirth = record.fields['Date of Birth'];
                        if (dateOfBirth) {
                            const birthDate = new Date(dateOfBirth);
                            const birthMonth = String(birthDate.getMonth() + 1).padStart(2, '0');
                            const birthDay = String(birthDate.getDate()).padStart(2, '0');

                            if (birthMonth === todayMonth && birthDay === todayDay) {
                                birthdayPeople.push({
                                    id: record.id,
                                    name: record.fields['Full Name'],
                                    role: record.fields['Role'] || 'Employee',
                                    status: record.fields['Status'] || ''
                                });
                            }
                        }
                    }
                }

                // Show birthday modal if there are birthdays
                if (birthdayPeople.length > 0) {
                    showBirthdayModal(birthdayPeople);
                }
            } catch (error) {
                console.error('Error checking birthdays:', error);
            }
        }

        function showBirthdayModal(birthdayPeople) {
            const birthdayList = document.getElementById('birthdayList');
            birthdayList.innerHTML = '';

            birthdayPeople.forEach(person => {
                const initials = person.name.split(' ').map(n => n[0]).join('').toUpperCase();
                const birthdayCard = `
                    <div class="bg-gradient-to-r from-pink-100 to-purple-100 rounded-lg p-6 shadow-md">
                        <div class="flex items-start gap-4">
                            <div class="w-16 h-16 rounded-full bg-gradient-to-r from-pink-500 to-purple-600 flex items-center justify-center text-white text-xl font-bold flex-shrink-0">
                                ${initials}
                            </div>
                            <div class="flex-1">
                                <h3 class="text-2xl font-bold text-gray-800">${person.name}</h3>
                                <p class="text-gray-600">${person.role}${person.status ? ' â€¢ ' + person.status : ''}</p>
                                <p class="text-gray-700 mt-2">ðŸŽ‚ Wishing you a wonderful birthday filled with joy and happiness!</p>

                                <!-- Comments Section -->
                                <div class="mt-4">
                                    <h4 class="font-semibold text-gray-700 mb-2">Birthday Wishes:</h4>
                                    <div id="comments-${person.id}" class="space-y-2 mb-3 max-h-40 overflow-y-auto">
                                        <!-- Comments will be loaded here -->
                                    </div>
                                    <div class="flex gap-2">
                                        <input
                                            type="text"
                                            id="comment-input-${person.id}"
                                            placeholder="Write a birthday wish..."
                                            class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent"
                                            onkeypress="if(event.key === 'Enter') postBirthdayComment('${person.id}')"
                                        />
                                        <button
                                            onclick="postBirthdayComment('${person.id}')"
                                            class="bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 text-white px-4 py-2 rounded-lg transition"
                                        >
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                birthdayList.innerHTML += birthdayCard;

                // Load existing comments for this person
                loadBirthdayComments(person.id);
            });

            document.getElementById('birthdayModal').classList.remove('hidden');
        }

        async function loadBirthdayComments(employeeId) {
            try {
                const today = new Date().toISOString().split('T')[0];
                const commentsKey = `birthday_comments_${employeeId}_${today}`;

                // Load comments from localStorage
                const storedComments = localStorage.getItem(commentsKey);
                const comments = storedComments ? JSON.parse(storedComments) : [];

                const commentsContainer = document.getElementById(`comments-${employeeId}`);
                if (comments.length === 0) {
                    commentsContainer.innerHTML = '<p class="text-gray-500 text-sm italic">No wishes yet. Be the first to wish!</p>';
                } else {
                    commentsContainer.innerHTML = comments.map(comment => `
                        <div class="bg-white p-3 rounded-lg shadow-sm">
                            <div class="flex items-start gap-2">
                                <div class="w-8 h-8 rounded-full bg-gradient-to-r from-red-500 to-pink-500 flex items-center justify-center text-white text-xs font-bold flex-shrink-0">
                                    ${comment.authorInitials}
                                </div>
                                <div class="flex-1">
                                    <p class="font-semibold text-sm text-gray-800">${comment.authorName}</p>
                                    <p class="text-gray-700 text-sm">${comment.text}</p>
                                    <p class="text-xs text-gray-500 mt-1">${comment.timestamp}</p>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading birthday comments:', error);
            }
        }

        async function postBirthdayComment(employeeId) {
            const input = document.getElementById(`comment-input-${employeeId}`);
            const commentText = input.value.trim();

            if (!commentText) {
                return;
            }

            try {
                const today = new Date().toISOString().split('T')[0];
                const commentsKey = `birthday_comments_${employeeId}_${today}`;

                // Load existing comments
                const storedComments = localStorage.getItem(commentsKey);
                const comments = storedComments ? JSON.parse(storedComments) : [];

                // Add new comment
                const newComment = {
                    authorName: currentUser.name,
                    authorInitials: currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase(),
                    text: commentText,
                    timestamp: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
                };

                comments.push(newComment);

                // Save to localStorage
                localStorage.setItem(commentsKey, JSON.stringify(comments));

                // Clear input and reload comments
                input.value = '';
                await loadBirthdayComments(employeeId);
            } catch (error) {
                console.error('Error posting birthday comment:', error);
                alert('Failed to post comment. Please try again.');
            }
        }

        // ========================================
        // LOAD TODAY'S STATUS
        // ========================================
        async function loadTodayStatus() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const filterFormula = `AND(FIND('${currentUser.id}', ARRAYJOIN({Employee})), {Date} = '${today}')`;

                // Use Worker API
                const data = await getAttendance(filterFormula);

                if (data.records.length > 0) {
                    const record = data.records[0];
                    const checkIn = record.fields['Check-in Time'];
                    const checkOut = record.fields['Check-out Time'];

                    if (checkOut) {
                        document.getElementById('todayStatus').textContent = 'Checked Out';
                        document.getElementById('checkInTime').textContent = `${checkIn} - ${checkOut}`;
                        document.getElementById('quickCheckInBtn').classList.add('hidden');
                    } else if (checkIn) {
                        document.getElementById('todayStatus').textContent = 'Checked In';
                        document.getElementById('checkInTime').textContent = `Since ${checkIn}`;
                        document.getElementById('quickCheckInBtn').classList.add('hidden');
                        document.getElementById('quickCheckOutBtn').classList.remove('hidden');
                    }
                } else {
                    document.getElementById('todayStatus').textContent = 'Not Checked In';
                    document.getElementById('checkInTime').textContent = 'No record today';
                }
            } catch (error) {
                console.error('Error loading today status:', error);
                document.getElementById('todayStatus').textContent = '--';
            }
        }

        // ========================================
        // LOAD MONTHLY HOURS
        // ========================================
        async function loadMonthlyHours() {
            try {
                const now = new Date();
                const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
                const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];

                const filterFormula = `AND(FIND('${currentUser.id}', ARRAYJOIN({Employee})), IS_AFTER({Date}, '${firstDay}'), IS_BEFORE({Date}, '${lastDay}'))`;

                // Use Worker API
                const data = await getAttendance(filterFormula);

                let totalHours = 0;
                data.records.forEach(record => {
                    const hours = parseFloat(record.fields['Hours Worked']) || 0;
                    totalHours += hours;
                });

                document.getElementById('monthlyHours').textContent = totalHours.toFixed(1);
            } catch (error) {
                console.error('Error loading monthly hours:', error);
                document.getElementById('monthlyHours').textContent = '0';
            }
        }

        // ========================================
        // LOAD LEAVE BALANCE
        // ========================================
        async function loadLeaveBalance() {
            try {
                // Use Worker API
                const data = await getEmployee(currentUser.id);
                const balance = data.fields['Annual Leave Balance'] !== undefined ? data.fields['Annual Leave Balance'] : 20;
                document.getElementById('leaveBalance').textContent = balance;
            } catch (error) {
                console.error('Error loading leave balance:', error);
                document.getElementById('leaveBalance').textContent = '--';
            }
        }

        // ========================================
        // LOAD PENDING REQUESTS
        // ========================================
        async function loadPendingRequests() {
            try {
                const filterFormula = `AND(FIND('${currentUser.id}', ARRAYJOIN({Employee})), {Status} = 'Pending')`;

                // Use Worker API
                const data = await getLeaveRequests(filterFormula);
                document.getElementById('pendingRequests').textContent = data.records.length;
            } catch (error) {
                console.error('Error loading pending requests:', error);
                document.getElementById('pendingRequests').textContent = '0';
            }
        }

        // ========================================
        // LOAD ATTENDANCE DATA
        // ========================================
        async function loadAttendanceData() {
            try {
                const filterFormula = `FIND('${currentUser.id}', ARRAYJOIN({Employee}))`;

                // Use Worker API (Note: sort and maxRecords not supported in filter, will filter client-side)
                const data = await getAttendance(filterFormula);
                allAttendanceRecords = data.records;

                renderAttendanceChart(allAttendanceRecords);
            } catch (error) {
                console.error('Error loading attendance data:', error);
            }
        }

        // ========================================
        // RENDER ATTENDANCE CHART
        // ========================================
        function renderAttendanceChart(records) {
            const ctx = document.getElementById('attendanceChart').getContext('2d');

            // Process data - group by week
            const weeklyData = {};
            records.forEach(record => {
                const date = new Date(record.fields['Date']);
                const weekStart = getWeekStart(date);
                const weekLabel = weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                if (!weeklyData[weekLabel]) {
                    weeklyData[weekLabel] = 0;
                }
                weeklyData[weekLabel] += parseFloat(record.fields['Hours Worked']) || 0;
            });

            // Get last 8 weeks
            const labels = Object.keys(weeklyData).reverse().slice(0, 8).reverse();
            const data = labels.map(label => weeklyData[label].toFixed(1));

            if (attendanceChart) {
                attendanceChart.destroy();
            }

            attendanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Hours Worked',
                        data: data,
                        backgroundColor: 'rgba(220, 38, 38, 0.7)',
                        borderColor: 'rgba(220, 38, 38, 1)',
                        borderWidth: 1,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y} hours`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + 'h';
                                }
                            }
                        }
                    }
                }
            });
        }

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day;
            return new Date(d.setDate(diff));
        }

        // ========================================
        // LOAD ANNOUNCEMENTS
        // ========================================
        async function loadAnnouncements() {
            try {
                // Use Worker API (will sort and limit client-side)
                const data = await getAnnouncements();
                const container = document.getElementById('announcementsList');

                if (data.records.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-inbox text-3xl mb-2"></i>
                            <p>No announcements</p>
                        </div>
                    `;
                    return;
                }

                // Sort by date descending and take first 3
                const sortedRecords = data.records
                    .sort((a, b) => new Date(b.fields['Date'] || 0) - new Date(a.fields['Date'] || 0))
                    .slice(0, 3);

                container.innerHTML = sortedRecords.map(record => {
                    const title = record.fields['Title'] || 'Untitled';
                    const message = record.fields['Message'] || '';
                    const date = record.fields['Date'] ? new Date(record.fields['Date']).toLocaleDateString() : '';
                    const priority = record.fields['Priority'] || 'Medium';

                    const priorityColors = {
                        'High': 'bg-red-100 text-red-800',
                        'Medium': 'bg-yellow-100 text-yellow-800',
                        'Low': 'bg-blue-100 text-blue-800'
                    };

                    const borderColors = {
                        'High': 'border-red-500',
                        'Medium': 'border-yellow-500',
                        'Low': 'border-blue-500'
                    };

                    return `
                        <div class="border-l-4 ${borderColors[priority]} bg-gray-50 p-4 rounded-r-lg">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-semibold text-gray-800">${title}</h4>
                                <span class="px-2 py-1 text-xs font-medium rounded-full ${priorityColors[priority]}">${priority} Priority</span>
                            </div>
                            <p class="text-sm text-gray-600 mb-2">${message.substring(0, 100)}${message.length > 100 ? '...' : ''}</p>
                            <p class="text-xs text-gray-500"><i class="fas fa-calendar mr-1"></i>${date}</p>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading announcements:', error);
                document.getElementById('announcementsList').innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <p>Failed to load announcements</p>
                    </div>
                `;
            }
        }

        // ========================================
        // LOAD RECENT ACTIVITY
        // ========================================
        async function loadRecentActivity() {
            try {
                const container = document.getElementById('activityFeed');
                const activities = [];

                // Get recent attendance using Worker API
                const filterFormula = `FIND('${currentUser.id}', ARRAYJOIN({Employee}))`;
                const attendanceData = await getAttendance(filterFormula);

                // Sort by date descending and take first 5
                const recentAttendance = attendanceData.records
                    .sort((a, b) => new Date(b.fields['Date']) - new Date(a.fields['Date']))
                    .slice(0, 5);

                recentAttendance.forEach(record => {
                    const date = record.fields['Date'];
                    const checkIn = record.fields['Check-in Time'];
                    const checkOut = record.fields['Check-out Time'];
                    activities.push({
                        type: 'attendance',
                        date: date,
                        icon: 'fa-clock',
                        color: 'text-green-600',
                        text: checkOut ? `Checked in at ${checkIn}, out at ${checkOut}` : `Checked in at ${checkIn}`
                    });
                });

                // Get recent leave requests using Worker API
                const leaveFilterFormula = `FIND('${currentUser.id}', ARRAYJOIN({Employee}))`;
                const leaveData = await getLeaveRequests(leaveFilterFormula);

                // Sort by createdTime descending and take first 3
                const recentLeave = leaveData.records
                    .sort((a, b) => new Date(b.createdTime) - new Date(a.createdTime))
                    .slice(0, 3);

                recentLeave.forEach(record => {
                    const leaveType = record.fields['Leave Type'];
                    const status = record.fields['Status'];
                    const startDate = record.fields['Start Date'];
                    activities.push({
                        type: 'leave',
                        date: startDate,
                        icon: 'fa-calendar-alt',
                        color: status === 'Approved' ? 'text-green-600' : status === 'Rejected' ? 'text-red-600' : 'text-yellow-600',
                        text: `${leaveType} leave request - ${status}`
                    });
                });

                // Sort by date
                activities.sort((a, b) => new Date(b.date) - new Date(a.date));

                if (activities.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-inbox text-3xl mb-2"></i>
                            <p>No recent activity</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = activities.slice(0, 5).map(activity => {
                    const date = new Date(activity.date);
                    const timeAgo = getTimeAgo(date);

                    return `
                        <div class="flex items-start space-x-3 pb-4 border-b border-gray-200 last:border-0 last:pb-0">
                            <div class="bg-gray-100 rounded-full p-2">
                                <i class="fas ${activity.icon} ${activity.color}"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm text-gray-800">${activity.text}</p>
                                <p class="text-xs text-gray-500 mt-1">${timeAgo}</p>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading recent activity:', error);
                document.getElementById('activityFeed').innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <p>Failed to load activity</p>
                    </div>
                `;
            }
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));

            if (days === 0) return 'Today';
            if (days === 1) return 'Yesterday';
            if (days < 7) return `${days} days ago`;
            if (days < 30) return `${Math.floor(days / 7)} weeks ago`;
            return date.toLocaleDateString();
        }

        // ========================================
        // QUICK CHECK IN
        // ========================================
        async function quickCheckIn() {
            if (!confirm('Are you sure you want to check in now?')) return;

            try {
                const today = new Date().toISOString().split('T')[0];
                const datetime = new Date().toISOString();

                // Try to get location
                let locationString = 'Location unavailable';
                try {
                    if (navigator.geolocation) {
                        const position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject, {
                                enableHighAccuracy: true,
                                timeout: 5000,
                                maximumAge: 0
                            });
                        });
                        locationString = `Lat: ${position.coords.latitude.toFixed(6)}, Lng: ${position.coords.longitude.toFixed(6)} (Â±${position.coords.accuracy.toFixed(0)}m)`;
                    }
                } catch (locationError) {
                    // Continue without location
                }

                // Use Worker API to create attendance record
                await createAttendance({
                    'Employee': [currentUser.id],
                    'Date': today,
                    'Check In': datetime,
                    'Check In Location': locationString
                });

                alert('Checked in successfully!');
                window.location.reload();
            } catch (error) {
                console.error('Error checking in:', error);
                alert('Failed to check in. Please try again.');
            }
        }

        // ========================================
        // QUICK CHECK OUT
        // ========================================
        async function quickCheckOut() {
            window.location.href = 'attendance-tracker.html';
        }

        // ========================================
        // FILTER ATTENDANCE CHART
        // ========================================
        function filterAttendanceChart() {
            const filter = document.getElementById('attendanceMonthFilter').value;
            let filteredRecords = allAttendanceRecords;

            if (filter === 'current') {
                const now = new Date();
                const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                filteredRecords = allAttendanceRecords.filter(record => {
                    const date = new Date(record.fields['Date']);
                    return date >= firstDay;
                });
            } else if (filter === 'last') {
                const now = new Date();
                const firstDay = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                const lastDay = new Date(now.getFullYear(), now.getMonth(), 0);
                filteredRecords = allAttendanceRecords.filter(record => {
                    const date = new Date(record.fields['Date']);
                    return date >= firstDay && date <= lastDay;
                });
            }

            renderAttendanceChart(filteredRecords);
        }

        // Initialize dashboard on load
        initializeDashboard();
    </script>
</body>
</html>
