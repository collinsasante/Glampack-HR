<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Glampack HR</title>

    <!-- Favicon -->
    <link rel="shortcut icon" href="assets/images/favicon.ico" />

    <!-- Tailwind CSS (Local) -->
    <link rel="stylesheet" href="assets/css/tailwind.css" />

    <!-- Button Styles -->
    <link rel="stylesheet" href="assets/css/button-styles.css?v=6" />

    <!-- Tailwind CSS CDN (Fallback) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      /* Ensure quick action colors are visible */
      .quick-action-green {
        background-color: #10b981 !important;
        color: white !important;
      }
      .quick-action-green:hover {
        background-color: #059669 !important;
      }
      .quick-action-blue {
        background-color: #3b82f6 !important;
        color: white !important;
      }
      .quick-action-blue:hover {
        background-color: #2563eb !important;
      }
      .quick-action-purple {
        background-color: #a855f7 !important;
        color: white !important;
      }
      .quick-action-purple:hover {
        background-color: #9333ea !important;
      }
      .quick-action-orange {
        background-color: #f97316 !important;
        color: white !important;
      }
      .quick-action-orange:hover {
        background-color: #ea580c !important;
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <!-- Navigation Header -->
    <header class="bg-white shadow-md sticky top-0 z-50">
      <div class="container mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
          <!-- Logo -->
          <div class="flex items-center space-x-3">
            <img src="assets/images/logo_red.png" alt="Logo" class="h-10" />
          </div>

          <!-- Desktop Navigation Menu (hidden on mobile) -->
          <div class="hidden lg:flex items-center space-x-4">
            <a
              href="dashboard.html"
              class="text-red-600 hover:text-red-600 font-semibold"
            >
              <i class="fas fa-chart-line mr-1"></i> Dashboard
            </a>
            <a
              href="attendance-tracker.html"
              class="text-gray-600 hover:text-red-600"
            >
              <i class="fas fa-clock mr-1"></i> Attendance
            </a>
            <a
              href="leave-request.html"
              class="text-gray-600 hover:text-red-600"
            >
              <i class="fas fa-calendar-alt mr-1"></i> Leave
            </a>
            <a
              href="medical-claims.html"
              class="text-gray-600 hover:text-red-600"
            >
              <i class="fas fa-notes-medical mr-1"></i> Medical Claims
            </a>
            <a href="profile.html" class="text-gray-600 hover:text-red-600">
              <i class="fas fa-user mr-1"></i> Profile
            </a>
            <a
              href="announcements.html"
              class="text-gray-600 hover:text-red-600"
            >
              <i class="fas fa-bullhorn mr-1"></i> Announcements
            </a>
            <a href="payroll.html" class="text-gray-600 hover:text-red-600">
              <i class="fas fa-money-bill-wave mr-1"></i> Payroll
            </a>
            <a
              href="admin-dashboard.html"
              id="adminLink"
              class="text-gray-600 hover:text-red-600"
              style="display: none"
            >
              <i class="fas fa-user-shield mr-1"></i> Admin
            </a>
            <button onclick="logout()" class="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all duration-200 font-medium shadow-sm hover:shadow-md"
            >
              <i class="fas fa-sign-out-alt"></i>
              <span>Sign Out</span>
            </button>
          </div>

          <!-- Mobile Menu Button -->
          <button onclick="toggleMobileMenu()" class="lg:hidden text-gray-600 hover:text-red-600 focus:outline-none">
            <i class="fas fa-bars text-2xl"></i>
          </button>
        </div>

        <!-- Mobile Navigation Menu (hidden by default) -->
        <div id="mobileMenu" class="hidden lg:hidden mt-4 pb-2 space-y-2">
          <a href="dashboard.html" class="block px-4 py-3 bg-red-100 text-red-600 font-semibold rounded-lg">
            <i class="fas fa-chart-line mr-2"></i> Dashboard
          </a>
          <a href="attendance-tracker.html" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg">
            <i class="fas fa-clock mr-2"></i> Attendance
          </a>
          <a href="leave-request.html" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg">
            <i class="fas fa-calendar-alt mr-2"></i> Leave
          </a>
          <a href="medical-claims.html" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg">
            <i class="fas fa-notes-medical mr-2"></i> Medical Claims
          </a>
          <a href="profile.html" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg">
            <i class="fas fa-user mr-2"></i> Profile
          </a>
          <a href="announcements.html" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg">
            <i class="fas fa-bullhorn mr-2"></i> Announcements
          </a>
          <a href="payroll.html" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg">
            <i class="fas fa-money-bill-wave mr-2"></i> Payroll
          </a>
          <a href="admin-dashboard.html" id="adminLinkMobile" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg" style="display: none">
            <i class="fas fa-user-shield mr-2"></i> Admin
          </a>
          <button onclick="logout()" class="w-full flex items-center gap-2 px-4 py-3 bg-red-600 text-white hover:bg-red-700 rounded-lg font-medium transition-colors"
          >
            <i class="fas fa-sign-out-alt"></i>
            <span>Sign Out</span>
          </button>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8">
      <!-- Welcome Section -->
      <div class="mb-6 sm:mb-8">
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 break-words">
          Welcome back, <span id="userName">Employee</span>!
        </h1>
        <p class="text-sm sm:text-base text-gray-600 mt-2">Here's what's happening today</p>
      </div>

      <!-- Stats Cards -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-6 sm:mb-8">
        <!-- Today's Status -->
        <div class="bg-white rounded-lg shadow-md p-4 sm:p-6">
          <div class="flex items-center justify-between">
            <div class="flex-1 min-w-0 pr-3">
              <p class="text-gray-500 text-xs sm:text-sm">Today's Status</p>
              <h3
                class="text-xl sm:text-2xl font-bold text-gray-800 mt-1 truncate"
                id="todayStatus"
              >
                --
              </h3>
              <p class="text-gray-600 text-xs sm:text-sm mt-1 truncate" id="checkInTime">--</p>
            </div>
            <div class="bg-green-100 p-2 sm:p-3 rounded-full flex-shrink-0">
              <i class="fas fa-clock text-green-600 text-xl sm:text-2xl"></i>
            </div>
          </div>
        </div>

        <!-- Monthly Hours -->
        <div class="bg-white rounded-lg shadow-md p-4 sm:p-6">
          <div class="flex items-center justify-between">
            <div class="flex-1 min-w-0 pr-3">
              <p class="text-gray-500 text-xs sm:text-sm">Monthly Hours</p>
              <h3
                class="text-xl sm:text-2xl font-bold text-gray-800 mt-1 truncate"
                id="monthlyHours"
              >
                0
              </h3>
              <p class="text-gray-600 text-xs sm:text-sm mt-1">This month</p>
            </div>
            <div class="bg-blue-100 p-2 sm:p-3 rounded-full flex-shrink-0">
              <i class="fas fa-business-time text-blue-600 text-xl sm:text-2xl"></i>
            </div>
          </div>
        </div>

        <!-- Medical Claims -->
        <div
          class="bg-white rounded-lg shadow-md p-4 sm:p-6 cursor-pointer hover:shadow-lg transition-shadow"
          onclick="window.location.href='medical-claims.html'"
        >
          <div class="flex items-center justify-between">
            <div class="flex-1 min-w-0 pr-3">
              <p class="text-gray-500 text-xs sm:text-sm">Medical Claims</p>
              <h3
                class="text-xl sm:text-2xl font-bold text-gray-800 mt-1 truncate"
                id="medicalClaimsCount"
              >
                0
              </h3>
              <p class="text-gray-600 text-xs sm:text-sm mt-1">Pending claims</p>
            </div>
            <div class="bg-teal-100 p-2 sm:p-3 rounded-full flex-shrink-0">
              <i class="fas fa-file-medical text-teal-600 text-xl sm:text-2xl"></i>
            </div>
          </div>
        </div>

        <!-- Pending Requests -->
        <div class="bg-white rounded-lg shadow-md p-4 sm:p-6">
          <div class="flex items-center justify-between">
            <div class="flex-1 min-w-0 pr-3">
              <p class="text-gray-500 text-xs sm:text-sm">Pending Requests</p>
              <h3
                class="text-xl sm:text-2xl font-bold text-gray-800 mt-1 truncate"
                id="pendingRequests"
              >
                0
              </h3>
              <p class="text-gray-600 text-xs sm:text-sm mt-1">Awaiting approval</p>
            </div>
            <div class="bg-purple-100 p-2 sm:p-3 rounded-full flex-shrink-0">
              <i class="fas fa-hourglass-half text-purple-600 text-xl sm:text-2xl"></i>
            </div>
          </div>
        </div>
      </div>
      <!-- Policy Documents -->
      <div class="bg-white rounded-lg shadow-md p-4 sm:p-6 mb-6 sm:mb-8">
        <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-4">
          <i class="fas fa-file-alt mr-2"></i>Policy Documents
        </h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
          <a
            href="#"
            onclick="alert('Staff Medical Policy document will be available soon'); return false;"
            class="flex items-center p-4 bg-gradient-to-r from-blue-50 to-blue-100 hover:from-blue-100 hover:to-blue-200 rounded-lg border border-blue-200 transition-all"
          >
            <div class="bg-blue-500 p-3 rounded-lg mr-4">
              <i class="fas fa-heartbeat text-white text-xl"></i>
            </div>
            <div>
              <p class="font-semibold text-gray-800">Staff Medical Policy</p>
              <p class="text-xs text-gray-600">Healthcare guidelines</p>
            </div>
          </a>
          <a
            href="#"
            onclick="alert('Employee Handbook will be available soon'); return false;"
            class="flex items-center p-4 bg-gradient-to-r from-green-50 to-green-100 hover:from-green-100 hover:to-green-200 rounded-lg border border-green-200 transition-all"
          >
            <div class="bg-green-500 p-3 rounded-lg mr-4">
              <i class="fas fa-book text-white text-xl"></i>
            </div>
            <div>
              <p class="font-semibold text-gray-800">Employee Handbook</p>
              <p class="text-xs text-gray-600">Company policies</p>
            </div>
          </a>
          <a
            href="#"
            onclick="alert('Staff Welfare Guide will be available soon'); return false;"
            class="flex items-center p-4 bg-gradient-to-r from-purple-50 to-purple-100 hover:from-purple-100 hover:to-purple-200 rounded-lg border border-purple-200 transition-all"
          >
            <div class="bg-purple-500 p-3 rounded-lg mr-4">
              <i class="fas fa-hands-helping text-white text-xl"></i>
            </div>
            <div>
              <p class="font-semibold text-gray-800">Staff Welfare Guide</p>
              <p class="text-xs text-gray-600">Benefits & support</p>
            </div>
          </a>
        </div>
      </div>

      <!-- Charts and Announcements Section -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6 mb-6 sm:mb-8">
        <!-- Attendance Chart -->
        <div class="lg:col-span-2 bg-white rounded-lg shadow-md p-4 sm:p-6">
          <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-4">
            <i class="fas fa-chart-bar mr-2"></i>Attendance Overview
          </h3>
          <div class="w-full overflow-x-auto">
            <canvas id="attendanceChart" height="100"></canvas>
          </div>
        </div>

        <!-- Latest Announcements -->
        <div class="bg-white rounded-lg shadow-md p-4 sm:p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-base sm:text-lg font-semibold text-gray-800">
              <i class="fas fa-bullhorn mr-2"></i>Announcements
            </h3>
            <a
              href="announcements.html"
              class="text-red-600 hover:text-red-700 text-xs sm:text-sm whitespace-nowrap"
            >
              View All <i class="fas fa-arrow-right ml-1"></i>
            </a>
          </div>
          <div id="announcementsList" class="space-y-3 max-h-80 overflow-y-auto">
            <div class="text-center text-gray-500 py-8">
              <i class="fas fa-spinner fa-spin text-xl sm:text-2xl"></i>
              <p class="mt-2 text-sm sm:text-base">Loading announcements...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="config-worker.js?v=2"></script>
    <script>
      // Authentication check
      const currentUser = JSON.parse(sessionStorage.getItem("currentUser"));
      if (!currentUser) {
        window.location.href = "packaging-glamour-signin.html";
      }

      // Logout function
      function logout() {
        sessionStorage.removeItem("currentUser");
        window.location.href = "packaging-glamour-signin.html";
      }

      // Chart instance
      let attendanceChart = null;
      let allAttendanceRecords = [];

      // ========================================
      // INITIALIZE DASHBOARD
      // ========================================
      async function initializeDashboard() {
        // Display user name with null check
        const userNameElement = document.getElementById("userName");
        if (userNameElement) {
          userNameElement.textContent = currentUser.name.split(" ")[0];
        }

        // Show admin link if user is admin
        const adminLink = document.getElementById("adminLink");
        if (currentUser.role === "Admin" && adminLink) {
          adminLink.style.display = "inline-block";
        }

        // Load all dashboard data
        await Promise.all([
          loadTodayStatus(),
          loadMonthlyHours(),
          loadPendingRequests(),
          loadMedicalClaimsCount(),
          loadAttendanceData(),
          loadAnnouncements(),
        ]);
      }

      // ========================================
      // LOAD TODAY'S STATUS
      // ========================================
      async function loadTodayStatus() {
        try {
          if (typeof getAttendance === "undefined") {
            throw new Error("getAttendance function not defined");
          }

          const today = new Date().toISOString().split("T")[0];

          // Fetch ALL attendance records (no filter) and filter in JavaScript
          const allData = await getAttendance();

          // Filter for this employee's records in JavaScript
          const myRecords = (allData.records || []).filter((r) => {
            const emp = r.fields.Employee || r.fields.employee || [];
            if (Array.isArray(emp)) {
              return emp.includes(currentUser.id);
            } else if (typeof emp === "string") {
              return emp === currentUser.id;
            }
            return false;
          });

          // Find today's record from my records
          const todayRecord = myRecords.find((r) => {
            const recordDate = r.fields.Date || r.fields.date;
            return recordDate === today;
          });

          if (todayRecord) {
            const record = todayRecord;
            const checkIn = record.fields["checkIn"] || record.fields["Check In"] || record.fields["CheckIn"];
            const checkOut = record.fields["checkOut"] || record.fields["Check Out"] || record.fields["CheckOut"];

            // Helper function to format time from timestamp
            const formatTime = (timestamp) => {
              if (!timestamp) return '';
              if (timestamp.includes('T')) {
                const date = new Date(timestamp);
                return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
              }
              return timestamp;
            };

            if (checkOut) {
              document.getElementById("todayStatus").textContent = "Checked Out";
              document.getElementById("checkInTime").textContent =
                `${formatTime(checkIn)} - ${formatTime(checkOut)}`;
            } else if (checkIn) {
              document.getElementById("todayStatus").textContent = "Checked In";
              document.getElementById("checkInTime").textContent =
                `Since ${formatTime(checkIn)}`;
            } else {
              document.getElementById("todayStatus").textContent =
                "Not Checked In";
              document.getElementById("checkInTime").textContent =
                "No record today";
            }
          } else {
            document.getElementById("todayStatus").textContent =
              "Not Checked In";
            document.getElementById("checkInTime").textContent =
              "No record today";
          }
        } catch (error) {
          document.getElementById("todayStatus").textContent = "--";
          document.getElementById("checkInTime").textContent =
            "Error loading status";
        }
      }

      // ========================================
      // LOAD MONTHLY HOURS
      // ========================================
      async function loadMonthlyHours() {
        try {
          const now = new Date();
          const year = now.getFullYear();
          const month = now.getMonth() + 1;
          const yearMonth = `${year}-${month.toString().padStart(2, "0")}`;

          // Get ALL attendance records and filter in JavaScript
          const allData = await getAttendance();

          // Filter for this employee's records
          const myRecords = (allData.records || []).filter((r) => {
            const emp = r.fields.Employee || r.fields.employee || [];
            if (Array.isArray(emp)) {
              return emp.includes(currentUser.id);
            } else if (typeof emp === "string") {
              return emp === currentUser.id;
            }
            return false;
          });

          let totalHours = 0;

          myRecords.forEach((record) => {
            const recordDate = record.fields["Date"] || record.fields["date"];

            if (recordDate && recordDate.startsWith(yearMonth)) {
              const checkIn = record.fields["checkIn"] || record.fields["Check In"] || record.fields["CheckIn"];
              const checkOut = record.fields["checkOut"] || record.fields["Check Out"] || record.fields["CheckOut"];

              if (checkIn && checkOut) {
                const hours = calculateHoursFromTimestamps(checkIn, checkOut);
                totalHours += hours;
              }
            }
          });

          document.getElementById("monthlyHours").textContent =
            totalHours.toFixed(1);
        } catch (error) {
          document.getElementById("monthlyHours").textContent = "0";
        }
      }

      // ========================================
      // CALCULATE HOURS FROM TIMES
      // ========================================
      function calculateHoursFromTimes(checkIn, checkOut) {
        try {
          const checkInTime = new Date(`2000-01-01T${checkIn}`);
          const checkOutTime = new Date(`2000-01-01T${checkOut}`);
          const diffMs = checkOutTime - checkInTime;
          return diffMs / (1000 * 60 * 60); // Convert to hours
        } catch (error) {
          return 0;
        }
      }

      // ========================================
      // CALCULATE HOURS FROM TIMESTAMPS
      // ========================================
      function calculateHoursFromTimestamps(checkIn, checkOut) {
        try {
          const checkInTime = new Date(checkIn);
          const checkOutTime = new Date(checkOut);
          const diffMs = checkOutTime - checkInTime;
          return diffMs / (1000 * 60 * 60); // Convert to hours
        } catch (error) {

          return 0;
        }
      }

      // ========================================
      // LOAD PENDING REQUESTS
      // ========================================
      async function loadPendingRequests() {
        try {
          // Fetch all leave requests and filter client-side
          const data = await getLeaveRequests(null);

          // Filter for this employee's pending requests
          const pendingRequests = (data.records || []).filter((record) => {
            const employees = record.fields.Employee || [];
            const isPending = record.fields.Status === "Pending";
            return employees.includes(currentUser.id) && isPending;
          });

          document.getElementById("pendingRequests").textContent =
            pendingRequests.length;
        } catch (error) {

          document.getElementById("pendingRequests").textContent = "0";
        }
      }

      // ========================================
      // LOAD MEDICAL CLAIMS COUNT
      // ========================================
      async function loadMedicalClaimsCount() {
        try {
          if (typeof getMedicalClaims === "undefined") {
            throw new Error("getMedicalClaims function not defined");
          }

          const data = await getMedicalClaims();

          // Filter for this employee's pending claims
          const pendingClaims = (data.records || []).filter((record) => {
            const employees = record.fields.Employee || record.fields.employee || [];
            const status = record.fields.Status || record.fields.status || "Pending";
            const isThisEmployee = employees.includes(currentUser.id);
            const isPending = status === "Pending";
            return isThisEmployee && isPending;
          });

          document.getElementById("medicalClaimsCount").textContent =
            pendingClaims.length;
        } catch (error) {
          document.getElementById("medicalClaimsCount").textContent = "0";
        }
      }

      // ========================================
      // LOAD ATTENDANCE DATA
      // ========================================
      async function loadAttendanceData() {
        try {
          const allData = await getAttendance();

          // Filter for this employee's records
          const myRecords = (allData.records || []).filter((r) => {
            const emp = r.fields.Employee || r.fields.employee || [];
            if (Array.isArray(emp)) {
              return emp.includes(currentUser.id);
            } else if (typeof emp === "string") {
              return emp === currentUser.id;
            }
            return false;
          });

          allAttendanceRecords = myRecords;
          renderAttendanceChart(allAttendanceRecords);
        } catch (error) {
          // Silently fail
        }
      }

      // ========================================
      // RENDER ATTENDANCE CHART
      // ========================================
      function renderAttendanceChart(records) {
        const ctx = document.getElementById("attendanceChart");
        if (!ctx) return;

        // Process data - last 7 days
        const last7Days = [];
        const hoursWorked = [];
        const today = new Date();

        for (let i = 6; i >= 0; i--) {
          const date = new Date(today);
          date.setDate(date.getDate() - i);
          const dateStr = date.toISOString().split("T")[0];
          const dayLabel = date.toLocaleDateString("en-US", {
            weekday: "short",
          });

          last7Days.push(dayLabel);

          // Find record for this date
          const record = records.find((r) => r.fields["Date"] === dateStr);

          if (record) {
            // Try multiple possible field name variations (camelCase vs space-separated)
            const checkIn = record.fields["checkIn"] || record.fields["Check In"] || record.fields["CheckIn"];
            const checkOut = record.fields["checkOut"] || record.fields["Check Out"] || record.fields["CheckOut"];

            if (checkIn && checkOut) {
              const hours = calculateHoursFromTimestamps(checkIn, checkOut);
              hoursWorked.push(hours);
            } else {
              hoursWorked.push(0);
            }
          } else {
            hoursWorked.push(0);
          }
        }

        // Destroy existing chart
        if (attendanceChart) {
          attendanceChart.destroy();
        }

        // Create new chart
        attendanceChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: last7Days,
            datasets: [
              {
                label: "Hours Worked",
                data: hoursWorked,
                backgroundColor: "rgba(239, 68, 68, 0.5)",
                borderColor: "rgba(239, 68, 68, 1)",
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "Hours",
                },
              },
            },
            plugins: {
              legend: {
                display: true,
                position: "top",
              },
            },
          },
        });
      }

      // ========================================
      // LOAD ANNOUNCEMENTS
      // ========================================
      async function loadAnnouncements() {
        try {
          const data = await getAnnouncements(null);

          // Sort by date descending and take first 3
          const recentAnnouncements = (data.records || [])
            .sort((a, b) => new Date(b.fields.Date) - new Date(a.fields.Date))
            .slice(0, 3);

          const container = document.getElementById("announcementsList");

          if (recentAnnouncements.length === 0) {
            container.innerHTML = `
              <div class="text-center text-gray-500 py-4">
                <i class="fas fa-inbox text-3xl mb-2"></i>
                <p>No announcements yet</p>
              </div>
            `;
            return;
          }

          container.innerHTML = recentAnnouncements
            .map(
              (announcement) => `
            <div class="border-l-4 ${getAnnouncementColor(
              announcement.fields.Type
            )} bg-gray-50 p-4 rounded">
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <h4 class="font-semibold text-gray-800">${
                    announcement.fields.Title || 'Untitled'
                  }</h4>
                  <p class="text-gray-600 text-sm mt-1">${(announcement.fields.Message || '').substring(
                    0,
                    100
                  )}${(announcement.fields.Message || '').length > 100 ? "..." : ""}</p>
                  <div class="flex items-center gap-3 mt-2 text-xs text-gray-500">
                    <span><i class="fas fa-tag mr-1"></i>${
                      announcement.fields.Type || 'General'
                    }</span>
                    <span><i class="fas fa-calendar mr-1"></i>${announcement.fields.Date ? new Date(
                      announcement.fields.Date
                    ).toLocaleDateString() : 'No date'}</span>
                  </div>
                </div>
              </div>
            </div>
          `
            )
            .join("");
        } catch (error) {

          document.getElementById("announcementsList").innerHTML = `
            <div class="text-center text-red-500 py-4">
              <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
              <p>Failed to load announcements</p>
            </div>
          `;
        }
      }

      // ========================================
      // GET ANNOUNCEMENT COLOR
      // ========================================
      function getAnnouncementColor(type) {
        const colors = {
          Urgent: "border-red-500",
          HR: "border-blue-500",
          General: "border-gray-500",
          Event: "border-green-500",
          Policy: "border-purple-500",
        };
        return colors[type] || "border-gray-500";
      }

      // ========================================
      // AUTO-REFRESH ON ATTENDANCE UPDATE
      // ========================================
      let lastAttendanceCheck =
        localStorage.getItem("attendanceUpdated") || "0";
      let lastMedicalClaimsCheck =
        localStorage.getItem("medicalClaimsUpdated") || "0";

      // Listen for storage changes (works across tabs)
      window.addEventListener("storage", function (e) {
        if (
          e.key === "attendanceUpdated" &&
          e.newValue !== lastAttendanceCheck
        ) {
          lastAttendanceCheck = e.newValue;
          refreshAttendanceData();
        }
        if (
          e.key === "medicalClaimsUpdated" &&
          e.newValue !== lastMedicalClaimsCheck
        ) {
          lastMedicalClaimsCheck = e.newValue;
          refreshMedicalClaimsData();
        }
      });

      // Poll for changes every 3 seconds (works within same tab)
      setInterval(function () {
        const currentValue = localStorage.getItem("attendanceUpdated") || "0";
        if (currentValue !== lastAttendanceCheck) {
          lastAttendanceCheck = currentValue;
          refreshAttendanceData();
        }

        const medicalClaimsValue =
          localStorage.getItem("medicalClaimsUpdated") || "0";
        if (medicalClaimsValue !== lastMedicalClaimsCheck) {
          lastMedicalClaimsCheck = medicalClaimsValue;
          refreshMedicalClaimsData();
        }
      }, 3000);

      // Refresh only attendance-related data
      async function refreshAttendanceData() {
        await Promise.all([
          loadTodayStatus(),
          loadMonthlyHours(),
          loadAttendanceData(),
        ]);
      }

      // Refresh medical claims data
      async function refreshMedicalClaimsData() {
        await loadMedicalClaimsCount();
      }

      // ========================================
      // MOBILE MENU TOGGLE
      // ========================================
      function toggleMobileMenu() {
        const mobileMenu = document.getElementById('mobileMenu');
        if (mobileMenu) {
          mobileMenu.classList.toggle('hidden');
        }
      }

      // ========================================
      // CHECK IF USER IS ADMIN AND SHOW LINK
      // ========================================
      async function checkAndShowAdminLink() {
        try {
          const currentUser = getCurrentUser();
          if (!currentUser || !currentUser.id) return;

          const employee = await getEmployee(currentUser.id);
          if (employee && employee.fields) {
            const role = employee.fields['Role'] || '';
            if (role === 'Admin' || role === 'HR') {
              // Show desktop admin link
              const adminLink = document.getElementById('adminLink');
              if (adminLink) adminLink.style.display = '';

              // Show mobile admin link
              const adminLinkMobile = document.getElementById('adminLinkMobile');
              if (adminLinkMobile) adminLinkMobile.style.display = '';
            }
          }
        } catch (error) {

        }
      }

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", function() {
        initializeDashboard();
        checkAndShowAdminLink();
      });
    </script>
  </body>
</html>
