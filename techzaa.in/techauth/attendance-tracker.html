<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Packaging Glamour HR</title>

    <!-- Favicon -->
    <link rel="shortcut icon" href="assets/images/favicon.ico" />

    <!-- Tailwind CSS (Local) -->
    <link rel="stylesheet" href="assets/css/tailwind.css" />

    <!-- Button Styles -->
    <link rel="stylesheet" href="assets/css/button-styles.css?v=6" />

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Worker API Configuration -->
    <script src="config-worker.js?v=5"></script>

    <!-- Shared Modal System -->
    <script src="shared-modal.js"></script>

    <!-- Authentication Script -->
    <script src="auth.js"></script>

    <style>
      body {
        font-family: "Montserrat", sans-serif;
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <!-- Navigation Header -->
    <header class="bg-white shadow-md sticky top-0 z-50">
      <div class="container mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
          <!-- Logo -->
          <div class="flex items-center space-x-3">
            <img src="assets/images/logo_red.png" alt="Logo" class="h-10" />
          </div>

          <!-- Desktop Navigation Menu (hidden on mobile) -->
          <div class="hidden lg:flex items-center space-x-4">
            <a href="dashboard.html" class="text-gray-600 hover:text-red-600">
              <i class="fas fa-chart-line mr-1"></i> Dashboard
            </a>
            <a
              href="attendance-tracker.html"
              class="text-red-600 font-semibold"
            >
              <i class="fas fa-clock mr-1"></i> Attendance
            </a>
            <a
              href="leave-request.html"
              class="text-gray-600 hover:text-red-600"
            >
              <i class="fas fa-calendar-alt mr-1"></i> Leave
            </a>
            <a
              href="medical-claims.html"
              class="text-gray-600 hover:text-red-600"
            >
              <i class="fas fa-notes-medical mr-1"></i> Medical Claims
            </a>
            <a href="profile.html" class="text-gray-600 hover:text-red-600">
              <i class="fas fa-user mr-1"></i> Profile
            </a>
            <a
              href="announcements.html"
              class="text-gray-600 hover:text-red-600"
            >
              <i class="fas fa-bullhorn mr-1"></i> Announcements
            </a>
            <a href="payroll.html" class="text-gray-600 hover:text-red-600">
              <i class="fas fa-money-bill-wave mr-1"></i> Payroll
            </a>
            <a
              href="admin-dashboard.html"
              id="adminLink"
              class="text-gray-600 hover:text-red-600"
              style="display: none"
            >
              <i class="fas fa-user-shield mr-1"></i> Admin
            </a>
            <button onclick="logout()" class="text-gray-600 hover:text-red-600">
              <i class="fas fa-sign-out-alt mr-1"></i> Logout
            </button>
          </div>

          <!-- Mobile Menu Button -->
          <button onclick="toggleMobileMenu()" class="lg:hidden text-gray-600 hover:text-red-600 focus:outline-none">
            <i class="fas fa-bars text-2xl"></i>
          </button>
        </div>

        <!-- Mobile Navigation Menu (hidden by default) -->
        <div id="mobileMenu" class="hidden lg:hidden mt-4 pb-2 space-y-2">
          <a href="dashboard.html" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg">
            <i class="fas fa-chart-line mr-2"></i> Dashboard
          </a>
          <a href="attendance-tracker.html" class="block px-4 py-3 bg-red-100 text-red-600 font-semibold rounded-lg">
            <i class="fas fa-clock mr-2"></i> Attendance
          </a>
          <a href="leave-request.html" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg">
            <i class="fas fa-calendar-alt mr-2"></i> Leave
          </a>
          <a href="medical-claims.html" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg">
            <i class="fas fa-notes-medical mr-2"></i> Medical Claims
          </a>
          <a href="profile.html" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg">
            <i class="fas fa-user mr-2"></i> Profile
          </a>
          <a href="announcements.html" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg">
            <i class="fas fa-bullhorn mr-2"></i> Announcements
          </a>
          <a href="payroll.html" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg">
            <i class="fas fa-money-bill-wave mr-2"></i> Payroll
          </a>
          <a href="admin-dashboard.html" id="adminLinkMobile" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg" style="display: none">
            <i class="fas fa-user-shield mr-2"></i> Admin
          </a>
          <button onclick="logout()" class="w-full text-left px-4 py-3 text-red-600 hover:bg-red-50 rounded-lg">
            <i class="fas fa-sign-out-alt mr-2"></i> Logout
          </button>
        </div>
      </div>
    </header>

    <!-- Late Reason Modal -->
    <div
      id="lateReasonModal"
      class="fixed inset-0 bg-gray-100 bg-opacity-30 hidden items-center justify-center z-50"
    >
      <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="p-6 border-b">
          <h3 class="text-xl font-bold text-gray-800">Late Arrival</h3>
          <p class="text-sm text-gray-600 mt-1">
            You are checking in after 8:30 AM. Please provide a reason.
          </p>
        </div>
        <div class="p-6">
          <form id="lateReasonForm">
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Reason for Late Arrival *</label
              >
              <textarea
                id="lateReasonInput"
                rows="4"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                placeholder="Please explain why you are late..."
              ></textarea>
            </div>
            <div class="flex justify-end space-x-3">
              <button
                type="button"
                onclick="closeLateReasonModal()"
                class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50"
              >
                Cancel
              </button>
              <button
                type="submit"
                class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg"
              >
                Submit & Check In
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Left Column - Check In/Out -->
        <div class="lg:col-span-1">
          <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
            <!-- Header -->
            <div class="bg-red-600 text-white p-6 text-center">
              <i class="fas fa-clock text-5xl mb-3"></i>
              <h2 class="text-2xl font-bold">Attendance</h2>
              <p class="text-red-100 text-sm mt-2" id="currentDateTime"></p>
            </div>

            <!-- Today's Status -->
            <div id="todayStatus" class="p-6 border-b">
              <h3 class="text-lg font-semibold text-gray-800 mb-4">
                Today's Status
              </h3>
              <div id="statusInfo" class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-600">Shift:</span>
                  <span id="todayShift" class="font-semibold">Not set</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">Check In:</span>
                  <span id="todayCheckIn" class="font-semibold">Not yet</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">Check Out:</span>
                  <span id="todayCheckOut" class="font-semibold">Not yet</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">Hours:</span>
                  <span id="todayHours" class="font-semibold">0h 0m</span>
                </div>
              </div>
            </div>

            <!-- Content -->
            <div class="p-6">
              <!-- Status Message -->
              <div
                id="statusMessage"
                class="hidden mb-6 p-4 rounded-lg text-center font-medium"
              ></div>

              <!-- Shift Selection -->
              <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  Select Your Shift *
                </label>
                <select
                  id="shiftSelect"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent text-sm"
                  required
                >
                  <option value="">Choose your shift...</option>
                  <option value="Morning Production (Day)">Morning Production (Day) - 8:00am to 6:00pm</option>
                  <option value="Night Production">Night Production - 8:00pm to 6:00am</option>
                  <option value="Straight Shift">Straight Shift - 8:00am to 5:00pm</option>
                  <option value="Hybrid Morning">Hybrid Morning - 7:00am to 2:00pm</option>
                  <option value="Hybrid Afternoon">Hybrid Afternoon - 2:00pm to 9:00pm</option>
                  <option value="Saturday Shift">Saturday Shift - 9:00am to 4:00pm</option>
                </select>
                <p class="text-xs text-gray-500 mt-2">
                  <i class="fas fa-info-circle mr-1"></i>
                  Select your assigned shift before checking in
                </p>
              </div>

              <!-- Check In Button -->
              <button
                onclick="checkIn()"
                id="checkInBtn"
                class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-6 rounded-lg mb-4 transition duration-200 shadow-lg"
              >
                <i class="fas fa-sign-in-alt mr-2"></i>
                Check In
              </button>

              <!-- Check Out Button -->
              <button
                onclick="checkOut()"
                id="checkOutBtn"
                class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-4 px-6 rounded-lg transition duration-200 shadow-lg"
              >
                <i class="fas fa-sign-out-alt mr-2"></i>
                Check Out
              </button>

              <!-- Instructions -->
              <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                <p class="text-xs text-gray-600 text-center">
                  <i class="fas fa-map-marker-alt mr-1 text-red-600"></i>
                  Location will be recorded with your attendance
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column - Attendance History -->
        <div class="lg:col-span-2">
          <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-2xl font-bold text-gray-800">
                Attendance History
              </h2>
              <div class="flex space-x-2">
                <select
                  id="monthFilter"
                  class="border border-gray-300 rounded-lg px-4 py-2 text-sm"
                >
                  <option value="current">This Month</option>
                  <option value="last">Last Month</option>
                  <option value="all">All Time</option>
                </select>
              </div>
            </div>

            <!-- Attendance Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
              <div
                class="bg-green-50 p-4 rounded-lg border border-green-200 shadow-sm"
              >
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm text-gray-600">Present Days</p>
                    <p
                      id="presentDays"
                      class="text-2xl font-bold text-green-600"
                    >
                      0
                    </p>
                    <p class="text-xs text-gray-500 mt-1">On time arrivals</p>
                  </div>
                  <i
                    class="fas fa-check-circle text-3xl text-green-600 opacity-80"
                  ></i>
                </div>
              </div>
              <div
                class="bg-yellow-50 p-4 rounded-lg border border-yellow-200 shadow-sm"
              >
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm text-gray-600">Late Arrivals</p>
                    <p id="lateDays" class="text-2xl font-bold text-yellow-600">
                      0
                    </p>
                    <p class="text-xs text-gray-500 mt-1">After 8:30 AM</p>
                  </div>
                  <i
                    class="fas fa-clock text-3xl text-yellow-600 opacity-80"
                  ></i>
                </div>
              </div>
              <div
                class="bg-blue-50 p-4 rounded-lg border border-blue-200 shadow-sm"
              >
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm text-gray-600">Avg Hours/Day</p>
                    <p id="avgHours" class="text-2xl font-bold text-blue-600">
                      0h
                    </p>
                    <p class="text-xs text-gray-500 mt-1">Daily average</p>
                  </div>
                  <i
                    class="fas fa-hourglass-half text-3xl text-blue-600 opacity-80"
                  ></i>
                </div>
              </div>
              <div
                class="bg-purple-50 p-4 rounded-lg border border-purple-200 shadow-sm"
              >
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm text-gray-600">Total Hours</p>
                    <p
                      id="totalHours"
                      class="text-2xl font-bold text-purple-600"
                    >
                      0h
                    </p>
                    <p class="text-xs text-gray-500 mt-1" id="totalDaysLabel">
                      This period
                    </p>
                  </div>
                  <i
                    class="fas fa-business-time text-3xl text-purple-600 opacity-80"
                  ></i>
                </div>
              </div>
            </div>

            <!-- Attendance Rate Progress Bar -->
            <div
              class="mb-6 p-4 bg-gradient-to-r from-red-50 to-blue-50 rounded-lg border border-red-200"
            >
              <div class="flex justify-between items-center mb-2">
                <span class="text-sm font-semibold text-gray-700"
                  >Attendance Rate</span
                >
                <span
                  class="text-sm font-bold text-red-700"
                  id="attendanceRateText"
                  >0%</span
                >
              </div>
              <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                <div
                  id="attendanceRateBar"
                  class="bg-gradient-to-r from-red-500 to-blue-600 h-3 rounded-full transition-all duration-500"
                  style="width: 0%"
                ></div>
              </div>
              <p class="text-xs text-gray-600 mt-2">
                <i class="fas fa-info-circle mr-1"></i>
                Based on <span id="workingDays">0</span> working days this month
              </p>
            </div>

            <!-- Loading Spinner -->
            <div id="loadingHistory" class="text-center py-12 hidden">
              <i class="fas fa-spinner fa-spin text-4xl text-red-600"></i>
              <p class="text-gray-600 mt-4">Loading attendance history...</p>
            </div>

            <!-- Empty State -->
            <div id="emptyHistory" class="text-center py-12 hidden">
              <i class="fas fa-calendar-times text-6xl text-gray-300 mb-4"></i>
              <p class="text-gray-500 text-lg">No attendance records found</p>
            </div>

            <!-- Attendance Table -->
            <div id="attendanceTable" class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th
                      class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase"
                    >
                      Date
                    </th>
                    <th
                      class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase"
                    >
                      Shift
                    </th>
                    <th
                      class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase"
                    >
                      Check In
                    </th>
                    <th
                      class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase"
                    >
                      Check Out
                    </th>
                    <th
                      class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase"
                    >
                      Hours
                    </th>
                    <th
                      class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase"
                    >
                      Status
                    </th>
                    <th
                      class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase"
                    >
                      Location
                    </th>
                  </tr>
                </thead>
                <tbody
                  id="attendanceTableBody"
                  class="divide-y divide-gray-200"
                >
                  <!-- Will be populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ========================================
      // AUTHENTICATION CHECK
      // ========================================
      // Redirect to login if not authenticated
      if (!requireAuth()) {
        // Will redirect automatically
      }

      // Get logged-in user
      const currentUser = getCurrentUser();
      const EMPLOYEE_ID = currentUser.id;

      // Store today's record ID with localStorage persistence
      // This ensures check-in state persists across tabs, navigation, and logout
      const STORAGE_KEY = `attendance_session_${EMPLOYEE_ID}_${getTodayDate()}`;

      function getTodayRecordId() {
        return localStorage.getItem(STORAGE_KEY);
      }

      function setTodayRecordId(recordId) {
        if (recordId) {
          localStorage.setItem(STORAGE_KEY, recordId);
        }
      }

      function clearTodayRecordId() {
        localStorage.removeItem(STORAGE_KEY);
      }

      // Initialize with stored value if exists
      let todayRecordId = getTodayRecordId();

      // ========================================
      // AIRTABLE CONFIGURATION FOR ATTENDANCE
      // ========================================
      const ATTENDANCE_CONFIG = {
        apiKey: "YOUR_AIRTABLE_API_KEY",
        baseId: "YOUR_AIRTABLE_BASE_ID",
        tableName: "Attendance",
      };

      // ========================================
      // UPDATE DATE AND TIME
      // ========================================
      function updateDateTime() {
        const now = new Date();
        const options = {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        };
        document.getElementById("currentDateTime").textContent =
          now.toLocaleDateString("en-US", options);
      }

      // Display user info
      function updateUserInfo() {
        const userInfoText = `Welcome, ${currentUser.name}`;
        const navUserInfoElement = document.getElementById("navUserInfo");
        if (navUserInfoElement && currentUser) {
          navUserInfoElement.textContent = userInfoText;
        }
      }

      // Initialize and update every second
      updateUserInfo();
      updateDateTime();
      setInterval(updateDateTime, 1000);

      // Load today's status and history, and set todayRecordId if record exists
      async function initializePage() {
        // Clear attendance cache on page load to ensure fresh data across devices
        if (typeof API_CACHE !== 'undefined') {
          API_CACHE.invalidate('attendance');
        }

        const todayRecord = await findTodayRecord();
        if (todayRecord) {
          todayRecordId = todayRecord.id;
          setTodayRecordId(todayRecord.id);
        }
        loadTodayStatus();
        loadAttendanceHistory();

        // Clean up old localStorage entries (older than today)
        cleanupOldSessions();

        // Refresh attendance status every 10 seconds to sync across devices
        setInterval(async () => {
          // Invalidate cache before each refresh
          if (typeof API_CACHE !== 'undefined') {
            API_CACHE.invalidate('attendance');
          }
          await loadTodayStatus();
        }, 10000); // 10 seconds
      }

      initializePage();

      // Clean up localStorage entries from previous days
      function cleanupOldSessions() {
        const today = getTodayDate();
        const keysToRemove = [];

        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.startsWith(`attendance_session_${EMPLOYEE_ID}_`)) {
            const dateFromKey = key.split("_").pop();
            if (dateFromKey !== today) {
              keysToRemove.push(key);
            }
          }
        }

        keysToRemove.forEach((key) => localStorage.removeItem(key));
      }

      // ========================================
      // SHOW STATUS MESSAGE
      // ========================================
      function showMessage(message, type) {
        const statusDiv = document.getElementById("statusMessage");
        statusDiv.textContent = message;
        statusDiv.className = `mb-6 p-4 rounded-lg text-center font-medium`;

        if (type === "success") {
          statusDiv.classList.add("bg-green-100", "text-green-800");
        } else if (type === "error") {
          statusDiv.classList.add("bg-red-100", "text-red-800");
        } else {
          statusDiv.classList.add("bg-yellow-100", "text-yellow-800");
        }

        statusDiv.classList.remove("hidden");

        // Auto-hide after 5 seconds
        setTimeout(() => {
          statusDiv.classList.add("hidden");
        }, 5000);
      }

      // ========================================
      // GET CURRENT TIME IN HH:MM:SS FORMAT
      // ========================================
      function getCurrentTime() {
        const now = new Date();
        return now.toTimeString().split(" ")[0];
      }

      // ========================================
      // GET CURRENT DATETIME IN ISO FORMAT
      // ========================================
      function getCurrentDateTime() {
        const now = new Date();
        return now.toISOString();
      }

      // ========================================
      // GET TODAY'S DATE IN YYYY-MM-DD FORMAT
      // ========================================
      function getTodayDate() {
        const now = new Date();
        return now.toISOString().split("T")[0];
      }

      // ========================================
      // GET YESTERDAY'S DATE IN YYYY-MM-DD FORMAT
      // ========================================
      function getYesterdayDate() {
        const now = new Date();
        now.setDate(now.getDate() - 1);
        return now.toISOString().split("T")[0];
      }

      // ========================================
      // LOCATION TRACKING SYSTEM
      // ========================================
      // This system uses BOTH GPS and IP-based geolocation in parallel:
      // 1. GPS: High accuracy (5-50m) via device hardware
      // 2. IP: Lower accuracy (~5km) via IP address lookup
      //
      // Both methods race against each other, and whichever returns first
      // is used. This ensures fast response time while maintaining accuracy
      // when possible. If GPS fails or is slow, IP provides a reliable fallback.
      // ========================================

      // ========================================
      // GEOFENCING CONFIGURATION
      // ========================================
      // Office location coordinates (replace with your actual office location)
      const OFFICE_LOCATION = {
        latitude: 5.603717,  // Example: Accra, Ghana coordinates
        longitude: -0.186964,
        name: "Glampack Office"
      };

      // Maximum allowed distance from office in meters (5 meters = 0.005 km)
      const MAX_DISTANCE_METERS = 5;

      // ========================================
      // CALCULATE DISTANCE BETWEEN TWO COORDINATES (Haversine formula)
      // ========================================
      function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3; // Earth's radius in meters
        const φ1 = lat1 * Math.PI / 180;
        const φ2 = lat2 * Math.PI / 180;
        const Δφ = (lat2 - lat1) * Math.PI / 180;
        const Δλ = (lon2 - lon1) * Math.PI / 180;

        const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                  Math.cos(φ1) * Math.cos(φ2) *
                  Math.sin(Δλ/2) * Math.sin(Δλ/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

        const distance = R * c; // Distance in meters
        return distance;
      }

      // ========================================
      // VALIDATE USER IS WITHIN GEOFENCE
      // ========================================
      function isWithinGeofence(userLat, userLon) {
        const distance = calculateDistance(
          userLat,
          userLon,
          OFFICE_LOCATION.latitude,
          OFFICE_LOCATION.longitude
        );

        return {
          isValid: distance <= MAX_DISTANCE_METERS,
          distance: distance,
          maxDistance: MAX_DISTANCE_METERS
        };
      }

      // ========================================
      // GET USER GPS LOCATION WITH HIGH ACCURACY
      // ========================================
      function getGPSLocationHighAccuracy() {
        return new Promise((resolve, reject) => {
          if (!navigator.geolocation) {
            reject(new Error("Geolocation is not supported by your browser"));
            return;
          }

          const startTime = Date.now();

          navigator.geolocation.getCurrentPosition(
            (position) => {
              const elapsed = Date.now() - startTime;
              const location = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                accuracy: position.coords.accuracy,
                timestamp: new Date().toISOString(),
                method: "GPS",
                responseTime: elapsed,
              };
              resolve(location);
            },
            (error) => {
              let errorMessage = "Unable to access GPS";
              if (error.code === error.PERMISSION_DENIED) {
                errorMessage = "GPS permission denied. Please enable location access in your phone settings.";
              } else if (error.code === error.POSITION_UNAVAILABLE) {
                errorMessage = "GPS position unavailable. Please check if location services are enabled.";
              } else if (error.code === error.TIMEOUT) {
                errorMessage = "GPS request timed out. Please try again.";
              }
              reject(new Error(errorMessage));
            },
            {
              enableHighAccuracy: true,  // Request high accuracy
              timeout: 10000,            // 10 second timeout
              maximumAge: 0              // Don't use cached position
            }
          );
        });
      }

      // ========================================
      // GET USER LOCATION VIA GPS
      // ========================================
      function getGPSLocation() {
        return new Promise((resolve, reject) => {
          if (!navigator.geolocation) {
            reject(new Error("Geolocation is not supported by your browser"));
            return;
          }

          const startTime = Date.now();

          navigator.geolocation.getCurrentPosition(
            (position) => {
              const elapsed = Date.now() - startTime;
              const location = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                accuracy: position.coords.accuracy,
                timestamp: new Date().toISOString(),
                method: "GPS",
                responseTime: elapsed,
              };
              resolve(location);
            },
            (error) => {
              let errorMessage = "Unable to access GPS";
              if (error.code === error.PERMISSION_DENIED) {
                errorMessage = "GPS permission denied. Please enable location access in your phone settings.";
              } else if (error.code === error.POSITION_UNAVAILABLE) {
                errorMessage = "GPS position unavailable. Please check if location services are enabled.";
              } else if (error.code === error.TIMEOUT) {
                errorMessage = "GPS request timed out. Please try again.";
              }
              reject(new Error(errorMessage));
            },
            {
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 0,
            }
          );
        });
      }

      // ========================================
      // GET USER LOCATION VIA IP (using Worker proxy)
      // ========================================
      async function getIPBasedLocation() {
        const startTime = Date.now();

        try {
          // Using Worker proxy for IP lookup (avoids CORS issues and CSP restrictions)
          // getIPLocation() is defined in config-worker.js
          const data = await getIPLocation();
          const elapsed = Date.now() - startTime;

          // IP-based location is less accurate (city-level, typically 5-50km radius)
          const location = {
            latitude: data.latitude,
            longitude: data.longitude,
            accuracy: 5000, // Approximate city-level accuracy in meters
            timestamp: new Date().toISOString(),
            method: "IP",
            responseTime: elapsed,
            city: data.city,
            region: data.region,
            country: data.country_name,
            ip: data.ip,
          };

          return location;
        } catch (error) {
          throw new Error(`IP location error: ${error.message}`);
        }
      }

      // ========================================
      // GET USER LOCATION (RACE GPS vs IP)
      // ========================================
      async function getUserLocation() {
        try {
          // Race both methods - whichever returns first wins
          const location = await Promise.race([
            getGPSLocation(),
            getIPBasedLocation(),
          ]);

          return location;
        } catch (error) {
          // If race fails, try IP as ultimate fallback
          // GPS failed, try IP-based location as fallback
          try {
            showMessage("GPS unavailable. Using network-based location instead...", "info");
            const ipLocation = await getIPBasedLocation();
            return ipLocation;
          } catch (ipError) {
            throw new Error(
              "Unable to determine your location. Please enable GPS in your phone settings or check your internet connection."
            );
          }
        }
      }

      // ========================================
      // GET LOCATION NAME FROM COORDINATES
      // ========================================
      async function getLocationName(latitude, longitude) {
        try {
          // Using OpenStreetMap's Nominatim API with highest zoom for precise location
          const response = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=19&addressdetails=1`,
            {
              headers: {
                "User-Agent": "AttendanceTracker/1.0",
              },
            }
          );

          if (!response.ok) {
            throw new Error("Failed to get location name");
          }

          const data = await response.json();
          const address = data.address || {};
          const parts = [];

          // Build precise address starting with most specific details

          // Building/POI name
          if (address.building) parts.push(address.building);
          else if (address.shop) parts.push(address.shop);
          else if (address.amenity) parts.push(address.amenity);
          else if (address.office) parts.push(address.office);

          // House number and street
          if (address.house_number && address.road) {
            parts.push(`${address.house_number} ${address.road}`);
          } else if (address.road) {
            parts.push(address.road);
          } else if (address.pedestrian) {
            parts.push(address.pedestrian);
          }

          // Neighbourhood/Quarter/Suburb
          if (address.quarter) parts.push(address.quarter);
          else if (address.neighbourhood) parts.push(address.neighbourhood);
          else if (address.suburb) parts.push(address.suburb);

          // City/Town/Village
          if (address.city) parts.push(address.city);
          else if (address.town) parts.push(address.town);
          else if (address.village) parts.push(address.village);
          else if (address.municipality) parts.push(address.municipality);

          // Region/State
          if (address.region) parts.push(address.region);
          else if (address.state) parts.push(address.state);
          else if (address.province) parts.push(address.province);

          // Country
          if (address.country) parts.push(address.country);

          // Build final address string
          let locationName = parts.join(", ");

          // If we couldn't build a good address, try display_name (often more detailed)
          if (parts.length < 3 && data.display_name) {
            locationName = data.display_name;
          }

          return (
            locationName ||
            `Lat: ${latitude.toFixed(6)}, Lng: ${longitude.toFixed(6)}`
          );
        } catch (error) {

          // Fallback to coordinates if reverse geocoding fails
          return `Lat: ${latitude.toFixed(6)}, Lng: ${longitude.toFixed(6)}`;
        }
      }

      // ========================================
      // FORMAT LOCATION FOR STORAGE
      // ========================================
      async function formatLocation(location) {
        // If IP-based location, use the city/region data from the API
        if (location.method === "IP") {
          const ipLocation = `${location.city}, ${location.region}, ${location.country}`;
          return `${ipLocation} [IP: ${location.ip}] (±${(location.accuracy / 1000).toFixed(0)}km)`;
        }

        // For GPS, use reverse geocoding
        if (location.method === "GPS") {
          const locationName = await getLocationName(
            location.latitude,
            location.longitude
          );
          return `${locationName} [GPS] (±${location.accuracy.toFixed(0)}m)`;
        }

        // Fallback
        return `Lat: ${location.latitude.toFixed(6)}, Lng: ${location.longitude.toFixed(6)} (±${location.accuracy.toFixed(0)}m)`;
      }

      // ========================================
      // LATE REASON MODAL FUNCTIONS
      // ========================================
      function openLateReasonModal(shiftName, shiftConfig) {
        const modal = document.getElementById("lateReasonModal");
        const messageElement = modal.querySelector("p.text-sm");

        // Get the late threshold for the shift
        const lateThreshold = shiftConfig.lateThreshold;

        // Convert 24-hour format to 12-hour format
        const [hours, minutes] = lateThreshold.split(":");
        const hour12 = parseInt(hours) > 12 ? parseInt(hours) - 12 : parseInt(hours);
        const period = parseInt(hours) >= 12 ? "PM" : "AM";
        const formattedTime = `${hour12}:${minutes} ${period}`;

        // Update modal message
        messageElement.textContent = `You are checking in after ${formattedTime}. Please provide a reason.`;

        modal.classList.remove("hidden");
        modal.classList.add("flex");
        document.getElementById("lateReasonInput").value = "";
      }

      function closeLateReasonModal() {
        document.getElementById("lateReasonModal").classList.add("hidden");
        document.getElementById("lateReasonModal").classList.remove("flex");
      }

      // ========================================
      // SHIFT CONFIGURATION
      // ========================================
      const SHIFT_CONFIGS = {
        "Morning Production (Day)": {
          start: "08:00",
          end: "18:00",
          lateThreshold: "08:30"
        },
        "Night Production": {
          start: "20:00",
          end: "06:00", // Next day
          lateThreshold: "20:30"
        },
        "Straight Shift": {
          start: "08:00",
          end: "17:00",
          lateThreshold: "08:30"
        },
        "Hybrid Morning": {
          start: "07:00",
          end: "14:00",
          lateThreshold: "07:30"
        },
        "Hybrid Afternoon": {
          start: "14:00",
          end: "21:00",
          lateThreshold: "14:30"
        },
        "Saturday Shift": {
          start: "09:00",
          end: "16:00",
          lateThreshold: "09:30"
        }
      };

      // ========================================
      // CHECK IN FUNCTION
      // ========================================
      async function checkIn() {
        // Immediately disable button to prevent double-clicks
        const checkInBtn = document.getElementById("checkInBtn");
        if (checkInBtn.disabled) {
          return; // Already processing
        }

        checkInBtn.disabled = true;
        checkInBtn.classList.add("opacity-50", "cursor-not-allowed");

        try {
          // Validate shift selection
          const shiftSelect = document.getElementById("shiftSelect");
          const selectedShift = shiftSelect.value;

          if (!selectedShift) {
            showMessage("Please select your shift before checking in!", "error");
            shiftSelect.focus();
            // Re-enable button if validation fails
            checkInBtn.disabled = false;
            checkInBtn.classList.remove("opacity-50", "cursor-not-allowed");
            return;
          }

          // Check if already checked in today FIRST
          const existingRecord = await findTodayRecord();

          if (existingRecord && existingRecord.fields["Check In"]) {
            // If already checked out, don't allow checking in again
            if (existingRecord.fields["Check Out"]) {
              showMessage(
                "You have already completed your attendance for today (checked in and out). You can only clock in and out once in 24 hours. Please wait until tomorrow.",
                "error"
              );
              return; // Keep button disabled
            }
            showMessage("You have already checked in today! You can only check in once in 24 hours. Please check out when you're done.", "error");
            return; // Keep button disabled
          }

          // Check if late based on shift schedule
          const now = new Date();
          const shiftConfig = SHIFT_CONFIGS[selectedShift];
          const isLate = checkIfLate(now, shiftConfig, selectedShift);

          if (isLate) {
            // Re-enable button temporarily for late modal
            checkInBtn.disabled = false;
            checkInBtn.classList.remove("opacity-50", "cursor-not-allowed");
            // Show modal for late reason
            openLateReasonModal(selectedShift, shiftConfig);
          } else {
            // Proceed with normal check-in
            await performCheckIn(null, selectedShift);
          }
        } catch (error) {
          // Re-enable button if there's an error
          checkInBtn.disabled = false;
          checkInBtn.classList.remove("opacity-50", "cursor-not-allowed");
          showMessage(`Error: ${error.message}`, "error");
        }
      }

      // ========================================
      // CHECK IF LATE FOR SHIFT
      // ========================================
      function checkIfLate(currentTime, shiftConfig, shiftName) {
        const currentHour = currentTime.getHours();
        const currentMinute = currentTime.getMinutes();
        const currentTotalMinutes = currentHour * 60 + currentMinute;

        // For night shift, handle midnight crossover
        if (shiftName === "Night Production") {
          const lateTime = shiftConfig.lateThreshold.split(":");
          const lateMinutes = parseInt(lateTime[0]) * 60 + parseInt(lateTime[1]);

          // Night shift starts at 8pm (20:00)
          // If current time is after 8pm, check against 20:30
          if (currentHour >= 20) {
            return currentTotalMinutes > lateMinutes;
          }
          // If current time is early morning (before 6am), they're checking in for night shift end
          // This is normal, not late
          return false;
        }

        // For all other shifts (day shifts, hybrid morning/afternoon, Saturday)
        const lateTime = shiftConfig.lateThreshold.split(":");
        const lateMinutes = parseInt(lateTime[0]) * 60 + parseInt(lateTime[1]);
        return currentTotalMinutes > lateMinutes;
      }

      // Handle late reason form submission
      document
        .getElementById("lateReasonForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const lateReason = document
            .getElementById("lateReasonInput")
            .value.trim();
          const selectedShift = document.getElementById("shiftSelect").value;
          closeLateReasonModal();
          await performCheckIn(lateReason, selectedShift);
        });

      // ========================================
      // PERFORM CHECK IN (with optional late reason and shift)
      // ========================================
      async function performCheckIn(lateReason, selectedShift) {
        const today = getTodayDate();
        const time = getCurrentTime();
        const datetime = getCurrentDateTime();

        try {
          showMessage("Getting your location...", "info");

          // Try to get GPS location with high accuracy for geofencing
          let gpsLocation;
          let useIPLocation = false;

          try {
            gpsLocation = await getGPSLocationHighAccuracy();
          } catch (gpsError) {
            // GPS failed, try IP-based location as fallback
            showMessage("GPS unavailable. Using network-based location...", "info");
            try {
              const ipLocation = await getIPBasedLocation();
              gpsLocation = {
                latitude: ipLocation.latitude,
                longitude: ipLocation.longitude,
                accuracy: 5000, // IP location is less accurate (approximately 5km)
                method: "IP",
                city: ipLocation.city,
                region: ipLocation.region,
                ip: ipLocation.ip
              };
              useIPLocation = true;
            } catch (ipError) {
              showMessage("Unable to determine your location. Please enable GPS in your phone settings or check your internet connection.", "error");
              return;
            }
          }

          // Calculate distance for logging purposes
          const geofenceCheck = isWithinGeofence(gpsLocation.latitude, gpsLocation.longitude);

          // Get IP location for additional context if GPS was used
          let ipAddress = "Unknown";
          let cityInfo = "";

          if (!useIPLocation) {
            try {
              const ipLocation = await getIPBasedLocation();
              ipAddress = ipLocation.ip;
              cityInfo = `, ${ipLocation.city}, ${ipLocation.region}`;
            } catch (locationError) {
              // IP location is optional when GPS is available
            }
          } else {
            // Already have IP location data
            ipAddress = gpsLocation.ip || "Unknown";
            cityInfo = `, ${gpsLocation.city}, ${gpsLocation.region}`;
          }

          const locationMethod = useIPLocation ? " (Network-based)" : "";
          const locationString = `${gpsLocation.latitude.toFixed(6)}, ${gpsLocation.longitude.toFixed(6)}${cityInfo} (${geofenceCheck.distance.toFixed(1)}m from office)${locationMethod}`;

          const fields = {
            "Check In": datetime,
            "Check In Location": locationString,
            "IP Address": ipAddress,
            "Shift": selectedShift  // Save shift to Airtable
          };

          // Add late reason if applicable
          if (lateReason) {
            fields["Late Reason"] = lateReason;
          }

          const existingRecord = await findTodayRecord();

          if (existingRecord) {
            // Update existing record

            await updateRecord(existingRecord.id, fields);
            todayRecordId = existingRecord.id;
            setTodayRecordId(existingRecord.id);
          } else {
            // Create new record
            const recordData = {
              Date: today,
              Employee: [EMPLOYEE_ID],
              ...fields,
            };

            const newRecord = await createRecord(recordData);

            // Store the record ID for checkout in both memory and localStorage
            todayRecordId = newRecord.id;
            setTodayRecordId(newRecord.id);
          }

          showMessage(`Successfully checked in at ${time}`, "success");

          // Disable shift selector after check-in
          document.getElementById("shiftSelect").disabled = true;
          document.getElementById("shiftSelect").classList.add("opacity-50", "cursor-not-allowed");

          // Signal dashboard to refresh
          localStorage.setItem('attendanceUpdated', Date.now().toString());

          loadTodayStatus(); // Refresh today's status
          loadAttendanceHistory(); // Refresh history
        } catch (error) {

          showMessage(`Error checking in: ${error.message}`, "error");
        }
      }

      // ========================================
      // CHECK OUT FUNCTION
      // ========================================
      async function checkOut() {
        console.log('[CHECKOUT] Starting checkout process...');

        // Immediately disable button to prevent double-clicks
        const checkOutBtn = document.getElementById("checkOutBtn");
        if (checkOutBtn.disabled) {
          console.log('[CHECKOUT] Button already disabled, aborting');
          return; // Already processing
        }

        checkOutBtn.disabled = true;
        checkOutBtn.classList.add("opacity-50", "cursor-not-allowed");

        const time = getCurrentTime();
        const datetime = getCurrentDateTime();
        console.log('[CHECKOUT] Current time:', time, 'DateTime:', datetime);

        try {
          // Check if we have a record ID from check-in (memory or localStorage)
          console.log('[CHECKOUT] todayRecordId from memory:', todayRecordId);

          if (!todayRecordId) {
            todayRecordId = getTodayRecordId();
            console.log('[CHECKOUT] todayRecordId from localStorage:', todayRecordId);
          }

          // If still no record ID, try finding today's record from Airtable
          if (!todayRecordId) {
            console.log('[CHECKOUT] No record ID found, searching Airtable...');
            const existingRecord = await findTodayRecord();
            console.log('[CHECKOUT] Found existing record:', existingRecord);

            if (existingRecord) {
              todayRecordId = existingRecord.id;
              setTodayRecordId(existingRecord.id);
              console.log('[CHECKOUT] Set record ID to:', todayRecordId);
            } else {
              console.error('[CHECKOUT] No record found - user needs to check in first');
              showMessage("Please check in first!", "error");
              // Re-enable button if validation fails
              checkOutBtn.disabled = false;
              checkOutBtn.classList.remove("opacity-50", "cursor-not-allowed");
              return;
            }
          }

          console.log('[CHECKOUT] Fetching current record with ID:', todayRecordId);

          // Verify the record hasn't already been checked out
          const currentRecord = await getAttendanceRecord(todayRecordId);
          console.log('[CHECKOUT] Current record:', currentRecord);
          console.log('[CHECKOUT] Current record Check Out value:', currentRecord?.fields?.["Check Out"]);

          if (currentRecord && currentRecord.fields["Check Out"]) {
            console.warn('[CHECKOUT] Already checked out!');
            showMessage("You have already checked out today. You cannot check out more than once in 24 hours.", "error");
            return; // Keep button disabled
          }

          showMessage("Getting your location...", "info");
          console.log('[CHECKOUT] Getting location...');

          // Try to get GPS location with high accuracy for geofencing
          let gpsLocation;
          let useIPLocation = false;

          try {
            gpsLocation = await getGPSLocationHighAccuracy();
            console.log('[CHECKOUT] GPS location obtained:', gpsLocation);
          } catch (gpsError) {
            console.warn('[CHECKOUT] GPS failed:', gpsError);
            // GPS failed, try IP-based location as fallback
            showMessage("GPS unavailable. Using network-based location...", "info");
            try {
              const ipLocation = await getIPBasedLocation();
              console.log('[CHECKOUT] IP location obtained:', ipLocation);
              gpsLocation = {
                latitude: ipLocation.latitude,
                longitude: ipLocation.longitude,
                accuracy: 5000, // IP location is less accurate (approximately 5km)
                method: "IP",
                city: ipLocation.city,
                region: ipLocation.region,
                ip: ipLocation.ip
              };
              useIPLocation = true;
            } catch (ipError) {
              console.error('[CHECKOUT] IP location also failed:', ipError);
              showMessage("Unable to determine your location. Please enable GPS in your phone settings or check your internet connection.", "error");
              checkOutBtn.disabled = false;
              checkOutBtn.classList.remove("opacity-50", "cursor-not-allowed");
              return;
            }
          }

          // Calculate distance for logging purposes
          const geofenceCheck = isWithinGeofence(gpsLocation.latitude, gpsLocation.longitude);
          console.log('[CHECKOUT] Geofence check:', geofenceCheck);

          // Get IP location for additional context if GPS was used
          let ipAddress = "Unknown";
          let cityInfo = "";

          if (!useIPLocation) {
            try {
              const ipLocation = await getIPBasedLocation();
              ipAddress = ipLocation.ip;
              cityInfo = `, ${ipLocation.city}, ${ipLocation.region}`;
            } catch (locationError) {
              // IP location is optional when GPS is available
            }
          } else {
            // Already have IP location data
            ipAddress = gpsLocation.ip || "Unknown";
            cityInfo = `, ${gpsLocation.city}, ${gpsLocation.region}`;
          }

          const locationMethod = useIPLocation ? " (Network-based)" : "";
          const locationString = `${gpsLocation.latitude.toFixed(6)}, ${gpsLocation.longitude.toFixed(6)}${cityInfo} (${geofenceCheck.distance.toFixed(1)}m from office)${locationMethod}`;
          console.log('[CHECKOUT] Location string:', locationString);

          // Update record with check-out time and location
          const updateFields = {
            "Check Out": datetime,
            "Check Out Location": locationString,
            "IP Address": ipAddress,
          };
          console.log('[CHECKOUT] Updating record ID:', todayRecordId, 'with fields:', updateFields);

          await updateRecord(todayRecordId, updateFields);
          console.log('[CHECKOUT] Record updated successfully');

          // Keep the record ID in localStorage so the page can still find it on reload
          // This ensures buttons stay disabled when user navigates away and comes back
          // The record ID will be automatically cleared at midnight (next day)

          showMessage(`Successfully checked out at ${time}`, "success");
          console.log('[CHECKOUT] Checkout completed successfully at', time);

          // Signal dashboard to refresh
          localStorage.setItem('attendanceUpdated', Date.now().toString());

          // Disable both check in and check out buttons after completing attendance
          document.getElementById("checkOutBtn").disabled = true;
          document
            .getElementById("checkOutBtn")
            .classList.add("opacity-50", "cursor-not-allowed");
          document.getElementById("checkInBtn").disabled = true;
          document
            .getElementById("checkInBtn")
            .classList.add("opacity-50", "cursor-not-allowed");

          console.log('[CHECKOUT] Refreshing status and history...');
          loadTodayStatus(); // Refresh today's status
          loadAttendanceHistory(); // Refresh history with updated record
        } catch (error) {
          console.error('[CHECKOUT] Error during checkout:', error);
          // Re-enable button if there's an error
          const checkOutBtn = document.getElementById("checkOutBtn");
          checkOutBtn.disabled = false;
          checkOutBtn.classList.remove("opacity-50", "cursor-not-allowed");
          showMessage(`Error checking out: ${error.message}`, "error");
        }
      }

      // ========================================
      // FIND TODAY'S ATTENDANCE RECORD
      // ========================================
      async function findTodayRecord() {
        const today = getTodayDate();

        // Invalidate attendance cache before querying to ensure fresh data across devices
        if (typeof API_CACHE !== 'undefined') {
          API_CACHE.invalidate('attendance');
        }

        // Fetch ALL attendance records without filter (filter formula not working reliably)
        // We'll filter on client side instead
        const data = await getAttendance(null);

        // Filter in JavaScript to find today's record for this employee
        const todayRecord = data.records.find((record) => {
          const recordDate = record.fields.Date;
          const employeeIds = record.fields.Employee;

          // Match both date AND employee ID
          return recordDate === today &&
                 employeeIds &&
                 Array.isArray(employeeIds) &&
                 employeeIds.includes(EMPLOYEE_ID);
        });

        // If no record found for today, check if there's a night shift record from yesterday
        // Night shift workers check in yesterday but check out today (next day)
        if (!todayRecord) {
          const yesterday = getYesterdayDate();
          const yesterdayRecord = data.records.find((record) => {
            const recordDate = record.fields.Date;
            const employeeIds = record.fields.Employee;
            const shift = record.fields.Shift;
            const checkOut = record.fields["Check Out"];

            // Match yesterday's date, employee ID, Night Production shift, and no check-out yet
            return recordDate === yesterday &&
                   employeeIds &&
                   Array.isArray(employeeIds) &&
                   employeeIds.includes(EMPLOYEE_ID) &&
                   shift === "Night Production" &&
                   !checkOut;
          });

          if (yesterdayRecord) {
            return yesterdayRecord;
          }
        }

        return todayRecord || null;
      }

      // ========================================
      // CREATE NEW ATTENDANCE RECORD
      // ========================================
      async function createRecord(fields) {
        return await createAttendance(fields);
      }

      // ========================================
      // UPDATE EXISTING ATTENDANCE RECORD
      // ========================================
      async function updateRecord(recordId, fields) {
        return await updateAttendance(recordId, fields);
      }

      // ========================================
      // LOAD TODAY'S STATUS
      // ========================================
      async function loadTodayStatus() {
        try {
          // Invalidate cache before loading to ensure fresh data
          if (typeof API_CACHE !== 'undefined') {
            API_CACHE.invalidate('attendance');
          }

          let todayRecord = null;

          // Try to get record ID from memory or localStorage
          let recordId = todayRecordId || getTodayRecordId();

          // If we have a stored record ID, fetch it directly using Worker API
          if (recordId) {
            try {
              todayRecord = await getAttendanceRecord(recordId);
              // Sync the memory variable
              todayRecordId = recordId;

              // Check if this is yesterday's night shift that's already checked out
              // If so, clear it to allow a new clock-in for today
              if (todayRecord && todayRecord.fields) {
                const recordDate = todayRecord.fields.Date;
                const today = getTodayDate();
                const hasCheckOut = todayRecord.fields["Check Out"];

                if (recordDate !== today && hasCheckOut) {
                  // Yesterday's night shift is complete, allow new clock-in today
                  clearTodayRecordId();
                  todayRecordId = null;
                  todayRecord = await findTodayRecord(); // Check if there's an actual today record
                  if (todayRecord) {
                    todayRecordId = todayRecord.id;
                    setTodayRecordId(todayRecord.id);
                  }
                }
              }
            } catch (error) {
              // Record ID might be invalid, clear it and search again
              clearTodayRecordId();
              todayRecordId = null;
              todayRecord = await findTodayRecord();
              if (todayRecord) {
                todayRecordId = todayRecord.id;
                setTodayRecordId(todayRecord.id);
              }
            }
          } else {
            // Fallback to searching
            todayRecord = await findTodayRecord();
            if (todayRecord) {
              todayRecordId = todayRecord.id;
              setTodayRecordId(todayRecord.id);
            }
          }

          if (todayRecord && todayRecord.fields) {
            const checkInRaw = todayRecord.fields["Check In"];
            const checkOutRaw = todayRecord.fields["Check Out"];
            const shiftSelect = document.getElementById("shiftSelect");

            // Get shift from Airtable record (saved during check-in), fallback to dropdown if not saved yet
            const shift = todayRecord.fields["Shift"] || shiftSelect.value || "Not set";

            // Extract time from datetime
            const checkIn = checkInRaw
              ? new Date(checkInRaw).toLocaleTimeString("en-US", {
                  hour12: false,
                })
              : "Not yet";
            const checkOut = checkOutRaw
              ? new Date(checkOutRaw).toLocaleTimeString("en-US", {
                  hour12: false,
                })
              : "Not yet";

            document.getElementById("todayShift").textContent = shift;
            document.getElementById("todayCheckIn").textContent = checkIn;
            document.getElementById("todayCheckOut").textContent = checkOut;

            // Disable shift selector if already checked in
            if (checkIn !== "Not yet") {
              shiftSelect.disabled = true;
              shiftSelect.classList.add("opacity-50", "cursor-not-allowed");
            }

            // Calculate hours
            if (checkIn !== "Not yet" && checkOut !== "Not yet") {
              const hours = calculateHours(checkIn, checkOut);
              document.getElementById("todayHours").textContent = hours;
            } else if (checkIn !== "Not yet") {
              // Show current duration
              const currentTime = getCurrentTime();
              const hours = calculateHours(checkIn, currentTime);
              document.getElementById("todayHours").textContent =
                hours + " (ongoing)";
            } else {
              document.getElementById("todayHours").textContent = "0h 0m";
            }

            // Update button states based on Airtable record
            const checkInBtn = document.getElementById("checkInBtn");
            const checkOutBtn = document.getElementById("checkOutBtn");

            if (checkIn !== "Not yet") {
              // Has checked in - disable check-in button
              checkInBtn.disabled = true;
              checkInBtn.classList.add("opacity-50", "cursor-not-allowed");

              if (checkOut === "Not yet") {
                // Has checked in but not checked out - enable check-out button
                checkOutBtn.disabled = false;
                checkOutBtn.classList.remove("opacity-50", "cursor-not-allowed");
              } else {
                // Has both checked in and out - disable both buttons
                checkOutBtn.disabled = true;
                checkOutBtn.classList.add("opacity-50", "cursor-not-allowed");
              }
            } else {
              // Has not checked in yet - enable check-in, disable check-out
              checkInBtn.disabled = false;
              checkInBtn.classList.remove("opacity-50", "cursor-not-allowed");
              checkOutBtn.disabled = true;
              checkOutBtn.classList.add("opacity-50", "cursor-not-allowed");
            }
          }
        } catch (error) {

        }
      }

      // ========================================
      // CALCULATE HOURS BETWEEN TWO TIMES
      // ========================================
      function calculateHours(startTime, endTime) {
        const [startHours, startMinutes, startSeconds] = startTime
          .split(":")
          .map(Number);
        const [endHours, endMinutes, endSeconds] = endTime
          .split(":")
          .map(Number);

        const startTotal = startHours * 60 + startMinutes + startSeconds / 60;
        const endTotal = endHours * 60 + endMinutes + endSeconds / 60;

        const diffMinutes = endTotal - startTotal;
        const hours = Math.floor(diffMinutes / 60);
        const minutes = Math.floor(diffMinutes % 60);

        return `${hours}h ${minutes}m`;
      }

      // ========================================
      // LOAD ATTENDANCE HISTORY
      // ========================================
      async function loadAttendanceHistory() {
        const loadingDiv = document.getElementById("loadingHistory");
        const emptyDiv = document.getElementById("emptyHistory");
        const tableDiv = document.getElementById("attendanceTable");
        const tableBody = document.getElementById("attendanceTableBody");

        // Show loading
        loadingDiv.classList.remove("hidden");
        emptyDiv.classList.add("hidden");
        tableDiv.classList.add("hidden");

        let filterFormula = ""; // Declare here for error handling scope

        try {
          const filter = document.getElementById("monthFilter").value;

          // Fetch ALL records using Worker API and filter/sort on client side
          const data = await getAttendance();

          // Filter records for this employee on the client side
          let records = data.records.filter((record) => {
            const employeeField = record.fields["Employee"];
            // Check if Employee field exists and contains this employee's ID
            return (
              employeeField &&
              Array.isArray(employeeField) &&
              employeeField.includes(EMPLOYEE_ID)
            );
          });

          // Sort by Date descending (client-side)
          records.sort((a, b) => {
            const dateA = new Date(a.fields["Date"] || 0);
            const dateB = new Date(b.fields["Date"] || 0);
            return dateB - dateA;
          });

          // Filter by date in JavaScript
          if (filter === "current") {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            const monthStr = month.toString().padStart(2, "0");
            const targetMonth = `${year}-${monthStr}`;

            records = records.filter((record) => {
              const recordDate = record.fields.Date || "";
              return recordDate.startsWith(targetMonth);
            });
          } else if (filter === "last") {
            const now = new Date();
            const lastMonth = new Date(
              now.getFullYear(),
              now.getMonth() - 1,
              1
            );
            const year = lastMonth.getFullYear();
            const month = lastMonth.getMonth() + 1;
            const monthStr = month.toString().padStart(2, "0");
            const targetMonth = `${year}-${monthStr}`;

            records = records.filter((record) => {
              const recordDate = record.fields.Date || "";
              return recordDate.startsWith(targetMonth);
            });
          }

          // Hide loading
          loadingDiv.classList.add("hidden");

          if (records.length === 0) {
            emptyDiv.classList.remove("hidden");
            tableDiv.classList.add("hidden");
            return;
          }

          // Show table
          tableDiv.classList.remove("hidden");

          // Calculate stats
          let presentCount = 0;
          let lateCount = 0;
          let totalMinutes = 0;
          let daysWithHours = 0;

          // Clear table
          tableBody.innerHTML = "";

          // Populate table
          records.forEach((record) => {
            const fields = record.fields;
            const date = fields.Date || "";
            const checkInRaw = fields["Check In"];
            const checkOutRaw = fields["Check Out"];
            const checkInLocation = fields["Check In Location"] || "";
            const shift = fields["Shift"] || "-";

            // Extract time from datetime
            const checkIn = checkInRaw
              ? new Date(checkInRaw).toLocaleTimeString("en-US", {
                  hour12: false,
                })
              : "-";
            const checkOut = checkOutRaw
              ? new Date(checkOutRaw).toLocaleTimeString("en-US", {
                  hour12: false,
                })
              : "-";

            let hours = "-";
            let status = "Incomplete";
            let statusClass = "bg-yellow-100 text-yellow-800";

            if (checkIn !== "-" && checkOut !== "-") {
              hours = calculateHours(checkIn, checkOut);
              presentCount++;

              // Calculate total minutes for average
              const [h, m] = hours
                .replace("h", "")
                .replace("m", "")
                .split(" ")
                .map(Number);
              totalMinutes += h * 60 + m;
              daysWithHours++;

              // Check if late based on shift
              const checkInHour = parseInt(checkIn.split(":")[0]);
              const checkInMinute = parseInt(checkIn.split(":")[1]);
              const shiftConfig = SHIFT_CONFIGS[shift];

              let isLate = false;
              if (shiftConfig) {
                const lateTime = shiftConfig.lateThreshold.split(":");
                const lateHour = parseInt(lateTime[0]);
                const lateMinute = parseInt(lateTime[1]);

                isLate = checkInHour > lateHour || (checkInHour === lateHour && checkInMinute > lateMinute);
              } else {
                // Fallback to default 8:30 AM threshold if no shift config
                isLate = checkInHour > 8 || (checkInHour === 8 && checkInMinute > 30);
              }

              if (isLate) {
                status = "Late";
                statusClass = "bg-orange-100 text-orange-800";
                lateCount++;
              } else {
                status = "On Time";
                statusClass = "bg-green-100 text-green-800";
              }
            } else if (checkIn !== "-") {
              status = "Checked In";
              statusClass = "bg-blue-100 text-blue-800";
            }

            // Get short shift name for table display
            let shortShift = shift;
            if (shift === "Morning Production (Day)") shortShift = "Morning";
            else if (shift === "Night Production") shortShift = "Night";
            else if (shift === "Straight Shift") shortShift = "Straight";
            else if (shift === "Hybrid Morning") shortShift = "Hybrid AM";
            else if (shift === "Hybrid Afternoon") shortShift = "Hybrid PM";
            else if (shift === "Saturday Shift") shortShift = "Saturday";
            else if (shift === "-") shortShift = "N/A";

            const row = document.createElement("tr");
            row.className = "hover:bg-gray-50";
            row.innerHTML = `
                        <td class="px-4 py-3 text-sm text-gray-900">${formatDate(date)}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">
                            <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs font-semibold">
                                ${shortShift}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-700">${checkIn}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${checkOut}</td>
                        <td class="px-4 py-3 text-sm font-semibold text-gray-900">${hours}</td>
                        <td class="px-4 py-3">
                            <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusClass}">
                                ${status}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-xs text-gray-600" title="${checkInLocation}">
                            ${checkInLocation ? (checkInLocation.length > 30 ? checkInLocation.substring(0, 30) + "..." : checkInLocation) : "-"}
                        </td>
                    `;
            tableBody.appendChild(row);
          });

          // Update stats
          document.getElementById("presentDays").textContent = presentCount;
          document.getElementById("lateDays").textContent = lateCount;

          if (daysWithHours > 0) {
            const avgMinutes = totalMinutes / daysWithHours;
            const avgHours = Math.floor(avgMinutes / 60);
            const avgMins = Math.floor(avgMinutes % 60);
            document.getElementById("avgHours").textContent =
              `${avgHours}h ${avgMins}m`;

            const totalHours = Math.floor(totalMinutes / 60);
            const totalMins = Math.floor(totalMinutes % 60);
            document.getElementById("totalHours").textContent =
              `${totalHours}h ${totalMins}m`;
          } else {
            document.getElementById("avgHours").textContent = "0h 0m";
            document.getElementById("totalHours").textContent = "0h 0m";
          }

          // Calculate attendance rate
          const now = new Date();
          const year = now.getFullYear();
          const month = now.getMonth();
          const workingDays = getWorkingDaysInMonth(year, month);
          const attendanceRate =
            workingDays > 0
              ? Math.round((presentCount / workingDays) * 100)
              : 0;

          document.getElementById("workingDays").textContent = workingDays;
          document.getElementById("attendanceRateText").textContent =
            `${attendanceRate}%`;
          document.getElementById("attendanceRateBar").style.width =
            `${attendanceRate}%`;

          // Change color based on rate
          const rateBar = document.getElementById("attendanceRateBar");
          if (attendanceRate >= 90) {
            rateBar.className =
              "bg-gradient-to-r from-green-500 to-green-600 h-3 rounded-full transition-all duration-500";
          } else if (attendanceRate >= 75) {
            rateBar.className =
              "bg-gradient-to-r from-red-500 to-blue-600 h-3 rounded-full transition-all duration-500";
          } else if (attendanceRate >= 60) {
            rateBar.className =
              "bg-gradient-to-r from-yellow-500 to-orange-600 h-3 rounded-full transition-all duration-500";
          } else {
            rateBar.className =
              "bg-gradient-to-r from-red-500 to-red-600 h-3 rounded-full transition-all duration-500";
          }
        } catch (error) {

          loadingDiv.classList.add("hidden");
          emptyDiv.classList.remove("hidden");

          // Show error message to user
          emptyDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle text-6xl text-red-300 mb-4"></i>
                    <p class="text-red-500 text-lg font-semibold">Error Loading Attendance</p>
                    <p class="text-gray-500 text-sm mt-2">${error.message}</p>
                    <p class="text-gray-400 text-xs mt-2">Check the browser console for more details</p>
                `;
        }
      }

      // ========================================
      // CALCULATE WORKING DAYS IN MONTH
      // ========================================
      function getWorkingDaysInMonth(year, month) {
        // Fixed to 24 working days per month as per company policy
        return 24;
      }

      // ========================================
      // FORMAT DATE
      // ========================================
      function formatDate(dateString) {
        if (!dateString) return "-";
        const date = new Date(dateString);
        const options = {
          weekday: "short",
          month: "short",
          day: "numeric",
          year: "numeric",
        };
        return date.toLocaleDateString("en-US", options);
      }

      // ========================================
      // MONTH FILTER CHANGE HANDLER
      // ========================================
      document.getElementById("monthFilter").addEventListener("change", () => {
        loadAttendanceHistory();
      });

      // ========================================
      // MOBILE MENU TOGGLE
      // ========================================
      function toggleMobileMenu() {
        const mobileMenu = document.getElementById('mobileMenu');
        if (mobileMenu) {
          mobileMenu.classList.toggle('hidden');
        }
      }

      // ========================================
      // CHECK IF USER IS ADMIN AND SHOW LINK
      // ========================================
      async function checkAndShowAdminLink() {
        try {
          const currentUser = getCurrentUser();
          if (!currentUser || !currentUser.id) return;

          const employee = await getEmployee(currentUser.id);
          if (employee && employee.fields) {
            const role = employee.fields['Role'] || '';
            if (role === 'Admin' || role === 'HR') {
              // Show desktop admin link
              const adminLink = document.getElementById('adminLink');
              if (adminLink) adminLink.style.display = '';

              // Show mobile admin link
              const adminLinkMobile = document.getElementById('adminLinkMobile');
              if (adminLinkMobile) adminLinkMobile.style.display = '';
            }
          }
        } catch (error) {

        }
      }

      // Call on page load
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', checkAndShowAdminLink);
      } else {
        checkAndShowAdminLink();
      }
    </script>
  </body>
</html>
