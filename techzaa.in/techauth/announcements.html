<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Packaging Glamour HR</title>

    <!-- Favicon -->
    <link rel="shortcut icon" href="assets/images/favicon.ico" />

    <!-- Tailwind CSS (Local) -->
    <link rel="stylesheet" href="assets/css/tailwind.css" />

    <!-- Button Styles -->
    <link rel="stylesheet" href="assets/css/button-styles.css?v=6" />

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Worker API Configuration -->
    <script src="config-worker.js?v=3"></script>

    <!-- Authentication Script -->
    <script src="auth.js"></script>

    <style>
      body {
        font-family: "Montserrat", sans-serif;
      }
      .announcement-card {
        transition: all 0.2s ease;
      }
      .announcement-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      }
      .unread {
        border-left: 4px solid #dc2626;
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <!-- Navigation Header -->
    <header class="bg-white shadow-md sticky top-0 z-50">
      <div class="container mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
          <!-- Logo -->
          <div class="flex items-center space-x-3">
            <img src="assets/images/logo_red.png" alt="Logo" class="h-10" />
          </div>

          <!-- Desktop Navigation Menu (hidden on mobile) -->
          <div class="hidden lg:flex items-center space-x-4">
            <a href="dashboard.html" class="text-gray-600 hover:text-red-600">
              <i class="fas fa-chart-line mr-1"></i> Dashboard
            </a>
            <a
              href="attendance-tracker.html"
              class="text-gray-600 hover:text-red-600"
            >
              <i class="fas fa-clock mr-1"></i> Attendance
            </a>
            <a
              href="leave-request.html"
              class="text-gray-600 hover:text-red-600"
            >
              <i class="fas fa-calendar-alt mr-1"></i> Leave
            </a>
            <a
              href="medical-claims.html"
              class="text-gray-600 hover:text-red-600"
            >
              <i class="fas fa-notes-medical mr-1"></i> Medical Claims
            </a>
            <a href="profile.html" class="text-gray-600 hover:text-red-600">
              <i class="fas fa-user mr-1"></i> Profile
            </a>
            <a href="announcements.html" class="text-red-600 font-semibold">
              <i class="fas fa-bullhorn mr-1"></i> Announcements
            </a>
            <a href="payroll.html" class="text-gray-600 hover:text-red-600">
              <i class="fas fa-money-bill-wave mr-1"></i> Payroll
            </a>
            <a
              href="admin-dashboard.html"
              id="adminLink"
              class="text-gray-600 hover:text-red-600"
              style="display: none"
            >
              <i class="fas fa-user-shield mr-1"></i> Admin
            </a>
            <button onclick="logout()" class="text-gray-600 hover:text-red-600">
              <i class="fas fa-sign-out-alt mr-1"></i> Logout
            </button>
          </div>

          <!-- Mobile Menu Button -->
          <button onclick="toggleMobileMenu()" class="lg:hidden text-gray-600 hover:text-red-600 focus:outline-none">
            <i class="fas fa-bars text-2xl"></i>
          </button>
        </div>

        <!-- Mobile Navigation Menu (hidden by default) -->
        <div id="mobileMenu" class="hidden lg:hidden mt-4 pb-2 space-y-2">
          <a href="dashboard.html" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg">
            <i class="fas fa-chart-line mr-2"></i> Dashboard
          </a>
          <a href="attendance-tracker.html" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg">
            <i class="fas fa-clock mr-2"></i> Attendance
          </a>
          <a href="leave-request.html" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg">
            <i class="fas fa-calendar-alt mr-2"></i> Leave
          </a>
          <a href="medical-claims.html" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg">
            <i class="fas fa-notes-medical mr-2"></i> Medical Claims
          </a>
          <a href="profile.html" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg">
            <i class="fas fa-user mr-2"></i> Profile
          </a>
          <a href="announcements.html" class="block px-4 py-3 bg-red-100 text-red-600 font-semibold rounded-lg">
            <i class="fas fa-bullhorn mr-2"></i> Announcements
          </a>
          <a href="payroll.html" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg">
            <i class="fas fa-money-bill-wave mr-2"></i> Payroll
          </a>
          <a href="admin-dashboard.html" id="adminLinkMobile" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg" style="display: none">
            <i class="fas fa-user-shield mr-2"></i> Admin
          </a>
          <button onclick="logout()" class="w-full text-left px-4 py-3 text-red-600 hover:bg-red-50 rounded-lg">
            <i class="fas fa-sign-out-alt mr-2"></i> Logout
          </button>
        </div>
      </div>
    </header>

    <div class="container mx-auto px-4 py-8">
      <!-- Header Section -->
      <div class="flex justify-between items-center mb-6">
        <div>
          <h2 class="text-3xl font-bold text-gray-800">
            Company Announcements
          </h2>
          <p class="text-gray-600 mt-1">
            Stay updated with the latest news and information
          </p>
        </div>
        <button
          id="createAnnouncementBtn"
          onclick="toggleCreateForm()"
          class="hidden bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-200"
        >
          <i class="fas fa-plus mr-2"></i> Create Announcement
        </button>
      </div>

      <!-- Create Announcement Form (Hidden by default) -->
      <div
        id="createForm"
        class="hidden bg-white rounded-lg shadow-lg p-6 mb-6"
      >
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-gray-800">
            Create New Announcement
          </h3>
          <button
            onclick="toggleCreateForm()"
            class="text-gray-500 hover:text-gray-700"
          >
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        <form id="announcementForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Title</label
            >
            <input
              type="text"
              id="announcementTitle"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
              placeholder="Enter announcement title"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Type</label
            >
            <select
              id="announcementType"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
            >
              <option value="General">General</option>
              <option value="HR">HR</option>
              <option value="Urgent">Urgent</option>
              <option value="Event">Event</option>
              <option value="Policy">Policy</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Message</label
            >
            <textarea
              id="announcementMessage"
              required
              rows="5"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
              placeholder="Enter announcement details..."
            ></textarea>
          </div>
          <div class="flex justify-end space-x-3">
            <button
              type="button"
              onclick="toggleCreateForm()"
              class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition duration-200"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition duration-200"
            >
              <i class="fas fa-paper-plane mr-2"></i> Publish
            </button>
          </div>
        </form>
      </div>

      <!-- Filter Section -->
      <div class="bg-white rounded-lg shadow-md p-4 mb-6">
        <div class="flex flex-wrap items-center gap-4">
          <div>
            <label class="text-sm font-medium text-gray-700 mr-2"
              >Filter by Priority:</label
            >
          </div>
          <button
            onclick="filterByType('All')"
            id="filter-All"
            class="filter-btn px-4 py-2 rounded-full text-sm font-medium transition duration-200 bg-red-600 text-white"
          >
            All
          </button>
          <button
            onclick="filterByType('High')"
            id="filter-High"
            class="filter-btn px-4 py-2 rounded-full text-sm font-medium transition duration-200 bg-gray-200 text-gray-700 hover:bg-gray-300"
          >
            <i class="fas fa-exclamation-circle mr-1"></i> High Priority
          </button>
          <button
            onclick="filterByType('Medium')"
            id="filter-Medium"
            class="filter-btn px-4 py-2 rounded-full text-sm font-medium transition duration-200 bg-gray-200 text-gray-700 hover:bg-gray-300"
          >
            <i class="fas fa-info-circle mr-1"></i> Medium Priority
          </button>
          <button
            onclick="filterByType('Low')"
            id="filter-Low"
            class="filter-btn px-4 py-2 rounded-full text-sm font-medium transition duration-200 bg-gray-200 text-gray-700 hover:bg-gray-300"
          >
            <i class="fas fa-flag mr-1"></i> Low Priority
          </button>
          <div class="ml-auto flex items-center space-x-3">
            <label class="flex items-center text-sm font-medium text-gray-700">
              <input
                type="checkbox"
                id="showUnreadOnly"
                onchange="filterAnnouncements()"
                class="mr-2"
              />
              Unread Only
            </label>
          </div>
        </div>
      </div>

      <!-- Announcements List -->
      <div id="announcementsList" class="space-y-4">
        <!-- Loading state -->
        <div class="text-center py-12">
          <i class="fas fa-spinner fa-spin text-4xl text-red-600"></i>
          <p class="text-gray-600 mt-4">Loading announcements...</p>
        </div>
      </div>

      <!-- Empty State -->
      <div
        id="emptyState"
        class="hidden bg-white rounded-lg shadow-md p-12 text-center"
      >
        <i class="fas fa-bullhorn text-6xl text-gray-300 mb-4"></i>
        <h3 class="text-xl font-semibold text-gray-700 mb-2">
          No Announcements Yet
        </h3>
        <p class="text-gray-500">Check back later for updates and news</p>
      </div>

      <!-- Announcement Detail Modal -->
      <div
        id="announcementModal"
        class="fixed inset-0 bg-gray-100 bg-opacity-30 hidden items-center justify-center z-50"
      >
        <div
          class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto"
        >
          <div class="p-6 border-b flex justify-between items-start">
            <h3 id="modalTitle" class="text-2xl font-bold text-gray-800"></h3>
            <button
              onclick="closeAnnouncementModal()"
              class="text-gray-400 hover:text-gray-600"
            >
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          <div class="p-6">
            <div id="modalPriority" class="mb-4"></div>
            <div id="modalMeta" class="text-sm text-gray-500 mb-4"></div>
            <div
              id="modalMessage"
              class="text-gray-700 whitespace-pre-line mb-6"
            ></div>

            <!-- Comments Section -->
            <div class="border-t pt-6">
              <h4 class="text-lg font-bold text-gray-800 mb-4">
                <i class="fas fa-comments mr-2 text-red-600"></i>Comments
              </h4>

              <!-- Comment Form -->
              <div class="mb-6">
                <textarea
                  id="commentInput"
                  rows="3"
                  placeholder="Write a comment..."
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent resize-none"
                ></textarea>
                <div class="flex justify-end mt-2">
                  <button
                    onclick="submitComment()"
                    class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium"
                  >
                    <i class="fas fa-paper-plane mr-2"></i>Post Comment
                  </button>
                </div>
              </div>

              <!-- Comments List -->
              <div id="commentsList" class="space-y-4">
                <!-- Comments will be loaded here -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ========================================
      // AUTHENTICATION CHECK
      // ========================================
      if (!requireAuth()) {
        // Will redirect automatically
      }

      const currentUser = getCurrentUser();

      // Show admin link if user is admin
      const adminLink = document.getElementById("adminLink");
      if (currentUser.role === "Admin" && adminLink) {
        adminLink.style.display = "inline-block";
      }

      // AIRTABLE_CONFIG is already declared in auth.js

      // ========================================
      // GLOBAL STATE
      // ========================================
      let allAnnouncements = [];
      let currentFilter = "All";

      // Load read announcements from localStorage
      function loadReadAnnouncements() {
        const stored = localStorage.getItem(
          `readAnnouncements_${currentUser.id}`
        );
        return stored ? new Set(JSON.parse(stored)) : new Set();
      }

      // Save read announcements to localStorage
      function saveReadAnnouncements() {
        localStorage.setItem(
          `readAnnouncements_${currentUser.id}`,
          JSON.stringify([...readAnnouncements])
        );
      }

      let readAnnouncements = loadReadAnnouncements();

      // ========================================
      // CHECK IF USER IS ADMIN
      // ========================================
      async function checkIfAdmin() {
        try {
          // Check if current user has admin role using Worker API
          const employee = await getEmployee(currentUser.id);

          if (employee && employee.fields) {
            const role = employee.fields["Role"] || "";
            if (role === "Admin" || role === "HR") {
              document
                .getElementById("createAnnouncementBtn")
                .classList.remove("hidden");
            }
          }
        } catch (error) {

        }
      }

      // ========================================
      // TOGGLE CREATE FORM
      // ========================================
      function toggleCreateForm() {
        const form = document.getElementById("createForm");
        form.classList.toggle("hidden");
        if (!form.classList.contains("hidden")) {
          document.getElementById("announcementTitle").focus();
        }
      }

      // ========================================
      // CREATE ANNOUNCEMENT
      // ========================================
      document
        .getElementById("announcementForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const title = document.getElementById("announcementTitle").value;
          const type = document.getElementById("announcementType").value;
          const message = document.getElementById("announcementMessage").value;

          try {
            // Create announcement using Worker API
            await createAnnouncement({
              Title: title,
              Type: type,
              Message: message,
              "Created By": [currentUser.id],
              Date: new Date().toISOString().split("T")[0],
            });

            alert("Announcement published successfully!");
            document.getElementById("announcementForm").reset();
            toggleCreateForm();
            loadAnnouncements();
          } catch (error) {

            alert("Error creating announcement. Please try again.");
          }
        });

      // ========================================
      // LOAD ANNOUNCEMENTS
      // ========================================
      async function loadAnnouncements() {
        try {
          // Load announcements using Worker API
          const announcementsData = await getAnnouncements();
          allAnnouncements = announcementsData.records || [];

          // Sort by Date descending (client-side)
          allAnnouncements.sort((a, b) => {
            const dateA = new Date(a.fields["Date"] || 0);
            const dateB = new Date(b.fields["Date"] || 0);
            return dateB - dateA;
          });

          // Read receipts feature disabled - requires AnnouncementReads table in Airtable
          // Uncomment below if you want to track which announcements users have read
          /*
                const readsUrl = `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/AnnouncementReads?filterByFormula={Employee}='${currentUser.id}'`;
                const readsResponse = await fetch(readsUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (readsResponse.ok) {
                    const readsData = await readsResponse.json();
                    readAnnouncements = new Set(readsData.records.map(r => r.fields['Announcement'][0]));
                }
                */

          displayAnnouncements();
        } catch (error) {

          document.getElementById("announcementsList").innerHTML = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                        <p>Error loading announcements. Please refresh the page.</p>
                    </div>
                `;
        }
      }

      // ========================================
      // FILTER ANNOUNCEMENTS
      // ========================================
      function filterByType(type) {
        currentFilter = type;

        // Save filter preference to localStorage
        localStorage.setItem(`announcementFilter_${currentUser.id}`, type);

        // Update button styles
        document.querySelectorAll(".filter-btn").forEach((btn) => {
          btn.classList.remove("bg-red-600", "text-white");
          btn.classList.add("bg-gray-200", "text-gray-700");
        });

        // Set active button style
        const activeBtn = document.getElementById(`filter-${type}`);
        if (activeBtn) {
          activeBtn.classList.remove("bg-gray-200", "text-gray-700");
          activeBtn.classList.add("bg-red-600", "text-white");
        }

        displayAnnouncements();
      }

      function filterAnnouncements() {
        displayAnnouncements();
      }

      // ========================================
      // DISPLAY ANNOUNCEMENTS
      // ========================================
      function displayAnnouncements() {
        const showUnreadOnly =
          document.getElementById("showUnreadOnly").checked;

        let filtered = allAnnouncements.filter((announcement) => {
          const priority = announcement.fields["Priority"] || "Medium";
          const isRead = readAnnouncements.has(announcement.id);

          const matchesPriority =
            currentFilter === "All" || priority === currentFilter;
          const matchesReadStatus = !showUnreadOnly || !isRead;

          return matchesPriority && matchesReadStatus;
        });

        const listContainer = document.getElementById("announcementsList");
        const emptyState = document.getElementById("emptyState");

        if (filtered.length === 0) {
          listContainer.innerHTML = "";
          emptyState.classList.remove("hidden");
          return;
        }

        emptyState.classList.add("hidden");

        // Sort by date (newest first)
        filtered.sort(
          (a, b) => new Date(b.createdTime) - new Date(a.createdTime)
        );

        listContainer.innerHTML = filtered
          .map((announcement) => {
            const isRead = readAnnouncements.has(announcement.id);
            const priority = announcement.fields["Priority"] || "Medium";
            const title = announcement.fields["Title"] || "Untitled";
            const message = announcement.fields["Message"] || "";
            const author = announcement.fields["Posted By"] || "Admin";
            const dateObj = new Date(announcement.createdTime);

            // Format date
            const formattedDate = dateObj.toLocaleDateString("en-US", {
              year: "numeric",
              month: "long",
              day: "numeric",
            });

            // Priority badge colors
            const priorityColors = {
              High: "bg-red-100 text-red-800",
              Medium: "bg-yellow-100 text-yellow-800",
              Low: "bg-blue-100 text-blue-800",
            };

            const priorityIcons = {
              High: "fa-exclamation-circle",
              Medium: "fa-info-circle",
              Low: "fa-flag",
            };

            const priorityColor =
              priorityColors[priority] || "bg-gray-100 text-gray-800";
            const priorityIcon = priorityIcons[priority] || "fa-info-circle";

            // Create summary (first 150 characters)
            const summary = message.length > 150 ? message.substring(0, 150) + '...' : message;
            const hasMore = message.length > 150;

            return `
                    <div class="announcement-card bg-white rounded-lg shadow-md p-6 ${!isRead ? "unread" : ""} cursor-pointer hover:shadow-lg transition-shadow" data-id="${announcement.id}" onclick="showAnnouncementDetail('${announcement.id}')">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center space-x-2">
                                <span class="px-3 py-1 rounded-full text-xs font-semibold ${priorityColor}">
                                    <i class="fas ${priorityIcon} mr-1"></i> ${priority}
                                </span>
                                ${!isRead ? '<span class="px-3 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800"><i class="fas fa-circle text-xs mr-1"></i> New</span>' : ""}
                            </div>
                            <div class="text-sm text-gray-500">
                                <i class="fas fa-calendar mr-1"></i> ${formattedDate}
                            </div>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">${title}</h3>
                        <p class="text-gray-600 mb-3 whitespace-pre-line">${summary}</p>
                        ${hasMore ? '<p class="text-red-600 text-sm font-semibold mb-3"><i class="fas fa-arrow-right mr-1"></i> Click to read full announcement</p>' : ''}
                        <div class="flex justify-between items-center pt-3 border-t border-gray-200">
                            <div class="text-sm text-gray-500">
                                <i class="fas fa-user mr-1"></i> ${author}
                            </div>
                            ${
                              !isRead
                                ? `
                                <button onclick="event.stopPropagation(); markAsRead('${announcement.id}')" class="text-red-600 hover:text-red-700 text-sm font-medium">
                                    <i class="fas fa-check mr-1"></i> Mark as Read
                                </button>
                            `
                                : '<span class="text-green-600 text-sm"><i class="fas fa-check-circle mr-1"></i> Read</span>'
                            }
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      // ========================================
      // MARK ANNOUNCEMENT AS READ
      // ========================================
      async function markAsRead(announcementId) {
        // Add to read set and persist to localStorage
        readAnnouncements.add(announcementId);
        saveReadAnnouncements();
        displayAnnouncements();

        /* Uncomment if you have AnnouncementReads table in Airtable
            try {
                const url = `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/AnnouncementReads`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fields: {
                            'Announcement': [announcementId],
                            'Employee': [currentUser.id],
                            'Read Date': new Date().toISOString().split('T')[0]
                        }
                    })
                });

                if (response.ok) {
                    readAnnouncements.add(announcementId);
                    displayAnnouncements();
                } else {
                    alert('Failed to mark as read. Please try again.');
                }
            } catch (error) {

                alert('Error marking as read. Please try again.');
            }
            */
      }

      // ========================================
      // SHOW ANNOUNCEMENT DETAIL MODAL
      // ========================================
      // Show announcement detail modal
      function showAnnouncementDetail(announcementId) {
        const announcement = allAnnouncements.find(
          (a) => a.id === announcementId
        );
        if (!announcement) return;

        const priority = announcement.fields["Priority"] || "Medium";
        const title = announcement.fields["Title"] || "Untitled";
        const message = announcement.fields["Message"] || "";
        const author = announcement.fields["Posted By"] || "Admin";
        const dateObj = new Date(announcement.createdTime);
        const formattedDate = dateObj.toLocaleDateString("en-US", {
          year: "numeric",
          month: "long",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });

        const priorityColors = {
          High: "bg-red-100 text-red-800",
          Medium: "bg-yellow-100 text-yellow-800",
          Low: "bg-blue-100 text-blue-800",
        };

        const priorityIcons = {
          High: "fa-exclamation-circle",
          Medium: "fa-info-circle",
          Low: "fa-flag",
        };

        const priorityColor =
          priorityColors[priority] || "bg-gray-100 text-gray-800";
        const priorityIcon = priorityIcons[priority] || "fa-info-circle";

        document.getElementById("modalTitle").textContent = title;
        document.getElementById("modalPriority").innerHTML = `
                <span class="px-3 py-1 rounded-full text-sm font-semibold ${priorityColor}">
                    <i class="fas ${priorityIcon} mr-1"></i> ${priority} Priority
                </span>
            `;
        document.getElementById("modalMeta").innerHTML = `
                <i class="fas fa-user mr-2"></i> Posted by ${author} &nbsp;&nbsp;
                <i class="fas fa-calendar mr-2"></i> ${formattedDate}
            `;
        document.getElementById("modalMessage").textContent = message;

        // Set current announcement for comments
        currentAnnouncementId = announcementId;

        // Mark as read when viewing
        markAsRead(announcementId);

        // Load comments
        loadComments(announcementId);

        // Show modal
        document.getElementById("announcementModal").classList.remove("hidden");
        document.getElementById("announcementModal").classList.add("flex");
      }

      // Close announcement modal
      function closeAnnouncementModal() {
        document.getElementById("announcementModal").classList.add("hidden");
        document.getElementById("announcementModal").classList.remove("flex");
      }

      // ========================================
      // COMMENT FUNCTIONALITY
      // ========================================
      let currentAnnouncementId = null;

      async function submitComment() {
        const commentInput = document.getElementById('commentInput');
        const commentText = commentInput.value.trim();

        if (!commentText) {
          showNotification('Please enter a comment', 'error');
          return;
        }

        if (!currentAnnouncementId) {
          showNotification('No announcement selected', 'error');
          return;
        }

        try {
          const currentUser = getCurrentUser();
          if (!currentUser || !currentUser.id) {
            showNotification('You must be logged in to comment', 'error');
            return;
          }

          // Create comment record
          const commentData = {
            'Announcement': [currentAnnouncementId],
            'Employee': [currentUser.id],
            'Comment': commentText,
            'Date': new Date().toISOString()
          };

          await createAnnouncementComment(commentData);

          // Clear textarea
          commentInput.value = '';

          // Reload comments
          await loadComments(currentAnnouncementId);

          showNotification('Comment posted successfully', 'success');
        } catch (error) {
          console.error('Error posting comment:', error);
          showNotification('Failed to post comment', 'error');
        }
      }

      async function loadComments(announcementId) {
        const commentsList = document.getElementById('commentsList');
        if (!commentsList) return;

        try {
          // Show loading state
          commentsList.innerHTML = '<div class="text-center py-4 text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Loading comments...</div>';

          // Fetch comments for this announcement
          const filterFormula = `{Announcement} = '${announcementId}'`;
          const comments = await getAnnouncementComments(filterFormula);

          if (!comments || comments.length === 0) {
            commentsList.innerHTML = '<div class="text-center py-4 text-gray-500"><i class="fas fa-comment-slash mr-2"></i>No comments yet. Be the first to comment!</div>';
            return;
          }

          // Sort by date (newest first)
          comments.sort((a, b) => {
            const dateA = new Date(a.fields['Date']);
            const dateB = new Date(b.fields['Date']);
            return dateB - dateA;
          });

          // Fetch employee names for all comments
          const employeePromises = comments.map(async (comment) => {
            if (comment.fields['Employee'] && comment.fields['Employee'][0]) {
              try {
                const employee = await getEmployee(comment.fields['Employee'][0]);
                return {
                  id: comment.id,
                  name: employee?.fields?.['Full Name'] || 'Unknown',
                  comment: comment.fields['Comment'],
                  date: comment.fields['Date']
                };
              } catch (error) {
                return {
                  id: comment.id,
                  name: 'Unknown',
                  comment: comment.fields['Comment'],
                  date: comment.fields['Date']
                };
              }
            }
            return null;
          });

          const commentData = await Promise.all(employeePromises);
          const validComments = commentData.filter(c => c !== null);

          // Render comments
          commentsList.innerHTML = validComments.map(comment => {
            const commentDate = new Date(comment.date);
            const timeAgo = formatTimeAgo(commentDate);

            return `
              <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                <div class="flex items-start gap-3">
                  <div class="flex-shrink-0">
                    <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center">
                      <span class="text-red-600 font-bold text-sm">${comment.name.charAt(0)}</span>
                    </div>
                  </div>
                  <div class="flex-1">
                    <div class="flex items-center justify-between mb-1">
                      <h5 class="font-semibold text-gray-900">${comment.name}</h5>
                      <span class="text-xs text-gray-500">${timeAgo}</span>
                    </div>
                    <p class="text-sm text-gray-700 whitespace-pre-wrap">${comment.comment}</p>
                  </div>
                </div>
              </div>
            `;
          }).join('');

        } catch (error) {
          console.error('Error loading comments:', error);
          commentsList.innerHTML = '<div class="text-center py-4 text-red-500"><i class="fas fa-exclamation-triangle mr-2"></i>Failed to load comments</div>';
        }
      }

      function formatTimeAgo(date) {
        const now = new Date();
        const seconds = Math.floor((now - date) / 1000);

        if (seconds < 60) return 'just now';

        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;

        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;

        const days = Math.floor(hours / 24);
        if (days < 7) return `${days} day${days > 1 ? 's' : ''} ago`;

        const weeks = Math.floor(days / 7);
        if (weeks < 4) return `${weeks} week${weeks > 1 ? 's' : ''} ago`;

        const months = Math.floor(days / 30);
        if (months < 12) return `${months} month${months > 1 ? 's' : ''} ago`;

        const years = Math.floor(days / 365);
        return `${years} year${years > 1 ? 's' : ''} ago`;
      }

      // ========================================
      // NOTIFICATION SYSTEM
      // ========================================
      function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg flex items-center gap-3 transform transition-all duration-300 ${
          type === 'success' ? 'bg-green-500 text-white' :
          type === 'error' ? 'bg-red-500 text-white' :
          'bg-blue-500 text-white'
        }`;

        const icon = type === 'success' ? 'fa-check-circle' :
                     type === 'error' ? 'fa-exclamation-circle' :
                     'fa-info-circle';

        notification.innerHTML = `
          <i class="fas ${icon} text-xl"></i>
          <span class="font-medium">${message}</span>
        `;

        document.body.appendChild(notification);

        // Fade in
        setTimeout(() => {
          notification.style.opacity = '1';
        }, 10);

        // Auto remove after 3 seconds
        setTimeout(() => {
          notification.style.opacity = '0';
          setTimeout(() => {
            notification.remove();
          }, 300);
        }, 3000);
      }

      // ========================================
      // INITIALIZE
      // ========================================
      checkIfAdmin();

      // Restore saved filter preference
      const savedFilter = localStorage.getItem(
        `announcementFilter_${currentUser.id}`
      );
      if (savedFilter) {
        currentFilter = savedFilter;
        // Set active button style
        const activeBtn = document.getElementById(`filter-${savedFilter}`);
        if (activeBtn) {
          document.querySelectorAll(".filter-btn").forEach((btn) => {
            btn.classList.remove("bg-red-600", "text-white");
            btn.classList.add("bg-gray-200", "text-gray-700");
          });
          activeBtn.classList.remove("bg-gray-200", "text-gray-700");
          activeBtn.classList.add("bg-red-600", "text-white");
        }
      }

      loadAnnouncements();
      // ========================================
      // MOBILE MENU TOGGLE
      // ========================================
      function toggleMobileMenu() {
        const mobileMenu = document.getElementById('mobileMenu');
        if (mobileMenu) {
          mobileMenu.classList.toggle('hidden');
        }
      }

      // ========================================
      // CHECK IF USER IS ADMIN AND SHOW LINK
      // ========================================
      async function checkAndShowAdminLink() {
        try {
          const currentUser = getCurrentUser();
          if (!currentUser || !currentUser.id) return;

          const employee = await getEmployee(currentUser.id);
          if (employee && employee.fields) {
            const role = employee.fields['Role'] || '';
            if (role === 'Admin' || role === 'HR') {
              // Show desktop admin link
              const adminLink = document.getElementById('adminLink');
              if (adminLink) adminLink.style.display = '';

              // Show mobile admin link
              const adminLinkMobile = document.getElementById('adminLinkMobile');
              if (adminLinkMobile) adminLinkMobile.style.display = '';
            }
          }
        } catch (error) {

        }
      }

      // Call on page load
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', checkAndShowAdminLink);
      } else {
        checkAndShowAdminLink();
      }

    </script>
  </body>
</html>
